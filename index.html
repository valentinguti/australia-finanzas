<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Finanzas · Australia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#FFFFFF;--bg1:#F7F6F3;--bg2:#EFEEEA;--bg3:#E4E3DD;
  --line:#E9E9E7;--line2:#D3D1CB;
  --ink:#37352F;--ink2:#4A4845;--ink3:#9B9A97;--ink4:#C4C3BE;
  --green:#0F7B6C;--green-bg:#EEF8F6;--green-b:#B3DED9;
  --red:#E03E3E;--red-bg:#FBF0F0;--red-b:#F4BEBE;
  --amber:#DFAB01;--amber-bg:#FBF8EE;--amber-b:#F0DFA0;
  --blue:#0B6E99;--blue-bg:#EEF5FA;--blue-b:#B3D4E8;
  --sans:'Inter',system-ui,sans-serif;
  --mono:'JetBrains Mono','Courier New',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{font-size:14px;-webkit-text-size-adjust:100%}
body{background:var(--bg);color:var(--ink);font-family:var(--sans);min-height:100vh;-webkit-font-smoothing:antialiased}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;transition:opacity .3s}
#loading.hide{opacity:0;pointer-events:none}
.loading-logo{font-family:var(--mono);font-size:32px;font-weight:700;color:var(--ink);letter-spacing:-1px}
.loading-sub{font-family:var(--mono);font-size:11px;color:var(--ink3);letter-spacing:2px;text-transform:uppercase}
.loading-bar-wrap{width:160px;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
#loading-bar{height:100%;width:0%;background:var(--ink);border-radius:2px;transition:width .3s ease}
#loading-msg{font-family:var(--mono);font-size:10px;color:var(--ink4);margin-top:4px}

/* AUTH */
#auth,#reconect{display:none;position:fixed;inset:0;background:var(--bg);z-index:8800;align-items:center;justify-content:center;padding:24px}
.auth-box{background:var(--bg);border:1px solid var(--line);border-radius:12px;padding:40px 32px;width:100%;max-width:360px;text-align:center;box-shadow:0 4px 24px rgba(0,0,0,.06)}
.auth-logo{font-family:var(--mono);font-size:28px;font-weight:700;color:var(--ink);margin-bottom:4px}
.auth-title{font-size:16px;font-weight:600;color:var(--ink);margin-bottom:6px}
.auth-sub{font-size:13px;color:var(--ink3);margin-bottom:24px;line-height:1.5}
.auth-gbtn{width:100%;padding:12px;background:var(--ink);color:var(--bg);border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
.auth-skip{width:100%;padding:10px;background:transparent;color:var(--ink3);border:1px solid var(--line);border-radius:8px;font-family:var(--sans);font-size:13px;cursor:pointer}
#auth-err,#reconect-err{font-size:12px;color:var(--red);margin-top:8px;min-height:16px}

/* TOPBAR */
.topbar{background:var(--bg);border-bottom:1px solid var(--line);padding:0 16px;height:46px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200}
.brand{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--ink);letter-spacing:-.3px;display:flex;align-items:center;gap:8px}
.brand-badge{background:var(--ink);color:var(--bg);padding:2px 6px;border-radius:4px;font-size:10px}
.tc-chip{font-family:var(--mono);font-size:10px;color:var(--ink3);display:flex;align-items:center;gap:6px}
.tc-val{color:var(--ink2);font-weight:600}
.sync-lbl{font-family:var(--mono);font-size:10px;color:var(--ink4)}

/* TABNAV */
.tabnav{background:var(--bg);border-bottom:1px solid var(--line);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;position:sticky;top:46px;z-index:199}
.tabnav::-webkit-scrollbar{display:none}
.tab{padding:10px 14px;font-family:var(--sans);font-size:12px;font-weight:500;color:var(--ink3);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.2px;text-transform:uppercase}
.tab.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:600}

/* PAGES */
.pg{display:none;padding-bottom:100px;max-width:680px;margin:0 auto}
.pg.on{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.pg.fade-in{animation:fadeIn .15s ease}

/* SECTION HEADERS */
.sh{padding:24px 16px 8px}
.sh-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.sh-title{font-size:16px;font-weight:700;color:var(--ink);letter-spacing:-.3px}
.sh-sub{font-family:var(--mono);font-size:11px;color:var(--ink3)}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(4,1fr);border:1px solid var(--line);border-radius:8px;margin:12px 16px;overflow:hidden}
.stat{padding:14px 12px;border-right:1px solid var(--line);background:var(--bg)}
.stat:last-child{border-right:none}
.stat-lbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px}
.stat-val{font-family:var(--mono);font-size:16px;font-weight:700;letter-spacing:-.5px;line-height:1}
.stat-sub{font-family:var(--mono);font-size:9px;color:var(--ink3);margin-top:3px}

/* BANDS (caja / status cards) */
.band{padding:16px;border-bottom:1px solid var(--line)}
.band.g{background:var(--green-bg);border-left:3px solid var(--green)}
.band.r{background:var(--red-bg);border-left:3px solid var(--red)}
.band-lbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px}
.band-val{font-family:var(--mono);font-size:24px;font-weight:700;letter-spacing:-.6px;line-height:1;margin-bottom:3px}
.band-sub{font-family:var(--mono);font-size:10px;color:var(--ink3)}
.band-row{display:flex;align-items:flex-end;justify-content:space-between}

/* LEDGER TABLES */
.ledger-wrap{margin:8px 16px;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.ledger{width:100%;border-collapse:collapse;font-size:13px}
.ledger thead th{background:var(--bg1);padding:8px 12px;font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink3);border-bottom:1px solid var(--line);text-align:left}
.ledger thead th.r{text-align:right}
.ledger td{padding:9px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
.ledger tr:last-child td{border-bottom:none}
.ledger tr.subtotal td{background:var(--bg1);font-weight:700}
.ledger tr.total td{background:var(--bg1);border-top:1px solid var(--line2)}
.label-cell{font-size:13px;color:var(--ink2);font-weight:500}
.label-cell.italic{font-style:italic;color:var(--ink3);font-weight:400}
.num{font-family:var(--mono);text-align:right;font-size:12px}
.bold{font-weight:700}
.italic{font-style:italic}
.pos{color:var(--green)}
.neg{color:var(--red)}
.dim{color:var(--ink3)}
.a{color:var(--amber)}

/* INPUTS */
.inp-num{background:transparent;border:none;border-bottom:1px solid var(--line2);padding:4px 0;font-family:var(--mono);font-size:13px;font-weight:600;color:var(--ink);width:100%;outline:none;text-align:right;-webkit-appearance:none}
.inp-num:focus{border-bottom-color:var(--ink)}
.inp-text{background:transparent;border:none;border-bottom:1px solid transparent;padding:4px 0;font-family:var(--sans);font-size:12px;color:var(--ink3);width:100%;outline:none}
.inp-text:focus{border-bottom-color:var(--line2)}
.inp-big{background:var(--bg1);border:1px solid var(--line2);border-radius:6px;padding:10px 12px;font-family:var(--mono);font-size:18px;font-weight:600;color:var(--ink);width:100%;outline:none;-webkit-appearance:none;transition:border-color .15s}
.inp-big:focus{border-color:var(--ink);background:var(--bg)}
.inp-line{background:transparent;border:none;border-bottom:1px solid var(--line2);padding:6px 0;font-family:var(--sans);font-size:14px;color:var(--ink);width:100%;outline:none}
.fg{margin-bottom:16px}
.fg label{display:block;font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px}
.sec-wrap{padding:0 16px 20px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:6px;font-family:var(--sans);font-size:13px;font-weight:500;cursor:pointer;border:none;background:var(--ink);color:var(--bg);transition:opacity .15s}
.btn:hover{opacity:.85}
.btn.r{background:var(--red);color:#fff}
.btn.outline{background:transparent;border:1px solid var(--line2);color:var(--ink)}
.btn.full{width:100%;padding:12px}
.btn.sm{padding:6px 12px;font-size:12px}

/* CHIPS */
.chip{font-family:var(--mono);font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;background:var(--bg2);color:var(--ink3)}
.chip.r{background:var(--red-bg);color:var(--red)}
.chip.g{background:var(--green-bg);color:var(--green)}
.chip.a{background:var(--amber-bg);color:var(--amber)}

/* WEEKS */
.week-grid,.hrs-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:0;border-bottom:1px solid var(--line)}
.week-cell,.hrs-cell{padding:10px 8px;border-right:1px solid var(--line);text-align:center}
.week-cell:last-child,.hrs-cell:last-child{border-right:none}
.week-lbl{font-family:var(--mono);font-size:9px;color:var(--ink3);margin-bottom:6px;letter-spacing:.5px}
.week-inp,.hrs-inp{width:100%;background:transparent;border:none;border-bottom:1px solid var(--line2);padding:4px 0;font-family:var(--mono);font-size:14px;font-weight:600;color:var(--ink);text-align:center;outline:none;-webkit-appearance:none}
.week-inp:focus,.hrs-inp:focus{border-bottom-color:var(--ink)}

/* MONTH STRIP */
.mstrip{display:flex;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--line);background:var(--bg)}
.mstrip::-webkit-scrollbar{display:none}
.mtab{padding:8px 14px;font-family:var(--sans);font-size:12px;font-weight:500;color:var(--ink3);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s;position:relative}
.mtab.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:600}
.mtab.has::after{content:'';position:absolute;top:6px;right:4px;width:5px;height:5px;border-radius:50%;background:var(--green)}

/* LOG ENTRIES */
.cat-section{border:1px solid var(--line);border-radius:8px;margin:8px 16px;overflow:hidden}
.cat-row{display:flex;align-items:center;padding:10px 12px;gap:8px;background:var(--bg)}
.cat-row+.cat-row{border-top:1px solid var(--line)}
.cat-lbl{font-size:13px;color:var(--ink2);font-weight:500;flex:1}
.cat-total{font-family:var(--mono);font-size:13px;font-weight:600;min-width:72px;text-align:right}
.cat-add{background:var(--bg2);border:none;border-radius:5px;padding:4px 10px;font-family:var(--mono);font-size:10px;font-weight:600;color:var(--blue);cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.cat-add:hover{background:var(--blue-bg)}
.log-wrap{border-top:1px solid var(--line);background:var(--bg1)}
.log-entry{display:flex;align-items:center;gap:8px;padding:6px 12px;font-family:var(--mono);font-size:11px;border-bottom:1px solid var(--line)}
.log-entry:last-of-type{border-bottom:none}
@keyframes slideIn{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:translateY(0)}}
.log-entry{animation:slideIn .15s ease}
.log-date{color:var(--ink3);min-width:36px;font-size:10px}
.log-note{color:var(--ink3);flex:1;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.log-amt{color:var(--ink2);font-weight:600;min-width:64px;text-align:right}
.log-del{color:var(--ink4);cursor:pointer;padding:2px 6px;border-radius:3px;font-size:13px;background:none;border:none;transition:all .15s;flex-shrink:0;line-height:1}
.log-del:hover{background:var(--red-bg);color:var(--red)}
.log-more{padding:5px 12px;font-family:var(--mono);font-size:10px;color:var(--blue);cursor:pointer;background:var(--bg1);border-top:1px solid var(--line)}
.log-more:hover{text-decoration:underline}
.add-row{display:none;padding:8px 12px;background:var(--bg2);border-top:1px solid var(--line);gap:8px;align-items:center;flex-wrap:wrap}
.add-row.open{display:flex;animation:slideIn .15s ease}
.add-date{background:var(--bg);border:1px solid var(--line2);border-radius:5px;padding:7px 8px;font-family:var(--mono);font-size:11px;color:var(--ink3);width:110px;outline:none;cursor:pointer}
.add-amt{background:var(--bg);border:1px solid var(--line2);border-radius:5px;padding:7px 10px;font-family:var(--mono);font-size:14px;font-weight:600;color:var(--ink);width:100px;outline:none;-webkit-appearance:none}
.add-amt:focus{border-color:var(--ink)}
.add-note{background:var(--bg);border:1px solid var(--line2);border-radius:5px;padding:7px 10px;font-family:var(--sans);font-size:12px;color:var(--ink);flex:1;min-width:80px;outline:none}
.add-note:focus{border-color:var(--ink)}
.add-ok{background:var(--ink);color:var(--bg);border:none;border-radius:5px;padding:7px 14px;font-family:var(--mono);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap}
.add-cancel{background:none;border:none;color:var(--ink3);font-size:18px;cursor:pointer;padding:4px 6px;line-height:1}
.cat-total-footer{padding:10px 12px;background:var(--bg1);border-top:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:12px;font-weight:700}

/* META */
.meta-bar-wrap{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin:6px 0}
.meta-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.meta-name{font-size:14px;font-weight:600;color:var(--ink)}

/* FOOTER */
.foot{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--line);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:200}
.foot-cell{padding:10px 8px 18px;text-align:center;border-right:1px solid var(--line)}
.foot-cell:last-child{border-right:none}
.foot-lbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink4);margin-bottom:3px}
.foot-val{font-family:var(--mono);font-size:16px;font-weight:700;letter-spacing:-.3px}

/* TOAST */
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--ink);color:var(--bg);font-family:var(--sans);font-size:12px;font-weight:500;padding:8px 16px;border-radius:6px;opacity:0;transition:all .2s;z-index:9000;white-space:nowrap;pointer-events:none}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* MODAL */
#modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:8000;align-items:flex-end;justify-content:center}
#modal-box{background:var(--bg);width:100%;max-width:480px;padding:24px 24px 36px;border-radius:12px 12px 0 0;box-shadow:0 -4px 24px rgba(0,0,0,.08)}
#modal-title{font-size:16px;font-weight:700;color:var(--ink);margin-bottom:8px}
#modal-msg{font-size:13px;color:var(--ink3);margin-bottom:20px;line-height:1.5}
.modal-btns{display:flex;gap:10px}
.modal-btns .btn{flex:1}

/* MISC */
.empty{padding:24px 16px;text-align:center;font-size:13px;color:var(--ink4);font-style:italic}
.row-between{display:flex;align-items:center;justify-content:space-between}
.pay-row{display:flex;align-items:center;padding:10px 12px;gap:8px;border-bottom:1px solid var(--line);font-size:13px}
.pay-date{font-family:var(--mono);font-size:11px;color:var(--ink3);min-width:68px}
.pay-desc{flex:1;color:var(--ink2)}
.pay-amt{font-family:var(--mono);font-size:12px;font-weight:600;color:var(--green)}
.pay-del{background:none;border:none;color:var(--ink4);cursor:pointer;padding:2px 6px;font-size:14px;border-radius:3px}
.pay-del:hover{background:var(--red-bg);color:var(--red)}
.inv-row{display:flex;align-items:center;padding:9px 12px;gap:6px;border-bottom:1px solid var(--line)}
.inv-desc{flex:1;font-size:13px;color:var(--ink2)}
.prog-bar{height:3px;background:var(--line);border-radius:2px;margin-top:3px;overflow:hidden}
.prog-fill{height:100%;background:var(--green);border-radius:2px}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="loading-logo">AU</div>
  <div class="loading-sub">Finanzas · Australia</div>
  <div class="loading-bar-wrap"><div id="loading-bar"></div></div>
  <div id="loading-msg">Iniciando...</div>
</div>

<!-- AUTH -->
<div id="auth" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:8800;align-items:center;justify-content:center;padding:24px">
  <div class="auth-box">
    <div class="auth-logo">AU</div>
    <div class="auth-title">Finanzas · Australia</div>
    <div class="auth-sub">Control financiero personal. Tus datos se guardan en tu Google Drive.</div>
    <button class="auth-gbtn" onclick="startGoogle()">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z"/><path fill="#fff" d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z"/><path fill="#fff" d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9 9 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z"/><path fill="#fff" d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z"/></svg>
      Conectar Google Drive
    </button>
    <button class="auth-skip" onclick="skipAuth()">Continuar sin Drive (datos locales)</button>
    <div id="auth-err"></div>
  </div>
</div>

<!-- RECONECT -->
<div id="reconect" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:8800;align-items:center;justify-content:center;padding:24px">
  <div class="auth-box">
    <div class="auth-logo">AU</div>
    <div class="auth-title">Sesión expirada</div>
    <div class="auth-sub">Tu sesión de Google expiró. Reconectá para sincronizar con Drive.</div>
    <button class="auth-gbtn" id="reconect-btn" onclick="reconectGoogle()">Reconectar Google Drive</button>
    <button class="auth-skip" onclick="skipAuth()">Usar datos locales</button>
    <div id="reconect-err"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- MODAL -->
<div id="modal-overlay" style="display:none">
  <div id="modal-box">
    <div id="modal-title"></div>
    <div id="modal-msg"></div>
    <div class="modal-btns">
      <button class="btn outline" onclick="modalResolve(false)">Cancelar</button>
      <button class="btn r" id="modal-confirm-btn" onclick="modalResolve(true)">Confirmar</button>
    </div>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="brand"><span class="brand-badge">AU</span> Finanzas · Australia</div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="tc-chip">
      <span id="tc-v" class="tc-val">—</span>
      <span style="color:var(--line2)">|</span>
      <span id="tc-inv" class="tc-val">—</span>
      <span onclick="manualTC()" style="cursor:pointer;color:var(--ink4);font-size:11px">✎</span>
    </div>
    <div class="sync-lbl" id="sync-st">—</div>
  </div>
</div>

<!-- TABS -->
<div class="tabnav">
  <div class="tab on" onclick="go('dash',this)">RESUMEN</div>
  <div class="tab" onclick="go('deuda',this)">DEUDA</div>
  <div class="tab" onclick="go('inv',this)">INVERSIÓN</div>
  <div class="tab" onclick="go('meses',this)">MESES</div>
  <div class="tab" onclick="go('metas',this)">METAS</div>
  <div class="tab" onclick="go('anual',this)">ANUAL</div>
</div>

<!-- ═══ DASHBOARD ═══ -->
<div class="pg on fade-in" id="pg-dash">
  <div class="sh"><div class="sh-row"><span class="sh-title">Resumen 2026</span><span class="sh-sub">ingresos · gastos · ahorro</span></div></div>
  <div class="stats">
    <div class="stat"><div class="stat-lbl">Ganado</div><div class="stat-val pos" id="d-ga">—</div><div class="stat-sub" id="d-gu">—</div></div>
    <div class="stat"><div class="stat-lbl">Gastado</div><div class="stat-val neg" id="d-gsa">—</div><div class="stat-sub" id="d-gsu">—</div></div>
    <div class="stat"><div class="stat-lbl">Ahorro</div><div class="stat-val" id="d-aa">—</div><div class="stat-sub" id="d-au">—</div></div>
    <div class="stat"><div class="stat-lbl">Inversión</div><div class="stat-val a" id="d-ia">—</div><div class="stat-sub" id="d-iu">—</div></div>
  </div>
  <div class="ledger-wrap">
    <div class="band" id="d-band">
      <div class="band-row">
        <div><div class="band-lbl">Caja disponible</div><div class="band-val pos" id="d-caja">—</div><div class="band-sub" id="d-cajau">—</div></div>
        <div style="text-align:right"><div class="band-lbl">Deuda pendiente</div><div class="band-val neg" id="d-deuda">—</div><div class="band-sub" id="d-deudu">—</div></div>
      </div>
    </div>
    <table class="ledger"><tbody>
      <tr><td class="label-cell italic">Meses activos</td><td class="num dim" id="d-mact">—</td><td></td></tr>
      <tr><td class="label-cell italic">Último mes</td><td class="num dim" id="d-lm">—</td><td></td></tr>
      <tr><td class="label-cell italic">Promedio mensual</td><td class="num" id="d-prom">—</td><td class="num dim" id="d-promu">—</td></tr>
    </tbody></table>
  </div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Nota</span></div></div>
  <div style="padding:0 16px 8px">
    <textarea id="nota-gral" rows="3" style="width:100%;background:var(--bg1);border:1px solid var(--line);border-radius:6px;padding:10px;font-family:var(--sans);font-size:13px;color:var(--ink);resize:none;outline:none" placeholder="Notas generales..." oninput="ST.nota=this.value;sched()"></textarea>
  </div>
  <div style="padding:0 16px 8px;display:flex;gap:8px;align-items:center">
    <button class="btn sm outline" onclick="syncNow()">↻ Sync Drive</button>
    <span class="sync-lbl" id="sync-st2">—</span>
  </div>
</div>

<!-- ═══ DEUDA ═══ -->
<div class="pg" id="pg-deuda">
  <div class="sh"><div class="sh-row"><span class="sh-title">Deuda con padres</span><span class="chip r" id="deu-chip">—</span></div></div>
  <div class="ledger-wrap">
    <table class="ledger">
      <thead><tr><th>Concepto</th><th class="r">AUD</th><th class="r">USD</th></tr></thead>
      <tbody>
        <tr><td class="label-cell italic">Inversión inicial</td><td class="num dim" id="deu-inv-a">—</td><td class="num dim" id="deu-inv-u">—</td></tr>
        <tr><td class="label-cell italic">Apoyo de padres</td><td class="num dim" id="deu-ap-a">—</td><td class="num dim" id="deu-ap-u">—</td></tr>
        <tr class="subtotal"><td class="bold">Deuda bruta</td><td class="num neg bold" id="deu-bruta-a">—</td><td class="num dim" id="deu-bruta-u">—</td></tr>
        <tr><td class="label-cell italic">Pagos realizados</td><td class="num pos" id="deu-pag-a">—</td><td class="num dim" id="deu-pag-u">—</td></tr>
        <tr class="total"><td class="bold">Deuda pendiente</td><td class="num neg bold" id="deu-pend-a">—</td><td class="num dim" id="deu-pend-u">—</td></tr>
      </tbody>
    </table>
  </div>
  <div style="padding:8px 16px">
    <div style="margin-bottom:8px">
      <label style="font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink3);display:block;margin-bottom:4px">Apoyo de padres (AUD)</label>
      <input id="apoyo-inp" class="inp-big" type="number" step=".01" inputmode="decimal" pattern="[0-9]*" placeholder="0.00" oninput="ST.apoyo=+this.value||0;sched();updDeuda();updDash()">
    </div>
  </div>
  <div class="ledger-wrap">
    <div class="band">
      <div class="band-lbl">Caja disponible</div>
      <div class="band-val pos" id="deu-caja">—</div>
      <div class="band-sub" id="deu-cajau">—</div>
    </div>
    <div style="padding:8px 12px;background:var(--bg1);border-bottom:1px solid var(--line);font-family:var(--mono);font-size:9px;color:var(--ink3);text-transform:uppercase;letter-spacing:1px">Porcentaje saldado</div>
    <div style="padding:10px 12px">
      <div class="prog-bar" style="height:6px"><div id="deu-prog" class="prog-fill" style="width:0%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:4px;font-family:var(--mono);font-size:10px;color:var(--ink3)">
        <span id="deu-pct">0%</span><span id="deu-rem">restante</span>
      </div>
    </div>
  </div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Registrar pago</span></div></div>
  <div class="sec-wrap">
    <div class="grid2" style="margin-bottom:10px">
      <div class="fg"><label>Fecha</label><input id="pago-f" class="inp-big" type="date"></div>
      <div class="fg"><label>Monto AUD</label><input id="pago-m" class="inp-big" type="number" step=".01" inputmode="decimal" pattern="[0-9]*" placeholder="0.00"></div>
    </div>
    <div class="fg"><label>Descripción</label><input id="pago-d" class="inp-big" type="text" placeholder="Ej: Transferencia total"></div>
    <button class="btn full" onclick="regPago()">Registrar pago</button>
  </div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Historial de pagos</span></div></div>
  <div class="ledger-wrap" id="pago-list"></div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Simulador de cuotas</span></div></div>
  <div class="sec-wrap">
    <div class="fg"><label>Meses para saldar</label><input id="cuota-m" class="inp-big" type="number" min="1" max="120" inputmode="numeric" placeholder="12" oninput="calcCuota()"></div>
    <div id="cuota-res" style="font-family:var(--mono);font-size:14px;color:var(--ink3);margin-top:4px"></div>
  </div>
</div>

<!-- ═══ INVERSIÓN ═══ -->
<div class="pg" id="pg-inv">
  <div class="sh"><div class="sh-row"><span class="sh-title">Inversión inicial</span><span class="sh-sub" id="inv-sub">—</span></div></div>
  <div class="ledger-wrap">
    <table class="ledger">
      <thead><tr><th>Concepto</th><th class="r">USD</th><th class="r">AUD</th></tr></thead>
      <tbody id="inv-tbody"></tbody>
      <tfoot>
        <tr class="subtotal"><td class="bold">Total USD</td><td class="num a bold" id="inv-tu">—</td><td class="num dim" id="inv-tau">—</td></tr>
        <tr class="total"><td class="bold">Total AUD</td><td class="num dim" id="inv-tuu">—</td><td class="num a bold" id="inv-ta">—</td></tr>
      </tfoot>
    </table>
  </div>
  <div style="padding:8px 16px"><button class="btn sm outline" onclick="addInv()">+ Agregar ítem</button></div>
</div>

<!-- ═══ MESES ═══ -->
<div class="pg" id="pg-meses">
  <div class="mstrip" id="mstrip-cnt"></div>
  <div id="mes-cnt"></div>
</div>

<!-- ═══ METAS ═══ -->
<div class="pg" id="pg-metas">
  <div class="sh"><div class="sh-row"><span class="sh-title">Metas de ahorro</span></div></div>
  <div class="ledger-wrap">
    <div class="band">
      <div class="band-lbl">Caja disponible</div>
      <div class="band-val pos" id="meta-caja">—</div>
    </div>
    <div style="padding:8px 12px;background:var(--bg1);border-bottom:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink3)">
      <span>Libre después de metas</span>
      <span id="meta-libre" style="font-weight:700;color:var(--blue)">—</span>
    </div>
  </div>
  <div id="metas-list"></div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Nueva meta</span></div></div>
  <div class="sec-wrap">
    <div class="fg"><label>Nombre</label><input id="meta-n" class="inp-big" type="text" placeholder="Ej: Viaje a Byron Bay"></div>
    <div class="grid2" style="margin-bottom:10px">
      <div class="fg"><label>Monto AUD</label><input id="meta-m" class="inp-big" type="number" step=".01" inputmode="decimal" pattern="[0-9]*" placeholder="0.00"></div>
      <div class="fg"><label>Prioridad (1-10)</label><input id="meta-p" class="inp-big" type="number" min="1" max="10" inputmode="numeric" placeholder="5"></div>
    </div>
    <button class="btn full" onclick="addMeta()">+ Agregar meta</button>
  </div>
</div>

<!-- ═══ ANUAL ═══ -->
<div class="pg" id="pg-anual">
  <div class="sh"><div class="sh-row"><span class="sh-title">Resumen anual</span><span class="sh-sub">2026</span></div></div>
  <div class="ledger-wrap" id="anual-meses"></div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Por categoría</span></div></div>
  <div class="ledger-wrap" id="anual-cats"></div>
</div>

<!-- FOOTER -->
<div class="foot">
  <div class="foot-cell"><div class="foot-lbl">Ahorro</div><div class="foot-val" id="f-aho">—</div></div>
  <div class="foot-cell"><div class="foot-lbl">Caja</div><div class="foot-val" id="f-caja">—</div></div>
  <div class="foot-cell"><div class="foot-lbl">Deuda</div><div class="foot-val" id="f-deu">—</div></div>
</div>

<script>
'use strict';

/* ═══════════════════════════════════════════════════════════
   CONSTANTS
═══════════════════════════════════════════════════════════ */
const CLIENT_ID = '181059148005-jbpua2ag12jpvh6niff7jovlniklogu3.apps.googleusercontent.com';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.appdata';
const STORAGE_KEY = 'cf_aus26';
const TOKEN_TTL = 3300000; // 55 min

const MN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const MS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

const GK = ['arriendo','comida','transporte','servicios','telefono','salud','seguros','ropa','entretenimiento','viajes','cuidado','gym','otros'];
const GL = ['Arriendo','Comida','Transporte','Servicios','Teléfono','Salud','Seguros','Ropa','Entretenimiento','Viajes','Cuidado personal','Gym','Otros'];

const IK = ['freelance','bonificacion','familia','otros'];
const IL = ['Freelance','Bonificación','Familia','Otros'];

const DEF_INV = [
  {c:'Vuelo ida',u:158,a:0},
  {c:'Alojamiento / Airbnb inicial',u:1727,a:0},
  {c:'Trámites / Visa',u:230,a:0},
  {c:'Equipaje / Ropa',u:0,a:0},
  {c:'Seguro de viaje',u:0,a:0},
  {c:'Teléfono / SIM',u:268,a:0},
  {c:'Transporte inicial',u:0,a:0},
  {c:'Alimentación llegada',u:0,a:0},
  {c:'Otros',u:0,a:0},
];

/* ═══════════════════════════════════════════════════════════
   STATE
═══════════════════════════════════════════════════════════ */
let ST = {};
let saveT = null;
let gToken = null;
let driveFileId = null;
let useGoogle = false;
let cM = new Date().getMonth();

/* ═══════════════════════════════════════════════════════════
   DATA MODEL
═══════════════════════════════════════════════════════════ */
// gVal: handles both array (new) and number (legacy migration)
const gVal = entries => Array.isArray(entries)
  ? entries.reduce((s,e) => s + (+e.m || 0), 0)
  : (+entries || 0);

const today = () => new Date().toISOString().slice(0,10);
const fDateShort = d => { if(!d) return ''; const p = d.split('-'); return p[2]+'/'+p[1]; };

function defM() {
  const g = {}, ing = {};
  GK.forEach(k => { g[k] = []; });
  IK.forEach(k => { ing[k] = []; });
  return { semanas:[0,0,0,0,0], horas:[0,0,0,0,0], ingresos:ing, gastos:g };
}

function initST() {
  const months = MN.map((_,i) => {
    const m = defM();
    // Feb 2026 initial data
    if(i === 1) {
      m.gastos.comida = [{d:'2026-02-01',m:132.51,n:'Súper semanal'}];
      m.gastos.transporte = [{d:'2026-02-01',m:45,n:''}];
      m.gastos.cuidado = [{d:'2026-02-01',m:17,n:''}];
      m.gastos.otros = [{d:'2026-02-01',m:123,n:'Afeitadora / Kebap'}];
    }
    return m;
  });
  return {
    tc: 0.6300, tcTime: '', nota: '', pagos: [], metas: [], apoyo: 0,
    invItems: JSON.parse(JSON.stringify(DEF_INV)),
    months
  };
}

function ensureState(s) {
  if(!s || typeof s !== 'object') return initST();
  if(!s.invItems) s.invItems = JSON.parse(JSON.stringify(DEF_INV));
  if(!s.pagos) s.pagos = [];
  if(!s.metas) s.metas = [];
  if(s.apoyo === undefined) s.apoyo = 0;
  if(!s.nota) s.nota = '';
  if(s.tc === undefined || !s.tc) s.tc = 0.6300;
  if(!s.months || s.months.length !== 12) {
    s.months = initST().months;
  } else {
    // Migrate old format
    s.months.forEach((m, mi) => {
      try {
        const yr = 2026, mnth = mi+1;
        const defDate = yr+'-'+String(mnth).padStart(2,'0')+'-01';
        const notas = (m.notas && typeof m.notas === 'object') ? m.notas : {};
        if(!m.gastos) m.gastos = {};
        if(!m.ingresos) m.ingresos = {};
        if(!m.semanas || !Array.isArray(m.semanas)) m.semanas = [0,0,0,0,0];
        if(!m.horas || !Array.isArray(m.horas)) m.horas = [0,0,0,0,0];
        GK.forEach(k => {
          const v = m.gastos[k];
          if(Array.isArray(v)) { /* ok */ }
          else if(typeof v === 'number' && v > 0) { m.gastos[k] = [{d:defDate,m:v,n:notas[k]||''}]; }
          else { m.gastos[k] = []; }
        });
        IK.forEach(k => {
          const v = m.ingresos[k];
          if(Array.isArray(v)) { /* ok */ }
          else if(typeof v === 'number' && v > 0) { m.ingresos[k] = [{d:defDate,m:v,n:''}]; }
          else { m.ingresos[k] = []; }
        });
        delete m.notas;
      } catch(e) { console.warn('Migration error month '+mi, e); }
    });
  }
  return s;
}

/* ═══════════════════════════════════════════════════════════
   CALCULATIONS
═══════════════════════════════════════════════════════════ */
const mSal = i => (ST.months[i].semanas||[]).reduce((a,b)=>a+b,0);
const mHrs = i => (ST.months[i].horas||[]).reduce((a,b)=>a+b,0);
const mIng = i => mSal(i) + IK.reduce((s,k) => s+gVal(ST.months[i].ingresos[k]),0);
const mGas = i => GK.reduce((s,k) => s+gVal(ST.months[i].gastos[k]),0);
const mAho = i => mIng(i) - mGas(i);
const tGan = () => MN.reduce((_,__,i) => _+mIng(i),0);
const tGas = () => MN.reduce((_,__,i) => _+mGas(i),0);
const tAho = () => tGan() - tGas();
const tIU = () => (ST.invItems||[]).reduce((s,x) => s+(+x.u||0),0);
const tIA = () => (ST.invItems||[]).reduce((s,x) => s+(+x.a>0 ? +x.a : (+x.u>0 ? +x.u/ST.tc : 0)),0);
const tPag = () => (ST.pagos||[]).reduce((s,p) => s+(+p.monto||0),0);
const a2u = n => n * ST.tc;
const u2a = n => ST.tc > 0 ? n / ST.tc : 0;

function calcD() {
  const invA = tIA();
  const apoyo = +ST.apoyo || 0;
  const bruta = invA + apoyo;
  const pag = tPag();
  const pend = Math.max(0, bruta - pag);
  const caja = Math.max(0, tAho() + apoyo - pag);
  return { invA, apoyo, bruta, pag, pend, caja };
}

/* ═══════════════════════════════════════════════════════════
   FORMAT HELPERS
═══════════════════════════════════════════════════════════ */
const fA = n => 'AUD '+n.toFixed(0);
const fA2 = n => 'AUD '+n.toFixed(2);
const fU2 = n => 'USD '+n.toFixed(2);
const setEl = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const fDate = d => { if(!d) return ''; const p=d.split('-'); return p[2]+'/'+p[1]+'/'+p[0].slice(2); };

/* ═══════════════════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════════════════ */
let _toastT = null;
function toast(msg, ms) {
  ms = ms||2500;
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  if(_toastT) clearTimeout(_toastT);
  _toastT = setTimeout(() => el.classList.remove('show'), ms);
}

/* ═══════════════════════════════════════════════════════════
   MODAL
═══════════════════════════════════════════════════════════ */
let _modalResolve = null;
function showModal(title, msg, confirmLabel, danger) {
  confirmLabel = confirmLabel||'Confirmar'; danger = danger!==false;
  return new Promise(resolve => {
    _modalResolve = resolve;
    setEl('modal-title',title); setEl('modal-msg',msg);
    const btn = document.getElementById('modal-confirm-btn');
    btn.textContent = confirmLabel; btn.className = 'btn'+(danger?' r':'');
    const ov = document.getElementById('modal-overlay');
    ov.style.display = 'flex';
    const box = document.getElementById('modal-box');
    box.style.transform = 'translateY(100%)';
    requestAnimationFrame(()=>requestAnimationFrame(()=>{ box.style.transform='translateY(0)'; box.style.transition='transform .25s ease'; }));
  });
}
function modalResolve(val) {
  const ov = document.getElementById('modal-overlay');
  const box = document.getElementById('modal-box');
  box.style.transform = 'translateY(100%)';
  setTimeout(()=>{ ov.style.display='none'; },250);
  if(_modalResolve){ _modalResolve(val); _modalResolve=null; }
  if(val && navigator.vibrate) navigator.vibrate(10);
}

/* ═══════════════════════════════════════════════════════════
   LOCAL STORAGE
═══════════════════════════════════════════════════════════ */
const lsave = () => { try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(ST)); }catch(e){} };
const lload = () => { try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):null; }catch(e){ return null; } };

/* ═══════════════════════════════════════════════════════════
   GOOGLE DRIVE
═══════════════════════════════════════════════════════════ */
function saveToken(t) { localStorage.setItem('cf_tok',t); localStorage.setItem('cf_tok_ts',Date.now()); }
function loadToken() { const t=localStorage.getItem('cf_tok'),ts=+localStorage.getItem('cf_tok_ts')||0; return (Date.now()-ts<TOKEN_TTL)?t:null; }
function clearToken() { localStorage.removeItem('cf_tok'); localStorage.removeItem('cf_tok_ts'); }

async function driveReq(url, opts) {
  opts = opts||{};
  opts.headers = opts.headers||{};
  opts.headers['Authorization'] = 'Bearer '+gToken;
  const res = await fetch(url, opts);
  if(res.status === 401) { clearToken(); showReconect(); throw new Error('401'); }
  return res;
}

async function findFile() {
  const r = await driveReq('https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=files(id,name)&q=name%3D%22cf_aus26.json%22');
  const d = await r.json();
  return d.files && d.files.length ? d.files[0].id : null;
}

async function readFile(fid) {
  const r = await driveReq('https://www.googleapis.com/drive/v3/files/'+fid+'?alt=media');
  return r.json();
}

async function createFile(data) {
  const meta = JSON.stringify({name:'cf_aus26.json',parents:['appDataFolder']});
  const body = JSON.stringify(data);
  const form = new FormData();
  form.append('metadata', new Blob([meta],{type:'application/json'}));
  form.append('media', new Blob([body],{type:'application/json'}));
  const r = await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {method:'POST',body:form});
  const d = await r.json();
  return d.id;
}

async function updateFile(fid, data) {
  const r = await driveReq('https://www.googleapis.com/upload/drive/v3/files/'+fid+'?uploadType=media',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  return r.ok;
}

async function saveDrive() {
  if(!useGoogle || !gToken) return;
  try {
    lsave();
    if(!driveFileId) driveFileId = await findFile();
    if(driveFileId) { await updateFile(driveFileId, ST); }
    else { driveFileId = await createFile(ST); }
    setEl('sync-st','✓ Drive'); setEl('sync-st2','✓ Drive');
  } catch(e) { setEl('sync-st','⚠ error'); }
}

async function syncNow() {
  toast('Sincronizando...'); await saveDrive(); toast('✓ Guardado en Drive');
}

async function refreshToken() {
  return new Promise((resolve,reject) => {
    try {
      google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID, scope:DRIVE_SCOPE, prompt:'',
        callback: resp => {
          if(resp.error||!resp.access_token){ reject(resp.error); return; }
          gToken=resp.access_token; saveToken(gToken); resolve();
        }
      }).requestAccessToken({prompt:''});
    } catch(e){ reject(e); }
  });
}

/* ═══════════════════════════════════════════════════════════
   SAVE SCHEDULER
═══════════════════════════════════════════════════════════ */
function sched() {
  lsave();
  if(saveT) clearTimeout(saveT);
  saveT = setTimeout(saveDrive, 4000);
}

/* ═══════════════════════════════════════════════════════════
   TC (EXCHANGE RATE)
═══════════════════════════════════════════════════════════ */
async function fetchTC() {
  const apis = [
    ()=>fetch('https://api.exchangerate-api.com/v4/latest/USD').then(r=>r.json()).then(d=>d.rates.AUD),
    ()=>fetch('https://open.er-api.com/v6/latest/USD').then(r=>r.json()).then(d=>d.rates.AUD),
    ()=>fetch('https://api.fxratesapi.com/latest?base=USD&currencies=AUD').then(r=>r.json()).then(d=>d.rates.AUD),
  ];
  for(const api of apis) {
    try { const v=await api(); if(v>0){ ST.tc=+v.toFixed(4); ST.tcTime=new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); sched(); return; } }
    catch(e){}
  }
}

function renderTC() {
  const aud = ST.tc||0.63;
  const usdToAud = aud > 0 ? 1/aud : 0;
  setEl('tc-v', '● '+(usdToAud).toFixed(4)+' USD');
  setEl('tc-inv', (aud).toFixed(4)+' AUD'+(ST.tcTime?' ✓ '+ST.tcTime:''));
}

function updateTC() { fetchTC().then(renderTC).catch(()=>{}); }

function manualTC() {
  const v = prompt('TC manual (USD→AUD, ej: 1.5700):', (1/(ST.tc||.63)).toFixed(4));
  if(!v) return;
  const n = parseFloat(v);
  if(n > 0) { ST.tc = +(1/n).toFixed(4); ST.tcTime = 'manual'; sched(); renderTC(); updateAll(); }
}

/* ═══════════════════════════════════════════════════════════
   RENDER UPDATES
═══════════════════════════════════════════════════════════ */
function updFoot() {
  const d = calcD();
  const aho = tAho();
  const el = document.getElementById('f-aho');
  if(el){ el.textContent=fA(aho); el.style.color=aho>=0?'var(--green)':'var(--red)'; }
  setEl('f-caja', fA(d.caja));
  setEl('f-deu', fA(d.pend));
}

function updDash() {
  const gan=tGan(), gas=tGas(), aho=tAho(), d=calcD();
  setEl('d-ga', fA2(gan)); setEl('d-gu', fU2(a2u(gan)));
  setEl('d-gsa', fA2(gas)); setEl('d-gsu', fU2(a2u(gas)));
  const ael = document.getElementById('d-aa');
  if(ael){ ael.textContent=fA2(aho); ael.className='stat-val '+(aho>=0?'pos':'neg'); }
  setEl('d-au', fU2(a2u(aho)));
  setEl('d-ia', fA2(tIA())); setEl('d-iu', fU2(tIU()));
  setEl('d-caja', fA2(d.caja)); setEl('d-cajau', fU2(a2u(d.caja)));
  setEl('d-deuda', fA2(d.pend)); setEl('d-deudu', fU2(a2u(d.pend)));
  // active months
  let act=0; for(let i=0;i<12;i++) if(mGas(i)||mIng(i)) act++;
  setEl('d-mact', act ? act+(act===1?' mes activo':' meses activos') : '—');
  let lm=-1; for(let i=11;i>=0;i--){ if(mGas(i)||mIng(i)){lm=i;break;} }
  if(lm>=0){
    const ing=mIng(lm), g=mGas(lm), a=mAho(lm);
    setEl('d-lm', MN[lm]+' · '+fA2(a));
    setEl('d-prom', act>0?fA2(aho/act):'—');
    setEl('d-promu', act>0?fU2(a2u(aho/act)):'—');
  }
  const nt = document.getElementById('nota-gral');
  if(nt && nt.value !== (ST.nota||'')) nt.value = ST.nota||'';
}

function updDeuda() {
  const d = calcD();
  // invA is AUD equivalent of original USD items; raw USD = tIU()
  setEl('deu-inv-a', fA2(d.invA)); setEl('deu-inv-u', fU2(tIU()));
  // apoyo stored as AUD; show USD equivalent
  setEl('deu-ap-a', fA2(d.apoyo)); setEl('deu-ap-u', fU2(a2u(d.apoyo)));
  // bruta USD = inv original USD + apoyo in USD
  const brutaU = tIU() + a2u(d.apoyo);
  setEl('deu-bruta-a', fA2(d.bruta)); setEl('deu-bruta-u', fU2(brutaU));
  // pagos in AUD
  setEl('deu-pag-a', fA2(d.pag)); setEl('deu-pag-u', fU2(a2u(d.pag)));
  setEl('deu-pend-a', fA2(d.pend)); setEl('deu-pend-u', fU2(a2u(d.pend)));
  setEl('deu-chip', fA2(d.pend));
  setEl('deu-caja', fA2(d.caja)); setEl('deu-cajau', fU2(a2u(d.caja)));
  const pct = d.bruta>0 ? Math.min(100, d.pag/d.bruta*100) : 0;
  const bar = document.getElementById('deu-prog');
  if(bar) bar.style.width = pct.toFixed(1)+'%';
  setEl('deu-pct', pct.toFixed(1)+'%');
  setEl('deu-rem', d.pend>0 ? fA2(d.pend)+' restante' : '¡Saldada!');
  // apoyo input
  const ai = document.getElementById('apoyo-inp');
  if(ai && document.activeElement !== ai) ai.value = ST.apoyo||'';
  // payments list
  const pl = document.getElementById('pago-list');
  if(pl) {
    if(!ST.pagos.length) {
      pl.innerHTML = '<div class="empty">Sin pagos registrados</div>';
    } else {
      pl.innerHTML = [...ST.pagos].reverse().map((p,ri) => {
        const i = ST.pagos.length-1-ri;
        return '<div class="pay-row">'
          +'<span class="pay-date">'+fDate(p.fecha)+'</span>'
          +'<span class="pay-desc">'+esc(p.desc||'Pago')+'</span>'
          +'<span class="pay-amt">+'+fA2(p.monto)+'</span>'
          +'<button class="pay-del" onclick="delPag('+i+')" title="Eliminar">×</button>'
          +'</div>';
      }).join('');
    }
  }
}

function updInv() {
  const tbody = document.getElementById('inv-tbody');
  if(!tbody) return;
  tbody.innerHTML = (ST.invItems||[]).map((it,i) =>
    '<tr class="inv-row" style="display:table-row">'
    +'<td style="padding:8px 12px"><input class="inp-line" value="'+esc(it.c||'')+'" placeholder="Concepto" oninput="ST.invItems['+i+'].c=this.value;sched()"></td>'
    +'<td style="padding:8px 6px;width:100px"><input class="inp-num" type="number" step=".01" inputmode="decimal" value="'+(it.u||'')+'" placeholder="0" pattern="[0-9]*" oninput="ST.invItems['+i+'].u=+this.value||0;sched();updInvInline()"></td>'
    +'<td style="padding:8px 6px;width:100px"><input class="inp-num" type="number" step=".01" inputmode="decimal" value="'+(it.a||'')+'" placeholder="auto" pattern="[0-9]*" oninput="ST.invItems['+i+'].a=+this.value||0;sched();updInvInline()"></td>'
    +'</tr>'
  ).join('');
  updInvInline();
}

function updInvInline() {
  const tu=tIU(), ta=tIA();
  setEl('inv-tu', fU2(tu)); setEl('inv-tau', fA2(u2a(tu)));
  setEl('inv-tuu', fU2(tu)); setEl('inv-ta', fA2(ta));
  setEl('inv-sub', fA2(ta)+' · USD '+tu.toFixed(0));
}

function addInv() {
  ST.invItems.push({c:'',u:0,a:0}); sched(); updInv();
}

function updMetas() {
  const d = calcD();
  const caja = d.caja;
  setEl('meta-caja', fA2(caja));
  const total = (ST.metas||[]).reduce((s,m)=>s+(+m.monto||0),0);
  const libre = caja - total;
  const libreEl = document.getElementById('meta-libre');
  if(libreEl){ libreEl.textContent=fA2(libre); libreEl.style.color=libre>=0?'var(--blue)':'var(--red)'; }
  const list = document.getElementById('metas-list');
  if(!list) return;
  if(!ST.metas.length) { list.innerHTML='<div class="empty">Sin metas definidas</div>'; return; }
  const sorted = [...ST.metas].sort((a,b)=>(+a.prio||5)-(+b.prio||5));
  list.innerHTML = sorted.map((m,si) => {
    const i = ST.metas.indexOf(m);
    const pct = caja>0 ? Math.min(100,m.monto/caja*100) : 0;
    return '<div class="ledger-wrap" style="margin-bottom:8px">'
      +'<div style="padding:12px">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">'
      +'<span class="meta-name">'+esc(m.nombre)+'</span>'
      +'<div style="display:flex;gap:8px;align-items:center">'
      +'<span class="chip">P'+m.prio+'</span>'
      +'<span class="chip '+(caja>=m.monto?'g':'a')+'">'+fA2(m.monto)+'</span>'
      +'<button class="btn sm r" onclick="delMeta('+i+')">×</button>'
      +'</div></div>'
      +'<div class="meta-bar-wrap"><div class="meta-bar-fill" style="width:'+pct.toFixed(1)+'%;background:'+(caja>=m.monto?'var(--green)':'var(--amber)')+'"></div></div>'
      +'<div style="font-family:var(--mono);font-size:10px;color:var(--ink3)">'+pct.toFixed(0)+'% · falta '+fA2(Math.max(0,m.monto-caja))+'</div>'
      +'</div></div>';
  }).join('');
}

function addMeta() {
  const n=document.getElementById('meta-n').value.trim();
  const m=+document.getElementById('meta-m').value||0;
  const p=+document.getElementById('meta-p').value||5;
  if(!n||!m){ toast('Completá nombre y monto'); return; }
  ST.metas.push({nombre:n,monto:m,prio:p});
  document.getElementById('meta-n').value='';
  document.getElementById('meta-m').value='';
  document.getElementById('meta-p').value='';
  sched(); updMetas();
  if(navigator.vibrate) navigator.vibrate(10);
}

async function delMeta(i) {
  const ok = await showModal('Eliminar meta','¿Eliminar "'+esc(ST.metas[i].nombre)+'"?','Eliminar');
  if(!ok) return;
  ST.metas.splice(i,1); sched(); updMetas();
}

function updAnual() {
  const meses = document.getElementById('anual-meses');
  const cats = document.getElementById('anual-cats');
  if(!meses||!cats) return;
  // months table
  let rows = '';
  for(let i=0;i<12;i++){
    const ing=mIng(i), gas=mGas(i), aho=mAho(i);
    if(!ing&&!gas) continue;
    rows += '<tr><td class="label-cell">'+MN[i]+'</td>'
      +'<td class="num pos">'+fA2(ing)+'</td>'
      +'<td class="num neg">'+fA2(gas)+'</td>'
      +'<td class="num '+(aho>=0?'pos':'neg')+'">'+fA2(aho)+'</td></tr>';
  }
  const tot_ing=tGan(), tot_gas=tGas(), tot_aho=tAho();
  rows += '<tr class="subtotal"><td class="bold">Total</td><td class="num pos bold">'+fA2(tot_ing)+'</td><td class="num neg bold">'+fA2(tot_gas)+'</td><td class="num '+(tot_aho>=0?'pos':'neg')+' bold">'+fA2(tot_aho)+'</td></tr>';
  meses.innerHTML = '<table class="ledger"><thead><tr><th>Mes</th><th class="r">Ingresos</th><th class="r">Gastos</th><th class="r">Ahorro</th></tr></thead><tbody>'+rows+'</tbody></table>';
  // categories
  const catTotals = GK.map((k,ki) => ({
    k, lbl:GL[ki],
    val: MN.reduce((_,__,i) => _+gVal(ST.months[i].gastos[k]),0)
  })).filter(x=>x.val>0).sort((a,b)=>b.val-a.val);
  if(!catTotals.length){ cats.innerHTML='<div class="empty">Sin datos</div>'; return; }
  const maxV = catTotals[0].val;
  cats.innerHTML = '<table class="ledger"><thead><tr><th>Categoría</th><th class="r">AUD</th><th class="r">%</th></tr></thead><tbody>'
    + catTotals.map(c =>
        '<tr><td class="label-cell">'+c.lbl+'<div class="prog-bar"><div class="prog-fill" style="width:'+((c.val/maxV)*100).toFixed(0)+'%"></div></div></td>'
        +'<td class="num neg">'+fA2(c.val)+'</td>'
        +'<td class="num dim">'+(tot_gas>0?(c.val/tot_gas*100).toFixed(1):'0')+'%</td></tr>'
      ).join('')
    +'</tbody></table>';
}

function updateAll() {
  renderTC(); updFoot(); updDash(); updDeuda(); updInv(); updMetas(); updAnual();
}

/* ═══════════════════════════════════════════════════════════
   PAYMENTS
═══════════════════════════════════════════════════════════ */
async function regPago() {
  const f=document.getElementById('pago-f').value;
  const m=+document.getElementById('pago-m').value||0;
  const d_=document.getElementById('pago-d').value.trim();
  if(!f||!m){ toast('Completá fecha y monto'); return; }
  const caja = calcD().caja;
  if(m > caja) {
    const ok = await showModal('Pago mayor a caja','El pago ('+fA2(m)+') supera tu caja disponible ('+fA2(caja)+'). ¿Continuar?','Confirmar');
    if(!ok) return;
  }
  ST.pagos.push({fecha:f, monto:m, desc:d_||'Pago a padres'});
  document.getElementById('pago-m').value='';
  document.getElementById('pago-d').value='';
  sched(); updDeuda(); updDash(); updFoot();
  toast('Pago registrado ✓');
  if(navigator.vibrate) navigator.vibrate([10,50,10]);
}

async function delPag(i) {
  const p = ST.pagos[i];
  const ok = await showModal('Eliminar pago',fDate(p.fecha)+' · '+fA2(p.monto)+' · '+esc(p.desc||'Pago'),'Eliminar');
  if(!ok) return;
  ST.pagos.splice(i,1); sched(); updDeuda(); updDash(); updFoot();
}

function calcCuota() {
  const meses = +document.getElementById('cuota-m').value||0;
  const d = calcD();
  const el = document.getElementById('cuota-res');
  if(!el) return;
  if(d.pend<=0){ el.textContent='¡Deuda saldada!'; el.style.color='var(--green)'; return; }
  if(!meses){ el.textContent=''; return; }
  const cuota = d.pend/meses;
  el.textContent = fA2(cuota)+' / mes · '+fU2(a2u(cuota))+' / mes';
  el.style.color = 'var(--ink2)';
}

/* ═══════════════════════════════════════════════════════════
   LOG HELPERS
═══════════════════════════════════════════════════════════ */
function renderLog(entries, mi, field, key, maxShow) {
  maxShow = maxShow||5;
  if(!Array.isArray(entries)||!entries.length) return '';
  const sorted = [...entries].reverse();
  const visible = sorted.slice(0,maxShow);
  const hidden = sorted.length - maxShow;
  const logId = 'log-'+field+'-'+mi+'-'+key;
  const rowHtml = visible.map((e,ei) => {
    const realIdx = entries.length-1-ei;
    return '<div class="log-entry">'
      +'<span class="log-date">'+fDateShort(e.d)+'</span>'
      +'<span class="log-note">'+esc(e.n||'')+'</span>'
      +'<span class="log-amt">+'+fA2(+e.m)+'</span>'
      +'<button class="log-del" onclick="delEntry('+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;,'+realIdx+')" title="Eliminar">×</button>'
      +'</div>';
  }).join('');
  const moreHtml = hidden>0
    ? '<div class="log-more" onclick="expandLog(&quot;'+logId+'&quot;,'+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;)">▸ ver '+hidden+' más</div>'
    : '';
  return '<div class="log-wrap" id="'+logId+'">'+rowHtml+moreHtml+'</div>';
}
function expandLog(id, mi, field, key) {
  const wrap = document.getElementById(id);
  if(!wrap) return;
  const entries = ST.months[mi][field][key];
  if(!Array.isArray(entries)) return;
  const sorted = [...entries].reverse();
  wrap.innerHTML = sorted.map((e,ei) => {
    const realIdx = entries.length-1-ei;
    return '<div class="log-entry">'
      +'<span class="log-date">'+fDateShort(e.d)+'</span>'
      +'<span class="log-note">'+esc(e.n||'')+'</span>'
      +'<span class="log-amt">+'+fA2(+e.m)+'</span>'
      +'<button class="log-del" onclick="delEntry('+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;,'+realIdx+')" title="Eliminar">×</button>'
      +'</div>';
  }).join('') + '<div class="log-more" onclick="expandLog(&quot;'+id+'&quot;,'+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;)">▴ ver menos</div>';
}
function delEntry(mi, field, key, idx) {
  const arr = ST.months[mi][field][key];
  if(!arr||!arr[idx]) return;
  arr.splice(idx,1);
  sched(); renderMes(); updMesInline(mi);
}

function openAdd(id) {
  const row = document.getElementById('add-'+id);
  if(!row) return;
  const isOpen = row.classList.contains('open');
  document.querySelectorAll('.add-row.open').forEach(r=>r.classList.remove('open'));
  if(!isOpen) {
    row.classList.add('open');
    const inp = row.querySelector('.add-amt');
    if(inp) setTimeout(()=>inp.focus(),50);
  }
}

function submitAdd(mi, field, key, dateId, amtId, noteId) {
  const amt = +(document.getElementById(amtId).value)||0;
  const note = document.getElementById(noteId).value.trim();
  const dateEl = document.getElementById(dateId);
  const d = (dateEl && dateEl.value) ? dateEl.value : today();
  if(amt<=0) return;
  if(!Array.isArray(ST.months[mi][field][key])) ST.months[mi][field][key]=[];
  ST.months[mi][field][key].push({d:d,m:amt,n:note});
  sched(); renderMes(); updMesInline(mi);
  if(navigator.vibrate) navigator.vibrate(10);
}

/* ═══════════════════════════════════════════════════════════
   MONTHS
═══════════════════════════════════════════════════════════ */
function renderCatSection(mi, field, labels, keys, m_field) {
  const isGas = field==='gastos';
  const colorClass = isGas ? 'neg' : 'pos';
  const rows = keys.map((k,ki) => {
    const entries = Array.isArray(m_field[k]) ? m_field[k] : [];
    const total = gVal(m_field[k]);
    const uid = mi+'-'+field+'-'+k;
    const addId = 'add-'+uid;
    const amtId = 'aa-'+uid;
    const noteId = 'an-'+uid;
    const totId = (isGas?'gas':'ing')+'-tot-'+mi+'-'+ki;
    const logHtml = renderLog(entries, mi, field, k);
    let h = '<div class="cat-row">';
    h += '<span class="cat-lbl">'+labels[ki]+'</span>';
    h += '<span class="cat-total '+(total>0?colorClass:'')+'" id="'+totId+'">'+(total>0?fA2(total):'—')+'</span>';
    h += '<button class="cat-add" onclick="openAdd(&quot;'+uid+'&quot;)">+ agregar</button>';
    h += '</div>'+logHtml;
    const dateId = 'ad-'+uid;
    h += '<div class="add-row" id="'+addId+'">';
    h += '<input id="'+dateId+'" class="add-date" type="date" value="'+today()+'">';
    h += '<input id="'+amtId+'" class="add-amt" type="number" step=".01" inputmode="decimal" placeholder="AUD 0.00"';
    h += ' onkeydown="if(event.key===\'Enter\')submitAdd('+mi+',&quot;'+field+'&quot;,&quot;'+k+'&quot;,&quot;'+dateId+'&quot;,&quot;'+amtId+'&quot;,&quot;'+noteId+'&quot;)">';
    h += '<input id="'+noteId+'" class="add-note" type="text" placeholder="nota opcional"';
    h += ' onkeydown="if(event.key===\'Enter\')submitAdd('+mi+',&quot;'+field+'&quot;,&quot;'+k+'&quot;,&quot;'+dateId+'&quot;,&quot;'+amtId+'&quot;,&quot;'+noteId+'&quot;)">';
    h += '<button class="add-ok" onclick="submitAdd('+mi+',&quot;'+field+'&quot;,&quot;'+k+'&quot;,&quot;'+dateId+'&quot;,&quot;'+amtId+'&quot;,&quot;'+noteId+'&quot;)">✓</button>';
    h += '<button class="add-cancel" onclick="openAdd(&quot;'+uid+'&quot;)">×</button>';
    h += '</div>';
    return h;
  }).join('');
  return rows;
}

function renderMes() {
  const i=cM, m=ST.months[i];
  const sal=mSal(i), ing=mIng(i), gas=mGas(i), aho=mAho(i), hrs=mHrs(i);
  const tarifa = hrs>0&&ing>0 ? (ing/hrs).toFixed(2) : '—';
  const sinI = ing===0&&gas>0;
  const bon = aho>0&&ing>0;
  const bandClass = sinI?'band r':bon?'band g':'band';

  const bandInner = sinI
    ? '<div class="band-lbl">Mes sin ingresos</div><div style="font-family:var(--mono);font-size:11px;color:var(--red)">'+fA(gas)+' gastados suman a la deuda bruta.</div>'
    : bon
    ? '<div class="band-lbl">Mes positivo</div><div style="font-family:var(--mono);font-size:11px;color:var(--green)">'+fA(aho)+' acumulados en tu caja.</div>'
    : '';

  const ingRows = renderCatSection(i,'ingresos',IL,IK,m.ingresos);
  const gasRows = renderCatSection(i,'gastos',GL,GK,m.gastos);

  const weekGrid = [0,1,2,3,4].map(s =>
    '<div class="week-cell"><div class="week-lbl">Sem '+(s+1)+'</div>'
    +'<input class="week-inp" type="number" step=".01" inputmode="decimal" pattern="[0-9]*" value="'+(m.semanas[s]||'')+'" placeholder="0"'
    +' oninput="ST.months['+i+'].semanas['+s+']=+this.value||0;sched();updMesInline('+i+');">'
    +'</div>'
  ).join('');

  const hrsGrid = [0,1,2,3,4].map(s =>
    '<div class="hrs-cell"><div class="week-lbl">Sem '+(s+1)+'</div>'
    +'<input class="hrs-inp" type="number" step="1" inputmode="numeric" value="'+(m.horas[s]||'')+'" placeholder="0"'
    +' oninput="ST.months['+i+'].horas['+s+']=+this.value||0;sched();updMesInline('+i+');">'
    +'</div>'
  ).join('');

  const cnt = document.getElementById('mes-cnt');
  if(!cnt) return;

  cnt.innerHTML =
    '<div id="mes-band-'+i+'" class="'+bandClass+'">'+bandInner+'</div>'
    +'<div class="ledger-wrap"><table class="ledger"><tbody>'
    +'<tr class="subtotal"><td class="bold" style="font-family:var(--mono)">'+MN[i]+'</td><td class="num bold '+(aho>=0?'pos':'neg')+'" id="m-aho-'+i+'">'+fA2(aho)+'</td><td class="num dim">'+fU2(a2u(aho))+'</td></tr>'
    +'<tr><td class="label-cell italic">Ingresos totales</td><td class="num pos" id="m-ing-'+i+'">'+fA2(ing)+'</td><td class="num dim">'+fU2(a2u(ing))+'</td></tr>'
    +'<tr><td class="label-cell italic">Gastos totales</td><td class="num neg" id="m-gas-'+i+'">'+fA2(gas)+'</td><td class="num dim" id="m-gasu-'+i+'">'+fU2(a2u(gas))+'</td></tr>'
    +'<tr><td class="label-cell italic">Horas trabajadas</td><td class="num dim" id="m-hrs-'+i+'">'+( hrs>0?hrs+'h':'—')+'</td><td class="num dim" id="m-tarifa-'+i+'">'+(hrs>0?tarifa+' AUD/h':'—')+'</td></tr>'
    +'</tbody></table></div>'
    +'<div class="sh"><div class="sh-row"><span class="sh-title">Salario semanal</span><span class="sh-sub" id="salb-'+i+'">'+fA2(sal)+'</span></div></div>'
    +'<div class="week-grid">'+weekGrid+'</div>'
    +'<div style="padding:6px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)">'
    +'<span>Total mensual</span><span id="sal-foot-'+i+'" style="color:var(--green);font-weight:600">'+fA2(sal)+' · '+fU2(a2u(sal))+'</span></div>'
    +'<div class="sh"><div class="sh-row"><span class="sh-title">Horas trabajadas</span><span class="sh-sub" id="hrsb-'+i+'">'+(hrs>0?hrs+'h total':'')+'</span></div></div>'
    +'<div class="hrs-grid">'+hrsGrid+'</div>'
    +'<div style="padding:6px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)">'
    +'<span>Total horas</span><span id="hrs-foot-'+i+'" style="color:'+(hrs>0?'var(--blue)':'var(--ink4)')+';font-weight:600">'+(hrs>0?hrs+'h · AUD '+tarifa+'/h':'Sin horas cargadas')+'</span></div>'
    +'<div class="sh"><div class="sh-row"><span class="sh-title">Otros ingresos</span></div></div>'
    +'<div class="cat-section">'+ingRows+'</div>'
    +'<div class="sh"><div class="sh-row"><span class="sh-title">Gastos</span><span class="sh-sub" id="tot-gas-lbl-'+i+'">'+fA2(gas)+'</span></div></div>'
    +'<div class="cat-section">'+gasRows
    +'<div class="cat-total-footer"><span style="color:var(--ink2)">Total gastos</span><span class="neg" id="tot-gas-'+i+'">'+fA2(gas)+'</span></div>'
    +'</div>';
}

function updMesInline(i) {
  const m=ST.months[i], gas=mGas(i), ing=mIng(i), aho=mAho(i), sal=mSal(i), hrs=mHrs(i);
  const tarifa = hrs>0&&ing>0 ? (ing/hrs).toFixed(2) : '—';
  GK.forEach((k,ki) => {
    const total=gVal(m.gastos[k]);
    const el=document.getElementById('gas-tot-'+i+'-'+ki);
    if(el){ el.textContent=total>0?fA2(total):'—'; el.className='cat-total '+(total>0?'neg':''); }
  });
  IK.forEach((k,ki) => {
    const total=gVal(m.ingresos[k]);
    const el=document.getElementById('ing-tot-'+i+'-'+ki);
    if(el){ el.textContent=total>0?fA2(total):'—'; el.className='cat-total '+(total>0?'pos':''); }
  });
  setEl('tot-gas-'+i, fA2(gas)); setEl('tot-gas-lbl-'+i, fA2(gas));
  const sa=document.getElementById('m-aho-'+i); if(sa){ sa.textContent=fA2(aho); sa.className='num bold '+(aho>=0?'pos':'neg'); }
  setEl('m-ing-'+i, fA2(ing)); setEl('m-gas-'+i, fA2(gas)); setEl('m-gasu-'+i, fU2(a2u(gas)));
  setEl('m-hrs-'+i, hrs>0?hrs+'h':'—'); setEl('m-tarifa-'+i, hrs>0?tarifa+' AUD/h':'—');
  setEl('salb-'+i, fA2(sal)); setEl('sal-foot-'+i, fA2(sal)+' · '+fU2(a2u(sal)));
  setEl('hrsb-'+i, hrs>0?hrs+'h total':'');
  const hf=document.getElementById('hrs-foot-'+i);
  if(hf){ hf.textContent=hrs>0?hrs+'h · AUD '+tarifa+'/h':'Sin horas cargadas'; hf.style.color=hrs>0?'var(--blue)':'var(--ink4)'; }
  const sinI=ing===0&&gas>0, bon_=aho>0&&ing>0;
  const band=document.getElementById('mes-band-'+i);
  if(band){
    band.className=sinI?'band r':bon_?'band g':'band';
    band.innerHTML=sinI
      ?'<div class="band-lbl">Mes sin ingresos</div><div style="font-family:var(--mono);font-size:11px;color:var(--red)">'+fA(gas)+' gastados suman a la deuda bruta.</div>'
      :bon_?'<div class="band-lbl">Mes positivo</div><div style="font-family:var(--mono);font-size:11px;color:var(--green)">'+fA(aho)+' acumulados en tu caja.</div>'
      :'';
  }
  renderStrip(); updDeuda(); updFoot(); updDash();
}

function renderStrip() {
  const c = document.getElementById('mstrip-cnt');
  if(!c) return;
  c.innerHTML = '';
  MN.forEach((mn,i) => {
    const hd = mIng(i)||mGas(i);
    const el = document.createElement('div');
    el.className = 'mtab'+(i===cM?' on':'')+(hd?' has':'');
    el.textContent = MS[i];
    el.onclick = () => { cM=i; renderStrip(); renderMes(); };
    c.appendChild(el);
  });
  const active = c.querySelector('.mtab.on');
  if(active) active.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
}

/* ═══════════════════════════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════════════════════════ */
function go(name, el) {
  document.querySelectorAll('.pg').forEach(p=>{ p.classList.remove('on'); p.classList.remove('fade-in'); });
  const pg = document.getElementById('pg-'+name);
  if(!pg) return;
  pg.classList.add('on');
  void pg.offsetWidth;
  pg.classList.add('fade-in');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  if(el) el.classList.add('on');
  if(name==='meses'){ renderStrip(); renderMes(); }
  updateAll();
  window.scrollTo(0,0);
  if(navigator.vibrate) navigator.vibrate(10);
}

/* ═══════════════════════════════════════════════════════════
   AUTH
═══════════════════════════════════════════════════════════ */

function hideAll() { ['loading','auth','reconect'].forEach(id=>{ const e=document.getElementById(id); if(e) e.style.display='none'; }); }
function showLoading() { hideAll(); document.getElementById('loading').style.display='flex'; }
function showAuth() { hideAll(); const e=document.getElementById('auth'); if(e){ e.style.display='flex'; } }
function showReconect() { hideAll(); const e=document.getElementById('reconect'); if(e){ e.style.display='flex'; } }

function setLoadingProgress(pct, msg) {
  const bar=document.getElementById('loading-bar');
  const lbl=document.getElementById('loading-msg');
  if(bar) bar.style.width=pct+'%';
  if(lbl&&msg) lbl.textContent=msg;
}

async function bootDrive() {
  setLoadingProgress(20,'Conectando a Drive...');
  try {
    setLoadingProgress(50,'Buscando datos...');
    driveFileId = await findFile();
    if(driveFileId){
      setLoadingProgress(75,'Cargando...');
      ST = ensureState(await readFile(driveFileId));
      setEl('sync-st','✓ Drive'); setEl('sync-st2','✓ Drive');
      toast('Cargado desde Drive ✓', 2000);
    } else {
      ST = ensureState(lload()||initST());
      setEl('sync-st','nuevo'); setEl('sync-st2','nuevo');
    }
  } catch(e) {
    ST = ensureState(lload()||initST());
    setEl('sync-st','⚠ local'); setEl('sync-st2','⚠ local');
  }
  setLoadingProgress(100,'Listo');
  finishBoot();
}

function bootLocal() {
  setLoadingProgress(60,'Cargando datos locales...');
  ST = ensureState(lload()||initST());
  setEl('sync-st','local'); setEl('sync-st2','local');
  setLoadingProgress(100,'Listo');
  finishBoot();
}

let _booted = false;
function finishBoot() {
  if(_booted) return; _booted=true;
  const loading=document.getElementById('loading');
  if(loading) loading.classList.add('hide');
  document.getElementById('pago-f').value = today();
  renderTC(); updateAll(); fetchTC().then(()=>{ renderTC(); updateAll(); });
  setInterval(updateTC, 30*60*1000);
  if(useGoogle){
    setInterval(async()=>{ try{ await refreshToken(); }catch(e){} }, 50*60*1000);
    setInterval(saveDrive, 3*60*1000);
  }
}

function skipAuth() { useGoogle=false; localStorage.removeItem('cf_ug'); bootLocal(); }

function startGoogle() {
  if(typeof google==='undefined'||!google.accounts){
    document.getElementById('auth-err').textContent='Cargando Google, intentá de nuevo...';
    setTimeout(()=>startGoogle(),2000); return;
  }
  doSignIn(false,'auth');
}

function reconectGoogle() {
  const btn=document.getElementById('reconect-btn');
  btn.textContent='Conectando...'; btn.disabled=true;
  document.getElementById('reconect-err').textContent='';
  doSignIn(false,'reconect');
}

function doSignIn(silent, errTarget) {
  silent=silent||false; errTarget=errTarget||'auth';
  const client = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: DRIVE_SCOPE,
    prompt: silent?'':'select_account',
    callback: async resp => {
      if(resp.error||!resp.access_token){
        if(errTarget==='reconect'){
          const btn=document.getElementById('reconect-btn');
          btn.textContent='Reconectar Google Drive'; btn.disabled=false;
          document.getElementById('reconect-err').textContent='Error: '+resp.error;
        } else {
          document.getElementById('auth-err').textContent='Error: '+resp.error;
        }
        return;
      }
      gToken=resp.access_token; useGoogle=true;
      saveToken(gToken); localStorage.setItem('cf_ug','1');
      hideAll(); showLoading();
      await bootDrive();
    }
  });
  client.requestAccessToken(silent?{prompt:''}:{});
}

/* ═══════════════════════════════════════════════════════════
   BOOT
═══════════════════════════════════════════════════════════ */
window.addEventListener('DOMContentLoaded', () => {
  // Modal overlay click
  const mo = document.getElementById('modal-overlay');
  if(mo) mo.addEventListener('click', e => { if(e.target.id==='modal-overlay') modalResolve(false); });

  const wasGoogle = localStorage.getItem('cf_ug')==='1';
  if(!wasGoogle){ showAuth(); return; }

  const cachedToken = loadToken();
  if(cachedToken){ gToken=cachedToken; useGoogle=true; bootDrive(); return; }

  // Try silent login
  let resolved = false;
  const done = fn => { if(resolved) return; resolved=true; fn(); };
  const hardTimeout = setTimeout(()=>done(showReconect), 8000);

  const trySilent = () => {
    if(typeof google==='undefined'||!google.accounts){ setTimeout(trySilent,500); return; }
    try {
      google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID, scope:DRIVE_SCOPE, prompt:'',
        callback: async resp => {
          clearTimeout(hardTimeout);
          if(resp.error||!resp.access_token){ done(showReconect); return; }
          gToken=resp.access_token; useGoogle=true; saveToken(gToken);
          done(()=>{});
          await bootDrive();
        }
      }).requestAccessToken({prompt:''});
    } catch(e){ clearTimeout(hardTimeout); done(showReconect); }
  };
  trySilent();
});
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
