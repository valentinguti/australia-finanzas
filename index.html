<!DOCTYPE html><!-- v2.1 FIXED -->
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Finanzas ¬∑ Australia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#FFFFFF;--bg1:#F7F6F3;--bg2:#EFEEEA;--bg3:#E4E3DD;
  --line:#E9E9E7;--line2:#D3D1CB;
  --ink:#37352F;--ink2:#4A4845;--ink3:#9B9A97;--ink4:#C4C3BE;
  --green:#0F7B6C;--green-bg:#EEF8F6;--green-b:#B3DED9;
  --red:#E03E3E;--red-bg:#FBF0F0;--red-b:#F4BEBE;
  --amber:#DFAB01;--amber-bg:#FBF8EE;--amber-b:#F0DFA0;
  --blue:#0B6E99;--blue-bg:#EEF5FA;--blue-b:#B3D4E8;
  --sans:'Inter',system-ui,sans-serif;
  --mono:'JetBrains Mono','Courier New',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{font-size:14px;-webkit-text-size-adjust:100%}
body{background:var(--bg);color:var(--ink);font-family:var(--sans);min-height:100vh;-webkit-font-smoothing:antialiased}

/* TOPBAR */
.topbar{background:var(--bg);border-bottom:1px solid var(--line);padding:0 20px;height:48px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200}
.brand{font-family:var(--sans);font-size:14px;font-weight:600;color:var(--ink);letter-spacing:-.2px;display:flex;align-items:center;gap:8px}
.topbar-right{display:flex;align-items:center;gap:10px}
.tc-chip{font-family:var(--mono);font-size:10px;color:var(--ink3);display:flex;align-items:center;gap:6px}
.tc-dot{width:5px;height:5px;border-radius:50%;background:#4ade80;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.tc-dot.live{animation:pulse 2s infinite}
.tc-val{color:var(--ink2);font-weight:600}
.sync-st{font-size:10px;color:#555;font-family:var(--mono)}
.sync-btn{background:none;border:1px solid #444;color:#888;font-family:var(--mono);font-size:10px;padding:3px 9px;cursor:pointer;border-radius:2px}
.sync-btn:active{background:#222}

/* TABNAV */
.tabnav{background:var(--bg);border-bottom:1px solid var(--line);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 12px;gap:0}
.tabnav::-webkit-scrollbar{display:none}
.tab{padding:10px 16px;font-family:var(--sans);font-size:13px;font-weight:500;color:var(--ink3);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:0}
.tab:hover{color:var(--ink2)}
.tab.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:600}

/* PAGES */
.pg{display:none;padding-bottom:100px;max-width:680px;margin:0 auto}
.pg.on{display:block}
.pg.fade-in{animation:fadeIn .15s ease forwards}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* SECTION HEADER */
.sh{padding:28px 20px 0}
.sh-row{display:flex;align-items:baseline;justify-content:space-between;border-bottom:1.5px solid var(--ink);padding-bottom:6px}
.sh-title{font-size:20px;font-weight:700;color:var(--ink);letter-spacing:-.4px}
.sh-sub{font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3)}
.sh-action{font-size:10px;color:var(--ink3);cursor:pointer;background:none;border:1px solid var(--line2);padding:3px 10px;font-family:var(--mono)}
.sh-action:active{background:var(--bg2)}

/* LEDGER */
.ledger{width:100%;border-collapse:collapse;font-size:13px}
.ledger-wrap{margin:16px 20px;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.ledger th{font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink4);padding:8px 16px;text-align:left;background:var(--bg1);border-bottom:1px solid var(--line2);white-space:nowrap}
.ledger th.r{text-align:right}
.ledger td{padding:10px 16px;border-bottom:1px solid var(--line);vertical-align:middle}
.ledger tr:last-child td{border-bottom:none}
.ledger tr.total td{background:var(--bg2);border-top:1.5px solid var(--ink);border-bottom:1.5px solid var(--ink);font-weight:600;color:var(--ink)}
.ledger tr.subtotal td{background:var(--bg1);font-weight:500;color:var(--ink);border-bottom:1px solid var(--line2)}
.ledger tr:hover:not(.total):not(.subtotal) td{background:var(--bg1)}
.num{text-align:right;font-variant-numeric:tabular-nums}
.pos{color:var(--green)}
.neg{color:var(--red)}
.dim{color:var(--ink3)}
.bold{font-weight:700!important;color:var(--ink)!important}
.italic{font-style:italic}
.label-cell{font-size:13px;color:var(--ink2);font-weight:500}

/* STAT ROW */
.statrow{display:grid;border-bottom:1px solid var(--line)}
.statrow-4{grid-template-columns:1fr 1fr 1fr 1fr}
.statrow-3{grid-template-columns:1fr 1fr 1fr}
.statrow-2{grid-template-columns:1fr 1fr}
.stat{padding:16px;border-right:1px solid var(--line);background:var(--bg)}
.statrow-4 .stat:nth-child(4n),.statrow-3 .stat:nth-child(3n),.statrow-2 .stat:nth-child(2n){border-right:none}
.stat-lbl{font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px}
.stat-val{font-family:var(--mono);font-size:18px;font-weight:700;letter-spacing:-.5px;line-height:1}
.stat-val.g{color:var(--green)}
.stat-val.r{color:var(--red)}
.stat-val.a{color:var(--amber)}
.stat-sub{font-family:var(--mono);font-size:10px;color:var(--ink3);margin-top:3px}

/* BAND */
.band{border-radius:8px;padding:20px;margin:12px 20px}
.band.g{background:var(--green-bg);border-left:3px solid var(--green)}
.band.r{background:var(--red-bg);border-left:3px solid var(--red)}
.band.a{color:var(--amber)}
.band.b{background:var(--blue-bg);border-left:3px solid var(--blue)}
.band.n{background:var(--bg1);border-left:3px solid var(--line2)}
.band-lbl{font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3);margin-bottom:8px}
.band-val{font-family:var(--mono);font-size:28px;font-weight:700;letter-spacing:-.8px;line-height:1;margin-bottom:4px}
.band.g .band-val{font-family:var(--mono);font-size:28px;font-weight:700;letter-spacing:-.8px;line-height:1;margin-bottom:4px}
.band.r .band-val{font-family:var(--mono);font-size:28px;font-weight:700;letter-spacing:-.8px;line-height:1;margin-bottom:4px}
.band.a .band-val{font-family:var(--mono);font-size:28px;font-weight:700;letter-spacing:-.8px;line-height:1;margin-bottom:4px}
.band.b .band-val{font-family:var(--mono);font-size:28px;font-weight:700;letter-spacing:-.8px;line-height:1;margin-bottom:4px}
.band-sub{font-family:var(--mono);font-size:10px;color:var(--ink3)}
.band-right{text-align:right}
.band-pct{font-family:var(--mono);font-size:28px;font-weight:700;color:var(--ink3)}

/* PROGRESS */
.progbar{height:3px;background:var(--line);overflow:hidden}
.progbar-fill{height:100%;background:var(--green);transition:width .8s ease}
.progbar-fill.a{color:var(--amber)}

/* MONTH STRIP */
.mstrip{background:var(--bg1);border-bottom:1px solid var(--line2);display:flex;overflow-x:auto;scrollbar-width:none}
.mstrip::-webkit-scrollbar{display:none}
.mtab{padding:8px 16px;font-family:var(--sans);font-size:12px;font-weight:500;color:var(--ink3);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s}
.mtab:hover{background:var(--bg2);color:var(--ink2)}
.mtab.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:600;background:transparent}
.mtab.has .mdot{position:absolute;top:6px;right:5px;width:4px;height:4px;border-radius:50%;background:var(--green)}

/* INPUTS */
.inp-num{background:transparent;border:none;border-bottom:1px solid transparent;font-family:var(--mono);font-size:12px;font-weight:500;color:var(--ink);text-align:right;width:100%;outline:none;padding:2px 0;-webkit-appearance:none}
.inp-num:focus{border-bottom-color:var(--blue);background:var(--bg2)}
.inp-num::placeholder{color:var(--line2);font-weight:300}
input[type=number]{-moz-appearance:textfield}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none}
.inp-text{background:transparent;border:none;border-bottom:1px solid transparent;font-family:var(--mono);font-size:11px;color:var(--ink2);font-weight:500;width:100%;outline:none;padding:2px 0}
.inp-text:focus{border-bottom-color:var(--line2)}
.inp-text::placeholder{color:var(--line)}
.inp-date{background:var(--bg1);border:1px solid var(--line2);font-family:var(--mono);font-size:12px;color:var(--ink);padding:8px 10px;outline:none;width:100%;-webkit-appearance:none}
.inp-date:focus{border-color:var(--ink3)}
.inp-big{background:var(--bg1);border:1px solid var(--line2);border-radius:6px;padding:10px 12px;font-family:var(--mono);font-size:18px;font-weight:600;color:var(--ink);width:100%;outline:none;-webkit-appearance:none;transition:border-color .15s}
.inp-big:focus{border-color:var(--ink);background:var(--bg)}
.inp-big::placeholder{font-weight:300;color:var(--ink4)}
.inp-line{background:transparent;border:none;border-bottom:1px solid var(--line2);padding:6px 0;font-family:var(--sans);font-size:14px;color:var(--ink);width:100%;outline:none}
.inp-line:focus{border-color:var(--ink2);background:var(--bg)}
.inp-line::placeholder{color:var(--ink4);font-weight:300}

/* WEEK/HOURS GRIDS */
.week-grid{display:grid;grid-template-columns:repeat(5,1fr);border-bottom:1px solid var(--line)}
.week-cell{border-right:1px solid var(--line);padding:10px 6px;text-align:center}
.week-cell:last-child{border-right:none}
.week-lbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--ink4);margin-bottom:5px}
.week-inp{width:100%;background:transparent;border:none;border-bottom:1px solid transparent;font-family:var(--mono);font-size:13px;font-weight:600;color:var(--green);text-align:center;outline:none;-webkit-appearance:none;padding:2px 0}
.week-inp:focus{border-bottom-color:var(--green);background:var(--green-bg)}
.week-inp::placeholder{color:var(--line2);font-weight:300;font-size:11px}
.hrs-grid{display:grid;grid-template-columns:repeat(5,1fr);border-bottom:1px solid var(--line)}
.hrs-cell{border-right:1px solid var(--line);padding:8px 6px;text-align:center}
.hrs-cell:last-child{border-right:none}
.hrs-inp{width:100%;background:transparent;border:none;border-bottom:1px solid transparent;font-family:var(--mono);font-size:12px;font-weight:500;color:var(--blue);text-align:center;outline:none;-webkit-appearance:none;padding:2px 0}
.hrs-inp:focus{border-bottom-color:var(--blue);background:var(--blue-bg)}
.hrs-inp::placeholder{color:var(--line2);font-weight:300}

/* BUTTONS */
.btn{background:var(--ink);color:var(--bg);border:none;padding:9px 18px;font-family:var(--sans);font-size:13px;font-weight:500;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:opacity .15s}
.btn:active{opacity:.8}
.btn.g{background:var(--green)}
.btn.r{background:var(--red);color:#fff}
.btn.outline{background:transparent;border:1px solid var(--line2);color:var(--ink)}
.btn.sm{padding:4px 10px;font-size:10px}
.btn.full{width:100%;padding:12px}

/* FORM */
.form-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg{margin-bottom:16px}
.fg label{display:block;font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px}

/* PAY ROW */
.pay-row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:10px 16px;border-bottom:1px solid var(--line)}
.pay-date{font-family:var(--mono);font-size:9px;color:var(--ink4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.pay-desc{font-size:12px;color:var(--ink3)}
.pay-aud{font-family:var(--mono);font-size:15px;font-weight:700;color:var(--green);text-align:right}
.pay-usd{font-family:var(--mono);font-size:9px;color:var(--ink4);text-align:right;margin-top:1px}

/* META ROW */
.meta-row{padding:12px 16px;border-bottom:1px solid var(--line)}
.meta-name{font-size:14px;font-weight:600;color:var(--ink);letter-spacing:-.2px}
.meta-bar-wrap{height:4px;background:var(--line);border-radius:2px;overflow:hidden;margin-bottom:6px}
/* LOG ENTRIES */
.log-wrap{padding:4px 0 8px;border-bottom:1px solid var(--line)}
.log-entry{display:flex;align-items:center;gap:8px;padding:5px 16px;font-family:var(--mono);font-size:11px;animation:slideIn .18s ease}
.log-entry:hover{background:var(--bg1)}
.log-date{color:var(--ink3);min-width:38px;font-size:10px}
.log-note{color:var(--ink3);flex:1;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.log-amt{color:var(--ink2);font-weight:600;min-width:64px;text-align:right}
.log-del{color:var(--ink4);cursor:pointer;padding:2px 6px;border-radius:4px;font-size:11px;background:none;border:none;transition:all .15s;flex-shrink:0}
.log-del:hover{background:var(--red-bg);color:var(--red)}
.log-more{padding:4px 16px 8px;font-family:var(--mono);font-size:10px;color:var(--blue);cursor:pointer;display:flex;align-items:center;gap:4px}
.log-more:hover{text-decoration:underline}
.cat-row{display:flex;align-items:center;padding:10px 16px;gap:8px;border-bottom:1px solid var(--line);cursor:default}
.cat-lbl{font-size:13px;color:var(--ink2);font-weight:500;flex:1}
.cat-total{font-family:var(--mono);font-size:13px;font-weight:600;color:var(--ink);min-width:80px;text-align:right}
.cat-add{background:var(--bg2);border:none;border-radius:6px;padding:4px 10px;font-family:var(--mono);font-size:11px;font-weight:600;color:var(--blue);cursor:pointer;white-space:nowrap;transition:all .15s}
.cat-add:hover{background:var(--blue-bg)}
.add-row{display:none;padding:8px 16px 12px;background:var(--bg1);border-bottom:1px solid var(--line);gap:8px;align-items:center;flex-wrap:wrap}
.add-row.open{display:flex;animation:slideIn .15s ease}
.add-amt{background:var(--bg);border:1px solid var(--line2);border-radius:6px;padding:7px 10px;font-family:var(--mono);font-size:14px;font-weight:600;color:var(--ink);width:110px;outline:none;-webkit-appearance:none}
.add-amt:focus{border-color:var(--ink)}
.add-note{background:var(--bg);border:1px solid var(--line2);border-radius:6px;padding:7px 10px;font-family:var(--sans);font-size:12px;color:var(--ink);flex:1;min-width:80px;outline:none}
.add-note:focus{border-color:var(--ink)}
.add-ok{background:var(--ink);color:var(--bg);border:none;border-radius:6px;padding:7px 14px;font-family:var(--mono);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap}
.add-cancel{background:none;border:none;color:var(--ink3);font-size:18px;cursor:pointer;padding:4px 6px}
@keyframes slideIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.meta-bar-fill{height:100%;transition:width .6s ease}
.meta-info{display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)}

/* FOOTER */
.fbar{position:fixed;bottom:0;left:0;right:0;background:var(--ink);display:grid;grid-template-columns:1fr 1px 1fr 1px 1fr;z-index:199;padding-bottom:env(safe-area-inset-bottom)}
.fbar-div{background:#333}
.fi{padding:10px 14px;text-align:center}
.fi-lbl{font-family:var(--mono);font-size:8px;letter-spacing:1.2px;text-transform:uppercase;color:#555;margin-bottom:3px}
.fi-val{font-family:var(--mono);font-size:14px;font-weight:700;color:#aaa}
.fi-val.g{color:#4ade80}
.fi-val.r{color:#f87171}
.fi-val.a{color:var(--amber)}

/* MISC */
.spacer{height:16px}
.pad{padding:14px 16px}
.empty{text-align:center;padding:32px 20px;color:var(--ink4);font-size:12px;font-family:var(--mono)}
.chip{font-family:var(--mono);font-size:11px;font-weight:600;padding:3px 8px;border-radius:4px;background:var(--bg2);color:var(--ink3)}
.chip.g{background:var(--green-bg);color:var(--green)}
.chip.r{background:var(--red-bg);color:var(--red)}
.chip.a{color:var(--amber)}

/* TOAST */
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--ink);color:var(--bg);font-family:var(--sans);font-size:12px;font-weight:500;padding:8px 16px;border-radius:6px;opacity:0;transition:all .2s;z-index:9000;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.15)}
#toast.show{opacity:1}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
#loading.hide{display:none}
.spin{width:18px;height:18px;border:2px solid var(--line2);border-top-color:var(--ink);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-lbl{font-family:var(--mono);font-size:11px;color:var(--ink4)}

/* AUTH */
#auth{position:fixed;inset:0;background:var(--bg);z-index:8900;display:flex;align-items:center;justify-content:center;padding:24px}
.auth-box{background:var(--bg);border:1px solid var(--line);border-radius:12px;padding:40px 32px;width:100%;max-width:360px;text-align:center;box-shadow:0 4px 24px rgba(0,0,0,.06)}
.auth-flag{font-size:24px;margin-bottom:20px;display:block}
.auth-title{font-size:22px;font-weight:700;color:var(--ink);letter-spacing:-.4px;margin-bottom:8px}
.auth-sub{font-size:12px;color:var(--ink3);line-height:1.7;margin-bottom:28px}
.auth-gbtn{width:100%;background:var(--ink);color:#fff;border:none;padding:13px 18px;cursor:pointer;font-family:var(--mono);font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px;letter-spacing:.3px}
.auth-gbtn:active{opacity:.9}
.auth-skip{width:100%;background:none;border:1px solid var(--line2);color:var(--ink4);font-family:var(--mono);font-size:10px;padding:10px;cursor:pointer;letter-spacing:.5px}
.auth-skip:active{background:var(--bg2)}
.auth-note{margin-top:20px;font-family:var(--mono);font-size:10px;color:var(--ink4);line-height:1.7;border-top:1px solid var(--line);padding-top:16px}
.auth-err{min-height:16px;font-family:var(--mono);font-size:11px;color:var(--red);margin-top:10px}
</style>
</head>
<body>
<div id="loading">
  <div style="text-align:center">
    <div style="font-size:48px;margin-bottom:16px">üá¶üá∫</div>
    <div style="font-family:var(--mono);font-size:18px;font-weight:700;color:var(--ink);letter-spacing:-.3px;margin-bottom:6px">Finanzas ¬∑ AU</div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--ink4);margin-bottom:28px" id="loading-msg">Cargando...</div>
    <div style="width:160px;height:2px;background:var(--line);overflow:hidden;margin:0 auto">
      <div id="loading-bar" style="height:100%;background:var(--ink);width:0%;transition:width .4s ease"></div>
    </div>
  </div>
</div>
<div id="toast"></div>

<!-- AUTH ‚Äî pantalla completa (primera vez) -->
<div id="auth" style="display:none">
  <div class="auth-box">
    <span class="auth-flag">üá¶üá∫</span>
    <div class="auth-title">Finanzas ¬∑ AU</div>
    <div class="auth-sub">Control financiero personal. Tus datos se guardan en tu Google Drive.</div>
    <button class="auth-gbtn" onclick="startGoogle()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#aaa"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#888"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#777"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#999"/>
      </svg>
      Iniciar sesi√≥n con Google
    </button>
    <button class="auth-skip" onclick="skipAuth()">Usar sin sincronizaci√≥n ‚Üí solo local</button>
    <div class="auth-err" id="auth-err"></div>
    <div class="auth-note">Solo accede a su propia carpeta en tu Drive. Tus datos no son visibles para nadie m√°s.</div>
  </div>
</div>

<!-- RECONECTAR ‚Äî aparece cuando el token expir√≥, sin pedir email/password -->
<div id="reconect" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:8900;align-items:center;justify-content:center;padding:24px">
  <div class="auth-box" style="text-align:center">
    <span style="font-size:32px;display:block;margin-bottom:16px">üîÑ</span>
    <div class="auth-title" style="font-size:16px;margin-bottom:8px">Sesi√≥n expirada</div>
    <div style="font-size:12px;color:var(--ink3);margin-bottom:24px;line-height:1.6">Tu sesi√≥n de Google venci√≥.<br>Toc√° el bot√≥n para reconectar.</div>
    <button class="auth-gbtn" onclick="reconectGoogle()" id="reconect-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#aaa"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#888"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#777"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#999"/>
      </svg>
      Reconectar Google Drive
    </button>
    <button class="auth-skip" style="margin-top:10px" onclick="skipAuth()">Continuar sin sincronizaci√≥n</button>
    <div class="auth-err" id="reconect-err"></div>
  </div>
</div>

<!-- APP -->
<div class="topbar">
  <div class="brand">üá¶üá∫ &nbsp;Finanzas ¬∑ Australia</div>
  <div class="topbar-right">
    <div class="tc-chip">
      <div class="tc-dot live" id="tc-dot"></div>
      <span class="tc-val"><span id="tc-v">‚Äî</span> <span style="color:#555;font-size:9px">USD</span></span>
      <span style="color:#444;font-size:9px;margin:0 2px">¬∑</span>
      <span class="tc-val"><span id="tc-inv">‚Äî</span> <span style="color:#555;font-size:9px">AUD</span></span>
    </div>
    <span class="sync-st" id="sync-st">‚Äî</span>
    <button class="sync-btn" onclick="syncNow()">‚Üë‚Üì</button>
  </div>
</div>

<div class="tabnav">
  <div class="tab on" onclick="go('dash',this)">Resumen</div>
  <div class="tab" onclick="go('deuda',this)">Deuda</div>
  <div class="tab" onclick="go('inv',this)">Inversi√≥n</div>
  <div class="tab" onclick="go('meses',this)">Meses</div>
  <div class="tab" onclick="go('metas',this)">Metas</div>
  <div class="tab" onclick="go('anual',this)">Anual</div>
</div>

<!-- RESUMEN -->
<div class="pg on" id="pg-dash">
  <div class="sh"><div class="sh-row">
    <span class="sh-title">Resumen 2026</span>
    <span class="sh-sub" id="d-period">‚Äî</span>
  </div></div>
  <div class="statrow statrow-4">
    <div class="stat"><div class="stat-lbl">Ganado</div><div class="stat-val g" id="d-ga">‚Äî</div><div class="stat-sub" id="d-gu">‚Äî</div></div>
    <div class="stat"><div class="stat-lbl">Gastado</div><div class="stat-val r" id="d-gsa">‚Äî</div><div class="stat-sub" id="d-gsu">‚Äî</div></div>
    <div class="stat"><div class="stat-lbl">Ahorro</div><div class="stat-val" id="d-aa">‚Äî</div><div class="stat-sub" id="d-au">‚Äî</div></div>
    <div class="stat"><div class="stat-lbl">Inversi√≥n</div><div class="stat-val a" id="d-ia">‚Äî</div><div class="stat-sub" id="d-iu">‚Äî</div></div>
  </div>
  <div class="band g">
    <div>
      <div class="band-lbl">Caja disponible</div>
      <div class="band-val" id="d-ca">AUD ‚Äî</div>
      <div class="band-sub">Ahorro acumulado ‚àí pagos a padres</div>
    </div>
    <div class="band-right">
      <div class="stat-lbl">En USD</div>
      <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--green)" id="d-cau">‚Äî</div>
    </div>
  </div>
  <div class="band r">
    <div>
      <div class="band-lbl">Deuda pendiente ¬∑ padres</div>
      <div class="band-val" id="d-da">AUD ‚Äî</div>
      <div class="band-sub" id="d-du">USD ‚Äî</div>
    </div>
    <div class="band-right">
      <div class="band-pct" id="d-dapct">0%</div>
      <div class="band-sub">saldado</div>
    </div>
  </div>
  <div class="progbar"><div class="progbar-fill a" id="d-pbar" style="width:0%"></div></div>

  <div class="spacer"></div>
  <div class="sh"><div class="sh-row">
    <span class="sh-title">Tipo de cambio</span>
    <span class="sh-sub">1 AUD ‚Üí USD</span>
  </div></div>
  <div style="padding:12px 16px;border-bottom:1px solid var(--line)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <span style="font-family:var(--mono);font-size:11px;color:var(--ink4);white-space:nowrap">1 AUD =</span>
      <input type="number" step="0.0001" inputmode="decimal" id="tc-inp" class="inp-big" style="width:110px" placeholder="0.6300" oninput="manualTC()">
      <span style="font-family:var(--mono);font-size:11px;color:var(--ink4)">USD <span id="tc-src" style="font-style:italic;color:var(--ink4);font-size:10px">auto</span></span>
    </div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--ink3);padding:6px 0">
      1 USD = <strong id="tc-inv-dash">‚Äî</strong> AUD
    </div>
  </div>

  <div class="spacer"></div>
  <div class="sh"><div class="sh-row">
    <span class="sh-title">√öltimo mes activo</span>
    <span id="d-lm-name" class="sh-sub">‚Äî</span>
  </div></div>
  <div id="d-last-content"><div class="empty">Sin datos a√∫n</div></div>
</div>

<!-- DEUDA -->
<div class="pg" id="pg-deuda">
  <div class="sh" style="margin-top:16px"><div class="sh-row">
    <span class="sh-title">Deuda con padres</span>
    <span id="deu-chip" class="chip r">AUD 0</span>
  </div></div>
  <div class="ledger-wrap"><table class="ledger">
    <thead><tr><th>Concepto</th><th class="r">AUD</th><th class="r">USD</th></tr></thead>
    <tbody>
      <tr><td class="label-cell italic">Inversi√≥n inicial</td><td class="num dim" id="dl-inv">‚Äî</td><td class="num dim" id="dl-invu">‚Äî</td></tr>
      <tr>
        <td class="label-cell italic">Apoyo de padres</td>
        <td class="num dim" style="padding:6px 16px">
          <input type="number" step="0.01" inputmode="decimal" class="inp-num" id="apoyo-inp"
            style="width:90px;text-align:right;font-size:12px"
            placeholder="0.00" oninput="ST.apoyo=+this.value||0;sched();updDeuda();updDash();updFoot();">
        </td>
        <td class="num dim" id="dl-gsiu">‚Äî</td>
      </tr>
      <tr class="subtotal"><td class="bold">Deuda bruta</td><td class="num neg" id="dl-bruta">‚Äî</td><td class="num neg" id="dl-brutau">‚Äî</td></tr>
      <tr><td class="label-cell italic">Pagos realizados</td><td class="num pos" id="dl-pag">‚Äî</td><td class="num pos" id="dl-pagu">‚Äî</td></tr>
      <tr class="total"><td class="bold">Deuda pendiente</td><td class="num neg bold" id="dl-pend">‚Äî</td><td class="num neg" id="dl-pendu">‚Äî</td></tr>
    </tbody>
  </table></div>
  <div style="padding:8px 16px 12px">
    <div class="progbar"><div class="progbar-fill" id="deu-bar" style="width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;margin-top:5px;font-family:var(--mono);font-size:10px;color:var(--ink4)">
      <span>Pagado</span><span id="deu-pct">0.0%</span>
    </div>
  </div>
  <div class="band g">
    <div>
      <div class="band-lbl">Caja disponible</div>
      <div class="band-val" id="deu-ca">AUD ‚Äî</div>
    </div>
    <div style="text-align:right;font-family:var(--mono);font-size:13px;color:var(--green)" id="deu-cau">USD ‚Äî</div>
  </div>

  <div class="spacer"></div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Registrar pago</span></div></div>
  <div style="padding:14px 16px;border-bottom:1px solid var(--line)">
    <div class="form-2" style="margin-bottom:10px">
      <div class="fg" style="margin:0"><label>Fecha</label><input type="date" class="inp-date" id="pago-f"></div>
      <div class="fg" style="margin:0"><label>Monto AUD</label><input type="number" step="0.01" inputmode="decimal" class="inp-big" id="pago-m" placeholder="0.00" oninput="updDeuda()"></div>
    </div>
    <div class="fg"><label>Descripci√≥n</label><input type="text" id="pago-d" class="inp-line" placeholder="Ej: Transferencia total"></div>
    <div id="pago-preview" style="font-family:var(--mono);font-size:11px;color:var(--ink4);margin-bottom:10px;min-height:16px"></div>
    <button class="btn g full" onclick="regPago()">Registrar pago ‚Üí</button>
  </div>

  <div class="sh"><div class="sh-row">
    <span class="sh-title">Historial de pagos</span>
    <span id="deu-np" class="sh-sub">0 pagos</span>
  </div></div>
  <div id="pag-list"><div class="empty">Sin pagos registrados.</div></div>

  <div class="sh"><div class="sh-row"><span class="sh-title">Calculadora de devoluci√≥n</span></div></div>
  <div style="padding:14px 16px;border-bottom:1px solid var(--line)">
    <div class="form-2" style="margin-bottom:8px">
      <div class="fg" style="margin:0"><label>Meses para saldar</label><input type="number" inputmode="numeric" class="inp-big" id="cuota-m" placeholder="12" oninput="calcCuota()"></div>
      <div class="fg" style="margin:0"><label>Cuota mensual</label>
        <div style="background:var(--green-bg);border:1px solid var(--green-b);padding:10px 12px;text-align:right;font-family:var(--mono);font-size:18px;font-weight:700;color:var(--green)" id="cuota-r">‚Äî</div>
      </div>
    </div>
    <div id="cuota-s" style="font-family:var(--mono);font-size:10px;color:var(--ink4);font-style:italic;margin-top:4px"></div>
  </div>

  <div class="sh"><div class="sh-row"><span class="sh-title">Notas</span></div></div>
  <div style="padding:14px 16px;border-bottom:1px solid var(--line)">
    <textarea id="nota" style="width:100%;background:none;border:none;font-family:var(--mono);font-size:12px;color:var(--ink3);outline:none;resize:vertical;min-height:60px;line-height:1.7" placeholder="Sin plazo fijo. Sin intereses..." oninput="ST.nota=this.value;sched()"></textarea>
  </div>
</div>

<!-- INVERSI√ìN -->
<div class="pg" id="pg-inv">
  <div class="sh" style="margin-top:16px"><div class="sh-row">
    <span class="sh-title">Inversi√≥n inicial</span>
    <button class="sh-action" onclick="addInv()">+ fila</button>
  </div></div>
  <div class="ledger-wrap"><table class="ledger">
    <thead><tr><th>Concepto</th><th class="r">USD</th><th class="r">AUD</th><th>Nota</th><th></th></tr></thead>
    <tbody id="inv-body"></tbody>
    <tfoot><tr class="total">
      <td class="bold">Total inversi√≥n</td>
      <td class="num a bold" id="inv-tu">USD 0.00</td>
      <td class="num a bold" id="inv-ta">AUD 0.00</td>
      <td colspan="2"></td>
    </tr></tfoot>
  </table></div>
</div>

<!-- MESES -->
<div class="pg" id="pg-meses">
  <div class="mstrip" id="mstrip"></div>
  <div id="mes-cnt"></div>
</div>

<!-- METAS -->
<div class="pg" id="pg-metas">
  <div class="sh" style="margin-top:16px"><div class="sh-row">
    <span class="sh-title">Metas de ahorro</span>
    <button class="sh-action" onclick="addMeta()">+ meta</button>
  </div></div>
  <div class="band b">
    <div>
      <div class="band-lbl">Caja disponible</div>
      <div class="band-val" id="meta-caja">AUD 0</div>
    </div>
    <div class="band-right">
      <div class="stat-lbl">Libre (sin asignar)</div>
      <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--blue)" id="meta-libre">AUD 0</div>
    </div>
  </div>
  <div id="metas-list"><div class="empty">No hay metas. Us√° + meta para agregar.</div></div>

  <div class="spacer"></div>
  <div class="sh"><div class="sh-row"><span class="sh-title">Nueva meta</span></div></div>
  <div style="padding:14px 16px;border-bottom:1px solid var(--line)">
    <div class="fg"><label>Nombre</label><input type="text" id="meta-nombre" class="inp-line" placeholder="Ej: Moto, Viaje, Laptop..."></div>
    <div class="form-2">
      <div class="fg" style="margin:0"><label>Objetivo AUD</label><input type="number" step="1" inputmode="numeric" class="inp-big" id="meta-obj" placeholder="0"></div>
      <div class="fg" style="margin:0"><label>Asignado AUD</label><input type="number" step="1" inputmode="numeric" class="inp-big" id="meta-asig" placeholder="0"></div>
    </div>
    <div style="margin-top:10px"><button class="btn full" onclick="addMeta()">Agregar ‚Üí</button></div>
  </div>
</div>

<!-- ANUAL -->
<div class="pg" id="pg-anual">
  <div class="sh" style="margin-top:16px"><div class="sh-row">
    <span class="sh-title">Balance anual 2026</span>
    <span class="sh-sub">12 meses</span>
  </div></div>
  <div class="statrow statrow-4">
    <div class="stat"><div class="stat-lbl">Mejor mes</div><div class="stat-val g" style="font-size:14px" id="rs-mej">‚Äî</div><div class="stat-sub" id="rs-mejm">‚Äî</div></div>
    <div class="stat"><div class="stat-lbl">Peor mes</div><div class="stat-val r" style="font-size:14px" id="rs-peor">‚Äî</div><div class="stat-sub" id="rs-peorm">‚Äî</div></div>
    <div class="stat"><div class="stat-lbl">Meses activos</div><div class="stat-val" style="font-size:14px" id="rs-act">0/12</div></div>
    <div class="stat"><div class="stat-lbl">Tarifa real</div><div class="stat-val" style="font-size:14px" id="rs-tarifa">‚Äî</div><div class="stat-sub">AUD/hora</div></div>
  </div>
  <div class="sh"><div class="sh-row">
    <span class="sh-title">Gastos por categor√≠a</span>
    <span class="sh-sub" id="rs-gtotal">AUD 0 total</span>
  </div></div>
  <div id="cat-chart" style="padding:4px 0;border-bottom:1px solid var(--line)"></div>
  <div class="sh"><div class="sh-row">
    <span class="sh-title">Evoluci√≥n mensual</span>
    <span class="sh-sub">ingresos ¬∑ gastos ¬∑ ahorro</span>
  </div></div>
  <div style="padding:14px 16px 12px;border-bottom:1px solid var(--line);overflow-x:auto">
    <canvas id="bar-chart" height="130" style="width:100%;min-width:300px;display:block"></canvas>
  </div>
  <div class="ledger-wrap"><table class="ledger">
    <thead><tr><th>Mes</th><th class="r">Ingresos</th><th class="r">Gastos</th><th class="r">Ahorro</th><th class="r">USD</th></tr></thead>
    <tbody id="rs-body"></tbody>
    <tfoot>
      <tr class="total">
        <td class="bold">Total</td>
        <td class="num pos bold" id="rs-ti">‚Äî</td>
        <td class="num neg bold" id="rs-tg">‚Äî</td>
        <td class="num bold" id="rs-ta">‚Äî</td>
        <td class="num bold" id="rs-tu">‚Äî</td>
      </tr>
      <tr class="subtotal">
        <td class="italic dim">Promedio</td>
        <td class="num dim" id="rs-pi">‚Äî</td>
        <td class="num dim" id="rs-pg">‚Äî</td>
        <td class="num dim" id="rs-pa">‚Äî</td>
        <td class="num dim" id="rs-pau">‚Äî</td>
      </tr>
    </tfoot>
  </table></div>
</div>

<!-- FOOTER -->
<div class="fbar">
  <div class="fi"><div class="fi-lbl">Ahorro</div><div class="fi-val g" id="f-a">$0</div></div>
  <div class="fbar-div"></div>
  <div class="fi"><div class="fi-lbl">Caja</div><div class="fi-val a" id="f-c">$0</div></div>
  <div class="fbar-div"></div>
  <div class="fi"><div class="fi-lbl">Deuda</div><div class="fi-val r" id="f-d">$0</div></div>
</div>

<!-- MODAL CONFIRMACI√ìN -->
<div id="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9500;align-items:flex-end;justify-content:center;padding:0">
  <div id="modal-box" style="background:var(--bg);width:100%;max-width:420px;padding:24px 20px 32px;border-radius:12px 12px 0 0">
    <div id="modal-title" style="font-family:var(--mono);font-size:15px;font-weight:700;color:var(--ink);margin-bottom:8px"></div>
    <div id="modal-msg" style="font-size:13px;color:var(--ink3);line-height:1.6;margin-bottom:24px"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <button class="btn outline" style="padding:13px" onclick="modalResolve(false)">Cancelar</button>
      <button class="btn" id="modal-confirm-btn" style="padding:13px" onclick="modalResolve(true)">Confirmar</button>
    </div>
  </div>
</div>
<script src="https://accounts.google.com/gsi/client" async></script>
<script>
/* ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê */
const DRIVE_FILE='cf_australia_2026.json';
const DRIVE_SCOPE='https://www.googleapis.com/auth/drive.appdata';
const CLIENT_ID='181059148005-jbpua2ag12jpvh6niff7jovlniklogu3.apps.googleusercontent.com';
const MN=['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
const MS=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const GK=['arriendo','comida','transporte','servicios','telefono','salud','seguros','ropa','entretenimiento','viajes','cuidado','gym','otros'];
const GL=['Arriendo / Vivienda','Comida / Supermercado','Transporte','Servicios','Tel√©fono','Salud','Seguros','Ropa','Entretenimiento','Viajes','Cuidado personal','Gym','Otros'];
const IK=['freelance','bonificacion','familia','otros'];
const IL=['Freelance / Extra','Bonificaci√≥n','Familia','Otros'];
const DEF_INV=[
  {c:'Visa / Documentos',u:158,a:0,d:''},
  {c:'Pasaje A√©reo',u:1727,a:0,d:''},
  {c:'Seguro M√©dico',u:230,a:0,d:''},
  {c:'Dep√≥sito vivienda',u:0,a:0,d:''},
  {c:'Muebles / Hogar',u:0,a:0,d:''},
  {c:'Tel√©fono / SIM',u:268,a:0,d:'Plan local + gastos llegada'},
  {c:'Transporte setup',u:0,a:0,d:''},
  {c:'White Card / Forklift',u:0,a:0,d:'Licencia trabajo en altura/maquinaria'},
  {c:'Fondo emergencia',u:0,a:0,d:''},
];

function defM(){
  const g={},ing={};
  GK.forEach(k=>{g[k]=[];});
  IK.forEach(k=>{ing[k]=[];});
  return{semanas:[0,0,0,0,0],horas:[0,0,0,0,0],ingresos:ing,gastos:g};
}
// Sum entries ‚Äî handles both array (new) and number (migration)
const gVal=entries=>Array.isArray(entries)?entries.reduce((s,e)=>s+(+e.m||0),0):(+entries||0);
const today=()=>new Date().toISOString().slice(0,10);

/* ‚îÄ‚îÄ LOG HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// Render log entries for a category (gastos or ingresos)
function renderLog(entries, mi, field, key, maxShow=5){
  if(!Array.isArray(entries)||entries.length===0) return '';
  const sorted=[...entries].reverse(); // newest first
  const visible=sorted.slice(0,maxShow);
  const hidden=sorted.length-maxShow;
  const rows=visible.map((e,ei)=>{
    const realIdx=entries.length-1-ei; // index in original array
    return `<div class="log-entry">
      <span class="log-date">${fDateShort(e.d)}</span>
      <span class="log-note">${esc(e.n||'')}</span>
      <span class="log-amt">+${fA2(e.m)}</span>
      <button class="log-del" onclick="delEntry(${mi},'${field}','${key}',${realIdx})" title="Eliminar">√ó</button>
    </div>`;
  }).join('');
  const moreBtn=hidden>0?`<div class="log-more" onclick="toggleLog('log-${field}-${mi}-${key}',this)">‚ñ∏ ver ${hidden} m√°s</div>`:'';
  return `<div class="log-wrap" id="log-${field}-${mi}-${key}">${rows}${moreBtn}</div>`;
}

function toggleLog(id, btn){
  const wrap=document.getElementById(id);
  if(!wrap)return;
  const mi=parseInt(id.split('-')[2]);
  const field=id.split('-')[1];
  const key=id.split('-').slice(3).join('-');
  const entries=ST.months[mi][field][key];
  if(!Array.isArray(entries))return;
  const sorted=[...entries].reverse();
  const allRows=sorted.map((e,ei)=>{
    const realIdx=entries.length-1-ei;
    return `<div class="log-entry">
      <span class="log-date">${fDateShort(e.d)}</span>
      <span class="log-note">${esc(e.n||'')}</span>
      <span class="log-amt">+${fA2(e.m)}</span>
      <button class="log-del" onclick="delEntry(${mi},'${field}','${key}',${realIdx})" title="Eliminar">√ó</button>
    </div>`;
  }).join('');
  wrap.innerHTML=allRows+`<div class="log-more" onclick="toggleLog('${id}',this)">‚ñ¥ ver menos</div>`;
  btn.textContent='‚ñ¥ ver menos';
}

function delEntry(mi, field, key, idx){
  const arr=ST.months[mi][field][key];
  if(!arr||!arr[idx])return;
  arr.splice(idx,1);
  sched();
  renderMes();
  updMesInline(mi);
}

// Open/close add row for a category
function openAdd(id){
  const row=document.getElementById('add-'+id);
  if(!row)return;
  const isOpen=row.classList.contains('open');
  // Close all open add rows first
  document.querySelectorAll('.add-row.open').forEach(r=>r.classList.remove('open'));
  if(!isOpen){
    row.classList.add('open');
    // Focus amount input
    const inp=row.querySelector('.add-amt');
    if(inp)setTimeout(()=>inp.focus(),50);
  }
}

function submitAdd(mi, field, key, amtId, noteId){
  const amt=+(document.getElementById(amtId).value)||0;
  const note=document.getElementById(noteId).value.trim();
  if(amt<=0)return;
  const arr=ST.months[mi][field][key];
  if(!Array.isArray(arr))ST.months[mi][field][key]=[];
  ST.months[mi][field][key].push({d:today(),m:amt,n:note});
  sched();
  renderMes();
  updMesInline(mi);
  if(navigator.vibrate)navigator.vibrate(10);
}
const fDateShort=d=>{if(!d)return'';const p=d.split('-');return p[2]+'/'+p[1];}; 
function initST(){
  return{
    tc:.6300,tcTime:'',nota:'',pagos:[],metas:[],apoyo:0,
    invItems:JSON.parse(JSON.stringify(DEF_INV)),
    months:MN.map((_,i)=>{
      const m=defM();
      if(i===1){m.gastos.comida=[{d:'2026-02-01',m:132.51,n:'S√∫per semanal'}];m.gastos.transporte=[{d:'2026-02-01',m:45,n:''}];m.gastos.cuidado=[{d:'2026-02-01',m:17,n:''}];m.gastos.otros=[{d:'2026-02-01',m:123,n:'Afeitadora / Kebap'}];}
      return m;
    })
  };
}

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let ST={},saveT=null,gToken=null,driveFileId=null,useGoogle=false;

/* ‚ïê‚ïê‚ïê LOCAL STORAGE ‚ïê‚ïê‚ïê */
const lsave=()=>{try{localStorage.setItem('cf_aus26',JSON.stringify(ST));}catch(e){}};
const lload=()=>{try{const d=localStorage.getItem('cf_aus26');return d?JSON.parse(d):null;}catch(e){return null;}};

/* ‚ïê‚ïê‚ïê GOOGLE DRIVE ‚ïê‚ïê‚ïê */
function skipAuth(){
  useGoogle=false;localStorage.removeItem('cf_ug');
  document.getElementById('auth').style.display='none';bootLocal();
}
async function refreshToken(){
  return new Promise((resolve,reject)=>{
    if(typeof google==='undefined'||!google.accounts){reject('no google');return;}
    const client=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID,scope:DRIVE_SCOPE,prompt:'',
      callback:resp=>{
        if(resp.error){reject(resp.error);return;}
        gToken=resp.access_token;resolve();
      }
    });
    client.requestAccessToken({prompt:''});
  });
}
async function driveReq(url,opts={},retry=true){
  const res=await fetch(url,{...opts,headers:{'Authorization':'Bearer '+gToken,...(opts.headers||{})}});
  if(res.status===401&&retry){
    try{await refreshToken();}catch(e){useGoogle=false;localStorage.removeItem('cf_ug');setEl('sync-st','‚ö† sesi√≥n');throw new Error('Token expirado');}
    return driveReq(url,opts,false);
  }
  if(!res.ok)throw new Error('Drive '+res.status);return res;
}
async function findFile(){
  const r=await driveReq(`https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${DRIVE_FILE}'&fields=files(id)`);
  const d=await r.json();return d.files?.[0]?.id||null;
}
async function readFile(id){
  const r=await driveReq(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`);return await r.json();
}
async function createFile(c){
  const meta={name:DRIVE_FILE,parents:['appDataFolder']};
  const form=new FormData();
  form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
  form.append('file',new Blob([JSON.stringify(c)],{type:'application/json'}));
  const r=await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',body:form});
  return(await r.json()).id;
}
async function updateFile(id,c){
  await driveReq(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`,
    {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(c)});
}
async function saveDrive(){
  try{
    setEl('sync-st','‚Üë...');
    if(!driveFileId)driveFileId=await findFile();
    if(driveFileId)await updateFile(driveFileId,ST);
    else driveFileId=await createFile(ST);
    const t=new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
    setEl('sync-st','‚úì '+t);lsave();
  }catch(e){setEl('sync-st','‚ö† local');lsave();}
}
async function syncNow(){
  if(useGoogle){toast('Guardando...',900);await saveDrive();toast('Sincronizado ‚úì');}
  else{lsave();toast('Guardado ‚úì');}
}

/* ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê */
function ensureState(s){
  if(!s.pagos)s.pagos=[];
  if(s.apoyo===undefined)s.apoyo=0;
  if(!s.nota)s.nota='';
  if(!s.metas)s.metas=[];
  if(!s.months||s.months.length!==12)s.months=initST().months;
  if(!s.invItems)s.invItems=JSON.parse(JSON.stringify(DEF_INV));
  // Migration: convert old number gastos/ingresos to array format
  if(s.months){
    s.months.forEach((m,mi)=>{
      const yr=2026, mnth=mi+1;
      const defDate=`${yr}-${String(mnth).padStart(2,'0')}-01`;
      GK.forEach(k=>{
        if(typeof m.gastos[k]==='number'&&m.gastos[k]>0){
          m.gastos[k]=[{d:defDate,m:m.gastos[k],n:m.notas?.(k)||''}];
        } else if(!Array.isArray(m.gastos[k])){
          m.gastos[k]=[];
        }
      });
      IK.forEach(k=>{
        if(typeof m.ingresos[k]==='number'&&m.ingresos[k]>0){
          m.ingresos[k]=[{d:defDate,m:m.ingresos[k],n:''}];
        } else if(!Array.isArray(m.ingresos[k])){
          m.ingresos[k]=[];
        }
      });
      // Remove old notas field (now embedded in entries)
      delete m.notas;
    });
  }
  // Migration: add White Card if not present
  if(s.invItems&&!s.invItems.some(x=>x.c&&x.c.includes('White Card'))){
    const ei=s.invItems.findIndex(x=>x.c&&x.c.includes('emergencia'));
    const wc={c:'White Card / Forklift',u:0,a:0,d:'Licencia trabajo en altura/maquinaria'};
    if(ei>=0)s.invItems.splice(ei,0,wc);else s.invItems.push(wc);
  }
  s.months.forEach(m=>{if(!m.horas)m.horas=[0,0,0,0,0];});
  return s;
}
/* modal overlay click handled in boot */

/* boot functions defined below */
function sched(){
  lsave();
  if(saveT)clearTimeout(saveT);
  saveT=setTimeout(()=>{if(useGoogle)saveDrive();else lsave();},2000);
}

/* ‚ïê‚ïê‚ïê TIPO DE CAMBIO ‚ïê‚ïê‚ïê */
async function fetchTC(){
  const apis=[
    ()=>fetch('https://open.er-api.com/v6/latest/AUD').then(r=>r.json()).then(d=>{if(d.result==='success')return d.rates?.USD;throw 0;}),
    ()=>fetch('https://api.exchangerate-api.com/v4/latest/AUD').then(r=>r.json()).then(d=>d.rates?.USD),
    ()=>fetch('https://cdn.jsdelivr.net/gh/fawazahmed0/currency-api@1/latest/currencies/aud/usd.json').then(r=>r.json()).then(d=>d.usd),
    ()=>fetch('https://api.frankfurter.app/latest?from=AUD&to=USD').then(r=>r.json()).then(d=>d.rates?.USD),
  ];
  for(const fn of apis){try{const v=await fn();if(v&&v>.4&&v<1.2)return +v.toFixed(6);}catch(e){}}
  return null;
}
async function updateTC(){
  const dot=document.getElementById('tc-dot');
  dot.style.background='#f59e0b';dot.classList.remove('live');
  const v=await fetchTC();
  if(v){ST.tc=v;ST.tcTime=new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});sched();dot.style.background='#4ade80';dot.classList.add('live');}
  else dot.style.background='#f87171';
  renderTC();updateAll();
}
function renderTC(){
  const t=ST.tc||.63;
  const inv=(1/t).toFixed(4);
  setEl('tc-v',`${t.toFixed(4)}`);
  setEl('tc-inv',inv);setEl('tc-inv-dash',inv);
  const inp=document.getElementById('tc-inp');
  if(inp&&document.activeElement!==inp)inp.value=t.toFixed(4);
  setEl('tc-src',ST.tcTime?'auto':'manual');
}
function manualTC(){
  const v=+document.getElementById('tc-inp').value;
  if(v>.2&&v<2){ST.tc=v;sched();renderTC();updateAll();}
}

/* ‚ïê‚ïê‚ïê CALCS ‚ïê‚ïê‚ïê */
const tc=()=>ST.tc||.63;
const a2u=n=>n*tc();
const u2a=n=>n/tc();
const mSal=i=>(ST.months[i].semanas||[]).reduce((a,b)=>a+b,0);
const mHrs=i=>(ST.months[i].horas||[]).reduce((a,b)=>a+b,0);
const mIng=i=>mSal(i)+IK.reduce((s,k)=>s+gVal(ST.months[i].ingresos[k]),0);
const mGas=i=>GK.reduce((s,k)=>s+gVal(ST.months[i].gastos[k]),0);
const mAho=i=>mIng(i)-mGas(i);
const tGan=()=>MN.reduce((_,__,i)=>_+mIng(i),0);
const tGas=()=>MN.reduce((_,__,i)=>_+mGas(i),0);
const tAho=()=>tGan()-tGas();
const tHrs=()=>MN.reduce((_,__,i)=>_+mHrs(i),0);
const tIU=()=>ST.invItems.reduce((s,x)=>s+(+x.u||0),0);
const tIA=()=>ST.invItems.reduce((s,x)=>s+((+x.a||0)||(+x.u?u2a(+x.u):0)),0);
const tPag=()=>(ST.pagos||[]).reduce((s,p)=>s+(+p.montoAUD||0),0);
const tMetasAsig=()=>(ST.metas||[]).reduce((s,m)=>s+(+m.asig||0),0);

/*
  DEUDA LOGIC (FIXED):
  - deudaBruta = inversi√≥n inicial (fija) + gastos en meses sin ning√∫n ingreso
  - deudaPendiente = max(0, deudaBruta - pagosRealizados)  ‚Üê solo baja con pagos manuales
  - caja = max(0, ahorroAcumulado - pagosRealizados)       ‚Üê sube con el sueldo
  Los ingresos semanales NO descuentan la deuda autom√°ticamente.
  Solo descuenta cuando registr√°s un pago en la secci√≥n Deuda.
*/
function calcD(){
  const invA=tIA();
  const apoyo=+(ST.apoyo||0);  // apoyo fijo manual ‚Äî no cambia con los meses
  const bruta=invA+apoyo;
  const pag=tPag();
  const pend=Math.max(0,bruta-pag);
  const caja=Math.max(0,tAho()+apoyo-pag);
  return{invA,gsi:apoyo,bruta,pag,pend,caja};
}

/* ‚ïê‚ïê‚ïê FORMAT ‚ïê‚ïê‚ïê */
function fn(n,d=0){
  if(isNaN(n)||n==null)return'‚Äî';
  const a=Math.abs(n).toLocaleString('en-AU',{minimumFractionDigits:d,maximumFractionDigits:d});
  return n<0?'-'+a:a;
}
const fA=(n,d=0)=>`AUD ${fn(n,d)}`;
const fU=(n,d=0)=>`USD ${fn(n,d)}`;
const fA2=n=>`AUD ${fn(n,2)}`;
const fU2=n=>`USD ${fn(n,2)}`;
const fN=(n,d=0)=>fn(n,d);
function setEl(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');}
function fDate(f){if(!f)return'‚Äî';try{return new Date(f+'T12:00:00').toLocaleDateString('es-AR',{day:'2-digit',month:'short',year:'numeric'});}catch{return f;}}
function toast(msg,dur=2000){const e=document.getElementById('toast');e.textContent=msg;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),dur);}

/* ‚ïê‚ïê‚ïê UPDATE ALL ‚ïê‚ïê‚ïê */
function updateAll(){renderTC();updDash();updDeuda();updInv();updAnual();updMetas();updFoot();}

function updFoot(){
  const aho=tAho(),d=calcD();
  const ae=document.getElementById('f-a');
  ae.textContent=fA(aho);ae.className='fi-val '+(aho>=0?'g':'r');
  setEl('f-c',fA(d.caja));setEl('f-d',fA(d.pend));
}

function updDash(){
  const gan=tGan(),gas=tGas(),aho=tAho(),invA=tIA(),invU=tIU(),d=calcD();
  setEl('d-ga',fA(gan));setEl('d-gu',fU(a2u(gan)));
  setEl('d-gsa',fA(gas));setEl('d-gsu',fU(a2u(gas)));
  const ae=document.getElementById('d-aa');
  ae.textContent=fA(aho);ae.className='stat-val '+(aho>=0?'g':'r');
  setEl('d-au',fU(a2u(aho)));
  setEl('d-ia',fA(invA));setEl('d-iu',fU(invU));
  setEl('d-ca',fA2(d.caja));setEl('d-cau',fU2(a2u(d.caja)));
  setEl('d-da',fA2(d.pend));setEl('d-du',fU2(Math.max(0,tIU()+a2u(d.gsi)-a2u(d.pag))));
  const pct=d.bruta>0?Math.min(100,d.pag/d.bruta*100):0;
  setEl('d-dapct',pct.toFixed(0)+'%');
  const pb=document.getElementById('d-pbar');
  pb.style.width=pct.toFixed(1)+'%';pb.className='progbar-fill '+(pct>=100?'':'a');
  let act=0;for(let i=0;i<12;i++)if(mGas(i)||mIng(i))act++;
  setEl('d-period',act+' mes'+(act!==1?'es':'')+' activos');
  let lm=-1;for(let i=11;i>=0;i--){if(mGas(i)||mIng(i)){lm=i;break;}}
  const le=document.getElementById('d-last-content'),ln=document.getElementById('d-lm-name');
  if(lm<0){le.innerHTML='<div class="empty">Sin datos a√∫n</div>';setEl('d-lm-name','‚Äî');return;}
  setEl('d-lm-name',MN[lm]);
  const ing=mIng(lm),g2=mGas(lm),aho2=mAho(lm);
  le.innerHTML=`<table class="ledger"><tbody>
    <tr><td class="label-cell">Ingresos</td><td class="num pos">${fA2(ing)}</td><td class="num dim">${fU2(a2u(ing))}</td></tr>
    <tr><td class="label-cell">Gastos</td><td class="num neg">${fA2(g2)}</td><td class="num dim">${fU2(a2u(g2))}</td></tr>
    <tr class="total"><td class="bold">Ahorro del mes</td><td class="num bold ${aho2>=0?'pos':'neg'}">${fA2(aho2)}</td><td class="num dim">${fU2(a2u(aho2))}</td></tr>
  </tbody></table>`;
}

function updDeuda(){
  const d=calcD();
  const pct=d.bruta>0?Math.min(100,d.pag/d.bruta*100):0;
  setEl('deu-chip',fA2(d.pend));
  document.getElementById('deu-chip').className='chip '+(d.pend<=0?'g':'r');
  setEl('dl-inv',fN(d.invA,2));setEl('dl-invu',fN(tIU(),2));
  // apoyo input ‚Äî no sobreescribir si el usuario est√° escribiendo
  const apoyoInp=document.getElementById('apoyo-inp');
  if(apoyoInp&&document.activeElement!==apoyoInp)apoyoInp.value=ST.apoyo||'';
  setEl('dl-gsiu',fN(a2u(d.gsi),2));
  setEl('dl-bruta',fN(d.bruta,2));setEl('dl-brutau',fN(tIU()+a2u(d.gsi),2));
  setEl('dl-pag',fN(d.pag,2));setEl('dl-pagu',fN(a2u(d.pag),2));
  setEl('dl-pend',fN(d.pend,2));setEl('dl-pendu',fN(Math.max(0,tIU()+a2u(d.gsi)-a2u(d.pag)),2));
  const pe=document.getElementById('dl-pend');
  if(pe)pe.className='num bold '+(d.pend<=0?'pos':'neg');
  document.getElementById('deu-bar').style.width=pct.toFixed(1)+'%';
  setEl('deu-pct',pct.toFixed(1)+'%');
  setEl('deu-ca',fA2(d.caja));setEl('deu-cau',fU2(a2u(d.caja)));
  const nota=document.getElementById('nota');
  if(nota&&document.activeElement!==nota)nota.value=ST.nota||'';
  // preview
  const monto=+document.getElementById('pago-m')?.value||0;
  const prev=document.getElementById('pago-preview');
  if(prev&&monto>0){
    const pendAfter=Math.max(0,d.pend-monto);
    const cajaAfter=Math.max(0,d.caja-monto);
    prev.innerHTML=`Deuda restante: <strong>${fA2(pendAfter)}</strong> ¬∑ Caja restante: <strong>${fA2(cajaAfter)}</strong>`;
    prev.style.color=pendAfter<=0?'var(--green)':'var(--ink3)';
  }else if(prev)prev.textContent='';
  // pagos list
  const pl=document.getElementById('pag-list');
  if(!ST.pagos?.length){pl.innerHTML='<div class="empty">Sin pagos registrados.</div>';setEl('deu-np','0 pagos');return;}
  const tot=ST.pagos.reduce((s,p)=>s+(+p.montoAUD||0),0);
  pl.innerHTML=`<div style="padding:8px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)"><span>${ST.pagos.length} pago${ST.pagos.length!==1?'s':''}</span><span style="color:var(--green);font-weight:600">${fA2(tot)}</span></div>`+
    [...ST.pagos].reverse().map((p,ri)=>{
      const idx=ST.pagos.length-1-ri;
      return`<div class="pay-row"><div><div class="pay-date">${fDate(p.fecha)}</div><div class="pay-desc">${esc(p.desc||'Pago a padres')}</div></div><div><div class="pay-aud">${fA2(p.montoAUD)}</div><div class="pay-usd">${fU2(a2u(p.montoAUD))}</div><button class="btn r sm" style="margin-top:5px" onclick="delPag(${idx})">‚úï</button></div></div>`;
    }).join('');
  setEl('deu-np',ST.pagos.length+' pago'+(ST.pagos.length!==1?'s':''));
  calcCuota();
}
async function regPago(){
  const f=document.getElementById('pago-f').value,m=+document.getElementById('pago-m').value||0,desc=document.getElementById('pago-d').value.trim();
  if(!m){alert('Ingres√° un monto.');return;}
  if(!f){alert('Ingres√° la fecha.');return;}
  const d=calcD();
  if(m>d.caja+.01){
    const ok=await showModal('Monto alto',`El monto (${fA2(m)}) supera tu caja disponible (${fA2(d.caja)}).\n¬øRegistrar igual?`,'Registrar igual',true);
    if(!ok)return;
  }
  if(!ST.pagos)ST.pagos=[];
  ST.pagos.push({id:Date.now(),fecha:f,montoAUD:m,desc:desc||'Pago a padres'});
  sched();
  document.getElementById('pago-f').value=new Date().toISOString().slice(0,10);
  document.getElementById('pago-m').value='';document.getElementById('pago-d').value='';
  if(navigator.vibrate)navigator.vibrate([10,50,10]);
  updateAll();toast('Pago registrado ‚úì');
}
async function delPag(idx){
  const p=ST.pagos[idx];if(!p)return;
  const ok=await showModal('Eliminar pago',`¬øEliminar el pago de ${fA2(p.montoAUD)}?\n${fDate(p.fecha)} ¬∑ ${p.desc||'Pago a padres'}`,'Eliminar',true);
  if(ok){ST.pagos.splice(idx,1);sched();updateAll();}
}

function calcCuota(){
  const m=+document.getElementById('cuota-m')?.value||0;
  const d=calcD();
  const re=document.getElementById('cuota-r'),sub=document.getElementById('cuota-s');
  if(!re)return;
  if(m>0&&d.pend>0){
    const cuota=d.pend/m;
    re.textContent=fA2(cuota);
    if(sub)sub.textContent=`${fU2(a2u(cuota))} / mes ¬∑ total ${fA(d.pend)} en ${m} mes${m!==1?'es':''}`;
  }else{
    re.textContent='‚Äî';
    if(sub)sub.textContent=d.pend<=0?'¬°Deuda saldada! üéâ':'Ingres√° la cantidad de meses';
  }
}

function updInvInline(i){
  // Update only the paired field and totals ‚Äî no re-render, no lag
  const it=ST.invItems[i];
  const au=document.getElementById('inv-a-'+i);
  const uu=document.getElementById('inv-u-'+i);
  if(au&&document.activeElement!==au)au.value=it.a||'';
  if(uu&&document.activeElement!==uu)uu.value=it.u||'';
  setEl('inv-tu',fU2(tIU()));setEl('inv-ta',fA2(tIA()));
  // Update debt display too
  const d=calcD();
  setEl('deu-chip',fA2(d.pend));
  setEl('dl-inv',fN(d.invA,2));setEl('dl-invu',fN(tIU(),2));
  setEl('dl-bruta',fN(d.bruta,2));setEl('dl-brutau',fN(tIU()+a2u(d.gsi),2));
  setEl('dl-pend',fN(d.pend,2));setEl('dl-pendu',fN(Math.max(0,tIU()+a2u(d.gsi)-a2u(d.pag)),2));
  setEl('f-d',fA(d.pend));setEl('d-ia',fA(tIA()));setEl('d-iu',fU(tIU()));
}
function updInv(){
  // Auto-fill AUD from USD for items that only have USD
  ST.invItems.forEach(x=>{if((+x.u)>0&&!(+x.a))x.a=+((+x.u/tc()).toFixed(2));});
  const tb=document.getElementById('inv-body');tb.innerHTML='';
  ST.invItems.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="min-width:130px"><input class="inp-text" value="${esc(it.c)}" oninput="ST.invItems[${i}].c=this.value;sched()"></td>
      <td style="min-width:80px"><input class="inp-num" type="number" step=".01" inputmode="decimal" value="${it.u||''}" placeholder="0.00" id="inv-u-${i}"
        oninput="ST.invItems[${i}].u=+this.value||0;ST.invItems[${i}].a=+((+this.value||0)/tc()).toFixed(2);sched();updInvInline(${i})"></td>
      <td style="min-width:90px"><input class="inp-num" type="number" step=".01" inputmode="decimal" value="${it.a||''}" placeholder="0.00" id="inv-a-${i}"
        oninput="ST.invItems[${i}].a=+this.value||0;ST.invItems[${i}].u=+((+this.value||0)*tc()).toFixed(2);sched();updInvInline(${i})"></td>
      <td style="min-width:130px"><input class="inp-text" value="${esc(it.d||'')}" placeholder="Nota..." oninput="ST.invItems[${i}].d=this.value;sched()"></td>
      <td><button class="btn r sm" onclick="ST.invItems.splice(${i},1);sched();updInv();updateAll()">‚úï</button></td>`;
    tb.appendChild(tr);
  });
  setEl('inv-tu',fU2(tIU()));setEl('inv-ta',fA2(tIA()));
}
function addInv(){ST.invItems.push({c:'Nuevo √≠tem',u:0,a:0,d:''});sched();updInv();updateAll();}

/* ‚ïê‚ïê‚ïê METAS ‚ïê‚ïê‚ïê */
function updMetas(){
  const d=calcD();
  const libre=Math.max(0,d.caja-tMetasAsig());
  setEl('meta-caja',fA(d.caja));setEl('meta-libre',fA(libre));
  const ml=document.getElementById('metas-list');
  if(!ST.metas?.length){ml.innerHTML='<div class="empty">No hay metas. Agreg√° una abajo.</div>';return;}
  ml.innerHTML=ST.metas.map((m,i)=>{
    const pct=m.obj>0?Math.min(100,m.asig/m.obj*100):0;
    const color=pct>=100?'var(--green)':pct>=50?'var(--amber)':'var(--blue)';
    const falta=m.obj>m.asig?`Faltan ${fA(m.obj-m.asig)}`:'¬°Lograda! üéâ';
    return`<div class="meta-row" style="border:1px solid var(--line);margin:8px 16px;padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px">
        <div class="meta-name">${esc(m.nombre)}</div>
        <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:${color}">${pct.toFixed(0)}%</div>
      </div>
      <div class="meta-bar-wrap" style="margin-bottom:10px"><div class="meta-bar-fill" style="width:${pct.toFixed(1)}%;background:${color}"></div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div>
          <div style="font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink4);margin-bottom:4px">Asignado AUD</div>
          <input type="number" step="1" inputmode="numeric" class="inp-big" style="font-size:16px"
            value="${m.asig||''}" placeholder="0"
            oninput="ST.metas[${i}].asig=+this.value||0;sched();updMetasInline(${i})">
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--ink4);margin-bottom:4px">Objetivo AUD</div>
          <input type="number" step="1" inputmode="numeric" class="inp-big" style="font-size:16px"
            value="${m.obj||''}" placeholder="0"
            oninput="ST.metas[${i}].obj=+this.value||0;sched();updMetasInline(${i})">
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-family:var(--mono);font-size:11px;color:var(--ink4)" id="meta-falta-${i}">${falta}</span>
        <button class="btn r sm" onclick="delMeta(${i})">Eliminar</button>
      </div>
    </div>`;
  }).join('');
}
function updMetasInline(i){
  const m=ST.metas[i];
  if(!m)return;
  const pct=m.obj>0?Math.min(100,m.asig/m.obj*100):0;
  const color=pct>=100?'var(--green)':pct>=50?'var(--amber)':'var(--blue)';
  const falta=m.obj>m.asig?`Faltan ${fA(m.obj-m.asig)}`:'¬°Lograda! üéâ';
  // update bar
  const row=document.querySelectorAll('.meta-row')[i];
  if(row){
    const bar=row.querySelector('.meta-bar-fill');
    if(bar){bar.style.width=pct.toFixed(1)+'%';bar.style.background=color;}
    const pctEl=row.querySelector('[style*="font-size:16px"]')?.parentElement?.parentElement?.querySelector('div:last-child');
    // update pct label
    const labels=row.querySelectorAll('[style*="font-weight:700"]');
    labels.forEach(el=>{if(el.textContent.includes('%'))el.textContent=pct.toFixed(0)+'%';el.style.color=color;});
  }
  setEl('meta-falta-'+i,falta);
  // update header libre/caja
  const d=calcD();
  const libre=Math.max(0,d.caja-tMetasAsig());
  setEl('meta-caja',fA(d.caja));setEl('meta-libre',fA(libre));
}
function addMeta(){
  const nombre=document.getElementById('meta-nombre').value.trim();
  const obj=+document.getElementById('meta-obj').value||0;
  const asig=+document.getElementById('meta-asig').value||0;
  if(!nombre){alert('Ingres√° un nombre.');return;}
  if(!obj){alert('Ingres√° el objetivo en AUD.');return;}
  if(!ST.metas)ST.metas=[];
  ST.metas.push({nombre,obj,asig});sched();
  document.getElementById('meta-nombre').value='';
  document.getElementById('meta-obj').value='';
  document.getElementById('meta-asig').value='';
  updMetas();toast('Meta agregada ‚úì');
}
async function delMeta(idx){const m=ST.metas[idx];if(!m)return;const ok=await showModal('Eliminar meta',`¬øEliminar la meta "${m.nombre}"?`,'Eliminar',true);if(ok){ST.metas.splice(idx,1);sched();updMetas();}}

/* ‚ïê‚ïê‚ïê ANUAL ‚ïê‚ïê‚ïê */
function updAnual(){
  let ti=0,tg=0,ta=0,bA=-Infinity,wA=Infinity,bM='‚Äî',wM='‚Äî',act=0;
  const tb=document.getElementById('rs-body');tb.innerHTML='';
  const barIng=[],barGas=[],barAho=[];
  MN.forEach((m,i)=>{
    const ing=mIng(i),gas=mGas(i),aho=mAho(i);
    if(ing||gas){act++;if(aho>bA){bA=aho;bM=MS[i];}if(aho<wA){wA=aho;wM=MS[i];}}
    ti+=ing;tg+=gas;ta+=aho;
    barIng.push(ing);barGas.push(gas);barAho.push(aho);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="font-family:var(--mono)">${MS[i]}</td><td class="num ${ing?'pos dim':''}">${ing?fA(ing):'‚Äî'}</td><td class="num ${gas?'neg dim':''}">${gas?fA(gas):'‚Äî'}</td><td class="num ${aho<0?'neg':aho>0?'pos':''} ${ing||gas?'':'dim'}">${ing||gas?fA(aho):'‚Äî'}</td><td class="num dim">${ing||gas?fU(a2u(aho)):'‚Äî'}</td>`;
    tb.appendChild(tr);
  });
  const dv=Math.max(1,act);
  setEl('rs-ti',fA(ti));setEl('rs-tg',fA(tg));setEl('rs-ta',fA(ta));setEl('rs-tu',fU(a2u(ta)));
  setEl('rs-pi',fA(ti/dv));setEl('rs-pg',fA(tg/dv));setEl('rs-pa',fA(ta/dv));setEl('rs-pau',fU(a2u(ta/dv)));
  setEl('rs-mej',bA>-Infinity?fA(bA):'‚Äî');setEl('rs-mejm',bM);
  setEl('rs-peor',wA<Infinity?fA(wA):'‚Äî');setEl('rs-peorm',wM);
  setEl('rs-act',act+'/12');
  const hrs=tHrs();setEl('rs-tarifa',hrs>0?fn(ti/hrs,2):'‚Äî');

  // category chart
  const catTotals=GK.map((k,ki)=>({k,lbl:GL[ki],val:MN.reduce((_,__,i)=>_+gVal(ST.months[i].gastos[k]),0)}))
    .filter(x=>x.val>0).sort((a,b)=>b.val-a.val);
  setEl('rs-gtotal',`${fA(tg)} total`);
  const cc=document.getElementById('cat-chart');
  if(!catTotals.length){cc.innerHTML='<div class="empty">Sin gastos registrados a√∫n</div>';}
  else{
    const max=catTotals[0].val;
    const colors=['var(--red)','var(--ink2)','var(--amber)','var(--green)','var(--blue)','#7c3aed','#0891b2','#db2777','#d97706','#64748b'];
    cc.innerHTML=catTotals.map((c,idx)=>{
      const pct=max>0?(c.val/max*100).toFixed(1):0;
      const pctTotal=tg>0?(c.val/tg*100).toFixed(0):0;
      return`<div style="display:flex;align-items:center;gap:10px;padding:7px 16px;border-bottom:1px solid var(--line)">
        <div style="width:110px;flex-shrink:0;font-family:var(--mono);font-size:10px;color:var(--ink3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.lbl}</div>
        <div style="flex:1;height:4px;background:var(--bg2);overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${colors[idx%colors.length]};transition:width .6s ease"></div>
        </div>
        <div style="width:80px;text-align:right;font-family:var(--mono);font-size:11px;font-weight:600;color:var(--ink);flex-shrink:0">${fA(c.val,0)}</div>
        <div style="width:30px;text-align:right;font-family:var(--mono);font-size:10px;color:var(--ink4);flex-shrink:0">${pctTotal}%</div>
      </div>`;
    }).join('');
  }

  // bar chart
  const canvas=document.getElementById('bar-chart');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const W=canvas.offsetWidth||300,H=130;
  canvas.width=W*window.devicePixelRatio;canvas.height=H*window.devicePixelRatio;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  ctx.scale(window.devicePixelRatio,window.devicePixelRatio);
  const PAD={top:10,right:10,bottom:22,left:46};
  const cW=W-PAD.left-PAD.right,cH=H-PAD.top-PAD.bottom;
  const allVals=[...barIng,...barGas.map(v=>-v),...barAho];
  const maxV=Math.max(...allVals.filter(v=>v>0),1);
  const minV=Math.min(...allVals.filter(v=>v<0),0);
  const range=maxV-minV||1;
  const toY=v=>PAD.top+cH*(1-(v-minV)/range);
  const bw=cW/12;
  ctx.fillStyle='#ffffff';ctx.fillRect(0,0,W,H);
  const zy=toY(0);
  ctx.strokeStyle='#d0cfc8';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(PAD.left,zy);ctx.lineTo(W-PAD.right,zy);ctx.stroke();
  ctx.strokeStyle='#eae9e4';ctx.lineWidth=.5;
  [.25,.5,.75,1].forEach(f=>{
    const y=PAD.top+cH*f;
    ctx.beginPath();ctx.moveTo(PAD.left,y);ctx.lineTo(W-PAD.right,y);ctx.stroke();
  });
  MS.forEach((m,i)=>{
    const x=PAD.left+i*bw,bwI=bw*.55,xOff=(bw-bwI)/2;
    if(barIng[i]>0){const y=toY(barIng[i]),h=zy-y;ctx.fillStyle='rgba(22,101,52,.15)';ctx.fillRect(x+xOff,y,bwI,h);ctx.fillStyle='#166534';ctx.fillRect(x+xOff,y,2,h);}
    if(barGas[i]>0){const y=zy,h=toY(-barGas[i])-zy;ctx.fillStyle='rgba(153,27,27,.12)';ctx.fillRect(x+xOff,y,bwI,h);ctx.fillStyle='#991b1b';ctx.fillRect(x+xOff+bwI-2,y,2,h);}
    if(barIng[i]||barGas[i]){const sy=toY(barAho[i]);ctx.fillStyle=barAho[i]>=0?'#166534':'#991b1b';ctx.beginPath();ctx.arc(x+bw/2,sy,2.5,0,Math.PI*2);ctx.fill();}
    ctx.fillStyle='#aaa';ctx.font=`500 ${Math.max(8,Math.min(9,bw*.55))}px JetBrains Mono,monospace`;
    ctx.textAlign='center';ctx.fillText(m.slice(0,1),x+bw/2,H-6);
  });
  ctx.fillStyle='#aaa';ctx.font='8px JetBrains Mono,monospace';ctx.textAlign='right';
  [0,.5,1].forEach(f=>{
    const v=minV+range*f,y=toY(v);
    if(Math.abs(y-PAD.top)<8||Math.abs(y-(H-PAD.bottom))<8)return;
    ctx.fillText((v>=0?'':'-')+fN(Math.abs(v),0),PAD.left-4,y+3);
  });
}

/* ‚ïê‚ïê‚ïê MESES ‚ïê‚ïê‚ïê */
let cM=new Date().getMonth(); // mes actual por defecto
function renderStrip(){
  const c=document.getElementById('mstrip');c.innerHTML='';
  MN.forEach((m,i)=>{
    const hd=mIng(i)||mGas(i);
    const el=document.createElement('div');
    el.className='mtab'+(i===cM?' on':'')+(hd?' has':'');
    el.innerHTML=MS[i]+(hd?'<span class="mdot"></span>':'');
    el.onclick=()=>{cM=i;renderStrip();renderMes();};
    c.appendChild(el);
  });
  // scroll al mes activo
  const active=c.querySelector('.mtab.on');
  if(active)active.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
}


/* ‚îÄ‚îÄ RENDER MES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderCatRow(mi, field, labels, keys, m_field, colorClass){
  return keys.map((k,ki)=>{
    const entries = Array.isArray(m_field[k]) ? m_field[k] : [];
    const total = gVal(m_field[k]);
    const uid = mi+'-'+field+'-'+k;
    const logHtml = renderLog(entries, mi, field, k);
    const addId = 'add-'+uid;
    const amtId = 'aa-'+uid;
    const noteId = 'an-'+uid;
    const totId = (field==='gastos'?'gas':'ing')+'-tot-'+mi+'-'+ki;
    let html = '<div class="cat-row">';
    html += '<span class="cat-lbl">'+labels[ki]+'</span>';
    html += '<span class="cat-total '+(total>0?colorClass:'')+'" id="'+totId+'">'+(total>0?fA2(total):'‚Äî')+'</span>';
    html += '<button class="cat-add" onclick="openAdd(\''+addId+'\')">+ agregar</button>';
    html += '</div>'+logHtml;
    html += '<div class="add-row" id="'+addId+'">';
    html += '<input id="'+amtId+'" class="add-amt" type="number" step=".01" inputmode="decimal" placeholder="AUD 0.00"';
    html += ' onkeydown="if(event.key===\'Enter\')submitAdd('+mi+',\''+field+'\',\''+k+'\',\''+amtId+'\',\''+noteId+'\')">';
    html += '<input id="'+noteId+'" class="add-note" type="text" placeholder="nota opcional"';
    html += ' onkeydown="if(event.key===\'Enter\')submitAdd('+mi+',\''+field+'\',\''+k+'\',\''+amtId+'\',\''+noteId+'\')">';
    html += '<button class="add-ok" onclick="submitAdd('+mi+',\''+field+'\',\''+k+'\',\''+amtId+'\',\''+noteId+'\')">‚úì</button>';
    html += '<button class="add-cancel" onclick="openAdd(\''+addId+'\')">√ó</button>';
    html += '</div>';
    return html;
  }).join('');
}

function renderMes(){
  const i=cM, m=ST.months[i];
  const sal=mSal(i),ing=mIng(i),gas=mGas(i),aho=mAho(i),hrs=mHrs(i);
  const tarifa=hrs>0&&ing>0?(ing/hrs).toFixed(2):'‚Äî';
  const sinI=ing===0&&gas>0;
  const bon=aho>0&&ing>0;
  const bandClass=sinI?'band r':bon?'band g':'';
  const bandInner=sinI
    ?'<div><div class="band-lbl">Mes sin ingresos</div><div style="font-family:var(--mono);font-size:11px;color:var(--red)">'+fA(gas)+' gastados suman a la deuda bruta.</div></div>'
    :bon
    ?'<div><div class="band-lbl">Mes positivo</div><div style="font-family:var(--mono);font-size:11px;color:var(--green)">'+fA(aho)+' acumulados en tu caja.</div></div>'
    :'';

  const ingRows = renderCatRow(i,'ingresos',IL,IK,m.ingresos,'pos');
  const gasRows = renderCatRow(i,'gastos',GL,GK,m.gastos,'neg');

  document.getElementById('mes-cnt').innerHTML=`
    <div id="mes-band-${i}" class="${bandClass}">${bandInner}</div>

    <table class="ledger"><tbody>
      <tr class="subtotal"><td class="bold" style="font-family:var(--mono)">${MN[i]}</td><td class="num bold ${aho>=0?'pos':'neg'}" id="m-aho-${i}">${fA2(aho)}</td><td class="num dim">${fU2(a2u(aho))}</td></tr>
      <tr><td class="label-cell italic">Ingresos totales</td><td class="num pos" id="m-ing-${i}">${fA2(ing)}</td><td class="num dim">${fU2(a2u(ing))}</td></tr>
      <tr><td class="label-cell italic">Gastos totales</td><td class="num neg" id="m-gas-${i}">${fA2(gas)}</td><td class="num dim" id="m-gasu-${i}">${fU2(a2u(gas))}</td></tr>
      <tr><td class="label-cell italic">Horas trabajadas</td><td class="num dim" style="font-family:var(--mono)" id="m-hrs-${i}">${hrs>0?hrs+'h':'‚Äî'}</td><td class="num dim" id="m-tarifa-${i}">${hrs>0?tarifa+' AUD/h':'‚Äî'}</td></tr>
    </tbody></table>

    <div class="sh"><div class="sh-row"><span class="sh-title">Salario semanal</span><span class="sh-sub" id="salb-${i}">${fA2(sal)}</span></div></div>
    <div class="week-grid">${[0,1,2,3,4].map(s=>`
      <div class="week-cell"><div class="week-lbl">Sem ${s+1}</div>
        <input class="week-inp" type="number" step=".01" inputmode="decimal" pattern="[0-9]*" value="${m.semanas[s]||''}" placeholder="0"
          oninput="ST.months[${i}].semanas[${s}]=+this.value||0;sched();updMesInline(${i});">
      </div>`).join('')}
    </div>
    <div style="padding:6px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)">
      <span>Total mensual</span><span id="sal-foot-${i}" style="color:var(--green);font-weight:600">${fA2(sal)} ¬∑ ${fU2(a2u(sal))}</span>
    </div>

    <div class="sh"><div class="sh-row"><span class="sh-title">Horas trabajadas</span><span class="sh-sub" id="hrsb-${i}">${hrs>0?hrs+'h total':''}</span></div></div>
    <div class="hrs-grid">${[0,1,2,3,4].map(s=>`
      <div class="hrs-cell"><div class="week-lbl">Sem ${s+1}</div>
        <input class="hrs-inp" type="number" step="1" inputmode="numeric" value="${m.horas[s]||''}" placeholder="0"
          oninput="ST.months[${i}].horas[${s}]=+this.value||0;sched();updMesInline(${i});">
      </div>`).join('')}
    </div>
    <div style="padding:6px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)">
      <span>Total horas</span><span id="hrs-foot-${i}" style="color:${hrs>0?'var(--blue)':'var(--ink4)'};font-weight:600">${hrs>0?hrs+'h ¬∑ AUD '+tarifa+'/h':'Sin horas cargadas'}</span>
    </div>

    <div class="sh"><div class="sh-row"><span class="sh-title">Otros ingresos</span></div></div>
    <div style="border:1px solid var(--line);border-radius:8px;margin:12px 20px;overflow:hidden">${ingRows}</div>

    <div class="sh"><div class="sh-row"><span class="sh-title">Gastos</span><span class="sh-sub" id="tot-gas-lbl-${i}">${fA2(gas)}</span></div></div>
    <div style="border:1px solid var(--line);border-radius:8px;margin:12px 20px;overflow:hidden">
      ${gasRows}
      <div style="padding:12px 16px;background:var(--bg1);display:flex;justify-content:space-between;font-family:var(--mono);font-size:12px;font-weight:700">
        <span style="color:var(--ink2)">Total gastos</span>
        <span class="neg" id="tot-gas-${i}">${fA2(gas)}</span>
      </div>
    </div>`;
}

function updMesInline(i){
  const gas=mGas(i),ing=mIng(i),aho=mAho(i),sal=mSal(i),hrs=mHrs(i);
  const tarifa=hrs>0&&ing>0?(ing/hrs).toFixed(2):'‚Äî';
  const m=ST.months[i];
  GK.forEach((k,ki)=>{
    const total=gVal(m.gastos[k]);
    const el=document.getElementById('gas-tot-'+i+'-'+ki);
    if(el){el.textContent=total>0?fA2(total):'‚Äî';el.className='cat-total '+(total>0?'neg':'');}
  });
  IK.forEach((k,ki)=>{
    const total=gVal(m.ingresos[k]);
    const el=document.getElementById('ing-tot-'+i+'-'+ki);
    if(el){el.textContent=total>0?fA2(total):'‚Äî';el.className='cat-total '+(total>0?'pos':'');}
  });
  const t1=document.getElementById('tot-gas-'+i);if(t1)t1.textContent=fA2(gas);
  const tl=document.getElementById('tot-gas-lbl-'+i);if(tl)tl.textContent=fA2(gas);
  const sa=document.getElementById('m-aho-'+i);if(sa){sa.textContent=fA2(aho);sa.className='num bold '+(aho>=0?'pos':'neg');}
  const si=document.getElementById('m-ing-'+i);if(si)si.textContent=fA2(ing);
  const sg=document.getElementById('m-gas-'+i);if(sg)sg.textContent=fA2(gas);
  const sgu=document.getElementById('m-gasu-'+i);if(sgu)sgu.textContent=fU2(a2u(gas));
  const sh=document.getElementById('m-hrs-'+i);if(sh)sh.textContent=hrs>0?hrs+'h':'‚Äî';
  const st2=document.getElementById('m-tarifa-'+i);if(st2)st2.textContent=hrs>0?tarifa+' AUD/h':'‚Äî';
  const sb=document.getElementById('salb-'+i);if(sb)sb.textContent=fA2(sal);
  const sf=document.getElementById('sal-foot-'+i);if(sf)sf.textContent=fA2(sal)+' ¬∑ '+fU2(a2u(sal));
  const hb=document.getElementById('hrsb-'+i);if(hb)hb.textContent=hrs>0?hrs+'h total':'';
  const hf=document.getElementById('hrs-foot-'+i);
  if(hf){hf.textContent=hrs>0?hrs+'h ¬∑ AUD '+tarifa+'/h':'Sin horas cargadas';hf.style.color=hrs>0?'var(--blue)':'var(--ink4)';}
  const sinI=ing===0&&gas>0,bon=aho>0&&ing>0;
  const band=document.getElementById('mes-band-'+i);
  if(band){
    band.className=sinI?'band r':bon?'band g':'';
    band.innerHTML=sinI
      ?'<div><div class="band-lbl">Mes sin ingresos</div><div style="font-family:var(--mono);font-size:11px;color:var(--red)">'+fA(gas)+' gastados suman a la deuda bruta.</div></div>'
      :bon?'<div><div class="band-lbl">Mes positivo</div><div style="font-family:var(--mono);font-size:11px;color:var(--green)">'+fA(aho)+' acumulados en tu caja.</div></div>'
      :'';
  }
  renderStrip();
  updDeuda();
}

/* ‚îÄ‚îÄ GO / NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function go(name,el){
  document.querySelectorAll('.pg').forEach(p=>{p.classList.remove('on');p.classList.remove('fade-in');});
  const pg=document.getElementById('pg-'+name);
  if(!pg)return;
  pg.classList.add('on');
  void pg.offsetWidth;
  pg.classList.add('fade-in');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  if(el)el.classList.add('on');
  if(name==='meses'){renderStrip();renderMes();}
  updateAll();window.scrollTo(0,0);
  if(navigator.vibrate)navigator.vibrate(10);
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let _modalResolve=null;
function showModal(title,msg,confirmLabel,danger){
  confirmLabel=confirmLabel||'Confirmar'; danger=danger!==false;
  return new Promise(resolve=>{
    _modalResolve=resolve;
    setEl('modal-title',title); setEl('modal-msg',msg);
    const btn=document.getElementById('modal-confirm-btn');
    btn.textContent=confirmLabel; btn.className='btn'+(danger?' r':'');
    const overlay=document.getElementById('modal-overlay');
    overlay.style.display='flex';
    const box=document.getElementById('modal-box');
    box.style.transform='translateY(100%)'; box.style.transition='transform .25s ease';
    requestAnimationFrame(()=>requestAnimationFrame(()=>{box.style.transform='translateY(0)';}));
  });
}
function modalResolve(val){
  const overlay=document.getElementById('modal-overlay');
  const box=document.getElementById('modal-box');
  box.style.transform='translateY(100%)';
  setTimeout(()=>{overlay.style.display='none';},250);
  if(_modalResolve){_modalResolve(val);_modalResolve=null;}
  if(val&&navigator.vibrate)navigator.vibrate(10);
}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const TOKEN_TTL=3300000;
function saveToken(t){localStorage.setItem('cf_tok',t);localStorage.setItem('cf_tok_ts',Date.now());}
function loadToken(){
  const t=localStorage.getItem('cf_tok'),ts=+localStorage.getItem('cf_tok_ts')||0;
  return(Date.now()-ts<TOKEN_TTL)?t:null;
}
function clearToken(){localStorage.removeItem('cf_tok');localStorage.removeItem('cf_tok_ts');}
function hideAll(){['loading','auth','reconect'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none';});}
function showLoading(){hideAll();document.getElementById('loading').style.display='flex';}
function showAuth(){hideAll();document.getElementById('auth').style.display='flex';}
function showReconect(){hideAll();document.getElementById('reconect').style.display='flex';}

function setLoadingProgress(pct,msg){
  const bar=document.getElementById('loading-bar');
  const lbl=document.getElementById('loading-msg');
  if(bar)bar.style.width=pct+'%';
  if(lbl&&msg)lbl.textContent=msg;
}

async function bootDrive(){
  setLoadingProgress(20,'Conectando a Drive...');
  try{
    setLoadingProgress(50,'Buscando datos...');
    driveFileId=await findFile();
    if(driveFileId){
      setLoadingProgress(75,'Cargando...');
      ST=ensureState(await readFile(driveFileId));
      setEl('sync-st','‚úì Drive'); toast('Cargado desde Drive ‚úì',2000);
    }else{ST=ensureState(lload()||initST());setEl('sync-st','nuevo');}
  }catch(e){ST=ensureState(lload()||initST());setEl('sync-st','‚ö† local');}
  setLoadingProgress(100,'Listo');
  finishBoot();
}
function bootLocal(){
  setLoadingProgress(60,'Cargando datos locales...');
  ST=ensureState(lload()||initST()); setEl('sync-st','local');
  setLoadingProgress(100,'Listo');
  finishBoot();
}
let _booted=false;
function finishBoot(){
  if(_booted)return; _booted=true;
  document.getElementById('loading').classList.add('hide');
  document.getElementById('pago-f').value=new Date().toISOString().slice(0,10);
  renderTC(); updateAll(); updateTC();
  setInterval(updateTC,30*60*1000);
  if(useGoogle){
    setInterval(async()=>{try{await refreshToken();}catch(e){}},50*60*1000);
    setInterval(saveDrive,3*60*1000);
  }
}


function startGoogle(){
  if(typeof google==='undefined'||!google.accounts){
    document.getElementById('auth-err').textContent='Cargando Google... intent√° de nuevo.';
    setTimeout(()=>startGoogle(),2000); return;
  }
  doSignIn(false,'auth');
}
function reconectGoogle(){
  const btn=document.getElementById('reconect-btn');
  btn.textContent='Conectando...'; btn.disabled=true;
  document.getElementById('reconect-err').textContent='';
  doSignIn(false,'reconect');
}
function doSignIn(silent,errTarget){
  silent=silent||false; errTarget=errTarget||'auth';
  const client=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID, scope:DRIVE_SCOPE,
    prompt:silent?'':'select_account',
    callback:async resp=>{
      if(resp.error||!resp.access_token){
        if(errTarget==='reconect'){
          const btn=document.getElementById('reconect-btn');
          btn.textContent='Reconectar Google Drive'; btn.disabled=false;
          document.getElementById('reconect-err').textContent='Error: '+resp.error;
        }else{
          document.getElementById('auth-err').textContent='Error: '+resp.error;
        }
        return;
      }
      gToken=resp.access_token; useGoogle=true;
      saveToken(gToken); localStorage.setItem('cf_ug','1');
      hideAll(); showLoading();
      await bootDrive();
    }
  });
  client.requestAccessToken(silent?{prompt:''}:{});
}

/* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded',()=>{
  const mo=document.getElementById('modal-overlay');
  if(mo)mo.addEventListener('click',e=>{if(e.target.id==='modal-overlay')modalResolve(false);});

  const wasGoogle=localStorage.getItem('cf_ug')==='1';
  if(!wasGoogle){showAuth();return;}

  const cachedToken=loadToken();
  if(cachedToken){gToken=cachedToken;useGoogle=true;bootDrive();return;}

  let resolved=false;
  const done=(fn)=>{if(resolved)return;resolved=true;fn();};
  const hardTimeout=setTimeout(()=>done(showReconect),8000);
  const trySilent=()=>{
    if(typeof google==='undefined'||!google.accounts){setTimeout(trySilent,500);return;}
    try{
      google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID,scope:DRIVE_SCOPE,prompt:'',
        callback:async resp=>{
          clearTimeout(hardTimeout);
          if(resp.error||!resp.access_token){done(showReconect);return;}
          gToken=resp.access_token;useGoogle=true;saveToken(gToken);
          done(()=>{});
          await bootDrive();
        }
      }).requestAccessToken({prompt:''});
    }catch(e){clearTimeout(hardTimeout);done(showReconect);}
  };
  trySilent();
});

</script>
</body>
</html>
