<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<title>Finanzas · Australia 2026</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<style>
/* ─── TOKENS ────────────────────────────────────────── */
:root{
  --bg:      #FAFAF8;
  --surface: #FFFFFF;
  --surf2:   #F4F3EF;
  --surf3:   #ECEAE4;
  --border:  #D8D5CE;
  --border2: #C8C5BD;
  --ink:     #1A1916;
  --ink2:    #3D3B36;
  --ink3:    #706D65;
  --ink4:    #A09D96;
  --ink5:    #C8C5BD;
  --green:   #1A7A5E;
  --green-s: #EAF4F0;
  --green-b: #A8D5C7;
  --red:     #C0392B;
  --red-s:   #FDF0EE;
  --red-b:   #EAB4AE;
  --amber:   #B5770D;
  --amber-s: #FDF8EE;
  --amber-b: #E8D49A;
  --blue:    #1A5E8C;
  --blue-s:  #EEF4FA;
  --blue-b:  #A8C8E0;
  --mono: 'DM Mono', monospace;
  --sans: 'DM Sans', system-ui, sans-serif;
  --r: 6px;
  --r2: 10px;
}
/* ─── RESET ─────────────────────────────────────────── */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{font-size:14px;-webkit-text-size-adjust:100%}
body{background:var(--bg);color:var(--ink);font-family:var(--sans);min-height:100vh;-webkit-font-smoothing:antialiased}
input,button,textarea,select{font-family:inherit}

/* ─── LOADING ────────────────────────────────────────── */
#loading{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;transition:opacity .35s}
#loading.hide{opacity:0;pointer-events:none}
.ld-mark{font-family:var(--mono);font-size:36px;font-weight:600;color:var(--ink);letter-spacing:-2px}
.ld-sub{font-family:var(--mono);font-size:10px;color:var(--ink4);letter-spacing:3px;text-transform:uppercase}
.ld-bar{width:140px;height:2px;background:var(--surf3);border-radius:1px;overflow:hidden}
#ld-fill{height:100%;width:0%;background:var(--ink);border-radius:1px;transition:width .25s ease}
#ld-msg{font-family:var(--mono);font-size:10px;color:var(--ink5)}

/* ─── AUTH / RECONECT ────────────────────────────────── */
.auth-screen{display:none;position:fixed;inset:0;background:var(--bg);z-index:8800;align-items:center;justify-content:center;padding:24px}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r2);padding:40px 32px;width:100%;max-width:380px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.05)}
.auth-mark{font-family:var(--mono);font-size:30px;font-weight:600;color:var(--ink);margin-bottom:16px}
.auth-title{font-size:17px;font-weight:700;color:var(--ink);margin-bottom:6px}
.auth-sub{font-size:13px;color:var(--ink3);line-height:1.6;margin-bottom:28px}
.auth-g{width:100%;padding:13px;background:var(--ink);color:#fff;border:none;border-radius:var(--r);font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;transition:opacity .15s}
.auth-g:hover{opacity:.88}
.auth-local{width:100%;padding:11px;background:transparent;color:var(--ink3);border:1px solid var(--border);border-radius:var(--r);font-family:var(--sans);font-size:13px;cursor:pointer;transition:border-color .15s}
.auth-local:hover{border-color:var(--border2)}
.auth-err{font-size:11px;color:var(--red);margin-top:8px;min-height:16px;font-family:var(--mono)}

/* ─── TOPBAR ─────────────────────────────────────────── */
.topbar{background:var(--surface);border-bottom:1px solid var(--border);height:48px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:300;gap:12px}
.topbar-brand{font-family:var(--mono);font-size:12px;font-weight:600;color:var(--ink);display:flex;align-items:center;gap:8px;letter-spacing:.5px;text-transform:uppercase}
.topbar-pill{background:var(--ink);color:#fff;font-size:9px;font-weight:600;padding:2px 7px;border-radius:3px;letter-spacing:.5px}
.topbar-right{display:flex;align-items:center;gap:14px}
.tc-display{font-family:var(--mono);font-size:10px;color:var(--ink4);display:flex;align-items:center;gap:6px;cursor:pointer}
.tc-display:hover{color:var(--ink3)}
.tc-val{color:var(--ink2);font-weight:600}
.sync-tag{font-family:var(--mono);font-size:10px;color:var(--ink5)}

/* ─── TABS ───────────────────────────────────────────── */
.tabnav{background:var(--surface);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 8px;position:sticky;top:48px;z-index:299}
.tabnav::-webkit-scrollbar{display:none}
.tab{padding:11px 14px;font-family:var(--sans);font-size:11px;font-weight:600;color:var(--ink4);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.6px;text-transform:uppercase}
.tab.on{color:var(--ink);border-bottom-color:var(--ink)}
.tab:hover:not(.on){color:var(--ink3)}

/* ─── PAGES ──────────────────────────────────────────── */
.pg{display:none;padding-bottom:90px;max-width:720px;margin:0 auto;padding-left:0;padding-right:0}
.pg.on{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
.pg.on{animation:pgIn .15s ease}

/* ─── SECTION HEADER ─────────────────────────────────── */
.sh{padding:28px 20px 10px;display:flex;align-items:baseline;justify-content:space-between;gap:12px}
.sh h2{font-size:15px;font-weight:700;color:var(--ink);letter-spacing:.4px;text-transform:uppercase}
.sh-meta{font-family:var(--mono);font-size:10px;color:var(--ink4)}

/* ─── NOTION TABLE ───────────────────────────────────── */
.ntable{width:100%;border-collapse:collapse;font-size:13px}
.ntable-wrap{border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin:0 20px 0}
.ntable thead th{background:var(--surf2);padding:9px 16px;font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.4px;text-transform:uppercase;color:var(--ink4);border-bottom:1px solid var(--border);text-align:left}
.ntable thead th.r{text-align:right}
.ntable td{padding:11px 16px;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--ink2)}
.ntable tr:last-child td{border-bottom:none}
.ntable tr.sub td{background:var(--surf2);font-weight:700;color:var(--ink)}
.ntable tr.tot td{background:var(--surf2);border-top:1px solid var(--border2);font-weight:700;color:var(--ink)}
.ntable tr:hover td{background:var(--surf2)}
.ntable tr.sub:hover td,.ntable tr.tot:hover td{background:var(--surf3)}
.lbl{font-size:13px;color:var(--ink2);text-transform:uppercase;letter-spacing:.3px;font-size:11px}
.lbl.it{font-style:italic;color:var(--ink3);font-weight:400}
.num{font-family:var(--mono);text-align:right;font-size:12px;white-space:nowrap}
.g{color:var(--green)} .r2{color:var(--red)} .a{color:var(--amber)} .b{color:var(--blue)} .d{color:var(--ink3)}

/* ─── STAT GRID ──────────────────────────────────────── */
.statgrid{display:grid;grid-template-columns:repeat(4,1fr);margin:0 20px;border:1px solid var(--border);border-radius:var(--r2);overflow:hidden}
.statcell{padding:16px 14px;border-right:1px solid var(--border);background:var(--surface)}
.statcell:last-child{border-right:none}
.statlbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.6px;text-transform:uppercase;color:var(--ink4);margin-bottom:8px}
.statnum{font-family:var(--mono);font-size:17px;font-weight:600;letter-spacing:-.5px;line-height:1}
.statsub{font-family:var(--mono);font-size:9px;color:var(--ink4);margin-top:4px}

/* ─── BAND (highlight row) ───────────────────────────── */
.band{border:1px solid var(--border);border-radius:var(--r2);margin:0 20px;padding:18px 20px;background:var(--surface)}
.band.g{background:var(--green-s);border-color:var(--green-b)}
.band.r{background:var(--red-s);border-color:var(--red-b)}
.band.a{background:var(--amber-s);border-color:var(--amber-b)}
.band-lbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.6px;text-transform:uppercase;color:var(--ink4);margin-bottom:8px}
.band-val{font-family:var(--mono);font-size:26px;font-weight:600;letter-spacing:-.8px;line-height:1;margin-bottom:4px}
.band-sub{font-family:var(--mono);font-size:10px;color:var(--ink4)}
.band-row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px}

/* ─── TWO-COL BAND ───────────────────────────────────── */
.dual-band{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:0 20px}

/* ─── PROG BAR ───────────────────────────────────────── */
.prog{height:3px;background:var(--surf3);border-radius:2px;overflow:hidden;margin:8px 0 4px}
.prog-fill{height:100%;border-radius:2px;transition:width .4s ease}

/* ─── FORM ELEMENTS ──────────────────────────────────── */
.fg{margin-bottom:16px}
.fg label{display:block;font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:1.4px;text-transform:uppercase;color:var(--ink4);margin-bottom:6px}
.inp{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:11px 14px;font-family:var(--mono);font-size:14px;font-weight:600;color:var(--ink);outline:none;-webkit-appearance:none;transition:border-color .15s}
.inp:focus{border-color:var(--ink)}
.inp.sm{font-size:13px;font-weight:400;padding:9px 12px}
.inp-line{width:100%;background:transparent;border:none;border-bottom:1px solid var(--border);padding:5px 0;font-family:var(--sans);font-size:13px;color:var(--ink);outline:none;transition:border-color .15s}
.inp-line:focus{border-bottom-color:var(--ink2)}
.inp-num{width:100%;background:transparent;border:none;border-bottom:1px solid var(--border);padding:5px 0;font-family:var(--mono);font-size:13px;font-weight:600;color:var(--ink);text-align:right;outline:none;-webkit-appearance:none;transition:border-color .15s}
.inp-num:focus{border-bottom-color:var(--ink2)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.sec{padding:0 20px 20px}

/* ─── BUTTONS ────────────────────────────────────────── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border-radius:var(--r);font-family:var(--sans);font-size:13px;font-weight:600;cursor:pointer;border:none;background:var(--ink);color:#fff;transition:opacity .15s;white-space:nowrap}
.btn:hover{opacity:.85}
.btn.del{background:var(--red);color:#fff}
.btn.out{background:transparent;border:1px solid var(--border);color:var(--ink)}
.btn.out:hover{border-color:var(--border2);background:var(--surf2)}
.btn.full{width:100%;padding:12px}
.btn.sm{padding:6px 12px;font-size:12px}

/* ─── CHIP / BADGE ───────────────────────────────────── */
.chip{font-family:var(--mono);font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;background:var(--surf3);color:var(--ink3);white-space:nowrap}
.chip.g{background:var(--green-s);color:var(--green)}
.chip.r{background:var(--red-s);color:var(--red)}
.chip.a{background:var(--amber-s);color:var(--amber)}

/* ─── MONTH STRIP ────────────────────────────────────── */
.mstrip{background:var(--surface);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 8px}
.mstrip::-webkit-scrollbar{display:none}
.mtab{padding:9px 14px;font-family:var(--sans);font-size:11px;font-weight:600;color:var(--ink4);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.4px;position:relative;text-transform:uppercase}
.mtab.on{color:var(--ink);border-bottom-color:var(--ink)}
.mtab.has::after{content:'';position:absolute;top:7px;right:3px;width:4px;height:4px;border-radius:50%;background:var(--green)}

/* ─── WEEK GRID ──────────────────────────────────────── */
.wgrid{display:grid;grid-template-columns:repeat(5,1fr);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin:0 20px}
.wcell{padding:10px 8px;border-right:1px solid var(--border);text-align:center}
.wcell:last-child{border-right:none}
.wlbl{font-family:var(--mono);font-size:9px;color:var(--ink4);margin-bottom:6px;letter-spacing:.5px}
.winp{width:100%;background:transparent;border:none;border-bottom:1px solid var(--border);padding:4px 0;font-family:var(--mono);font-size:14px;font-weight:600;color:var(--ink);text-align:center;outline:none;-webkit-appearance:none}
.winp:focus{border-bottom-color:var(--ink)}
.wfoot{padding:8px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4);background:var(--surf2);border-bottom:1px solid var(--border)}

/* ─── LOG ENTRIES ────────────────────────────────────── */
.cat-section{border:1px solid var(--border);border-radius:var(--r2);margin:0 20px;overflow:hidden}
.cat-section+.cat-section{margin-top:8px}
.catrow{display:flex;align-items:center;padding:10px 16px;gap:10px;background:var(--surface);border-bottom:1px solid var(--border)}
.catrow:last-child{border-bottom:none}
.catrow:hover{background:var(--surf2)}
.cat-lbl{font-size:11px;color:var(--ink2);font-weight:600;flex:1;text-transform:uppercase;letter-spacing:.4px}
.cat-amt{font-family:var(--mono);font-size:12px;font-weight:600;min-width:80px;text-align:right}
.cat-btn{background:var(--surf2);border:1px solid var(--border);border-radius:4px;padding:4px 10px;font-family:var(--mono);font-size:10px;font-weight:600;color:var(--blue);cursor:pointer;transition:all .15s;flex-shrink:0}
.cat-btn:hover{background:var(--blue-s);border-color:var(--blue-b)}

/* log rows */
.logwrap{border-top:1px solid var(--border);background:var(--surf2)}
@keyframes logIn{from{opacity:0;transform:translateY(-2px)}to{opacity:1;transform:translateY(0)}}
.logrow{display:flex;align-items:center;gap:8px;padding:7px 16px;border-bottom:1px solid var(--border);animation:logIn .12s ease}
.logrow:last-of-type{border-bottom:none}
.log-d{font-family:var(--mono);font-size:10px;color:var(--ink4);min-width:44px;flex-shrink:0}
.log-n{font-size:11px;color:var(--ink3);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.log-m{font-family:var(--mono);font-size:11px;font-weight:600;color:var(--ink2);min-width:70px;text-align:right}
.log-x{background:none;border:none;color:var(--ink5);cursor:pointer;padding:2px 5px;border-radius:3px;font-size:14px;line-height:1;transition:all .12s;flex-shrink:0}
.log-x:hover{background:var(--red-s);color:var(--red)}
.log-more{padding:6px 16px;font-family:var(--mono);font-size:10px;color:var(--blue);cursor:pointer;background:var(--surf2);border-top:1px solid var(--border);transition:color .12s}
.log-more:hover{color:var(--ink)}

/* add form */
.addrow{display:none;padding:10px 14px;background:var(--surf3);border-top:1px solid var(--border);gap:8px;align-items:center;flex-wrap:wrap}
.addrow.open{display:flex;animation:logIn .12s ease}
.add-date{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:7px 8px;font-family:var(--mono);font-size:11px;color:var(--ink3);width:116px;outline:none;cursor:pointer;transition:border-color .12s}
.add-date:focus{border-color:var(--ink3)}
.add-amt{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:7px 10px;font-family:var(--mono);font-size:14px;font-weight:600;color:var(--ink);width:96px;outline:none;-webkit-appearance:none;transition:border-color .12s}
.add-amt:focus{border-color:var(--ink)}
.add-note{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:7px 10px;font-size:12px;color:var(--ink);flex:1;min-width:80px;outline:none;transition:border-color .12s}
.add-note:focus{border-color:var(--ink3)}
.add-ok{background:var(--ink);color:#fff;border:none;border-radius:4px;padding:7px 14px;font-family:var(--mono);font-size:12px;font-weight:600;cursor:pointer;transition:opacity .12s}
.add-ok:hover{opacity:.85}
.add-cancel{background:none;border:none;color:var(--ink4);font-size:18px;cursor:pointer;padding:2px 6px;line-height:1;transition:color .12s}
.add-cancel:hover{color:var(--red)}
.cat-foot{padding:10px 16px;background:var(--surf2);border-top:1px solid var(--border);display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;font-weight:700}

/* ─── PAYMENTS ───────────────────────────────────────── */
.payrow{display:flex;align-items:center;padding:11px 16px;gap:10px;border-bottom:1px solid var(--border);font-size:13px}
.payrow:last-child{border-bottom:none}
.pay-date{font-family:var(--mono);font-size:10px;color:var(--ink4);min-width:70px}
.pay-desc{flex:1;color:var(--ink2)}
.pay-amt{font-family:var(--mono);font-size:12px;font-weight:600;color:var(--green)}
.pay-x{background:none;border:none;color:var(--ink5);cursor:pointer;padding:2px 5px;font-size:14px;border-radius:3px;transition:all .12s}
.pay-x:hover{background:var(--red-s);color:var(--red)}

/* ─── META ───────────────────────────────────────────── */
.metarow{border:1px solid var(--border);border-radius:var(--r2);margin:0 20px 8px;padding:16px;background:var(--surface)}
.meta-name{font-size:14px;font-weight:600;color:var(--ink);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:8px}

/* ─── FOOTER ─────────────────────────────────────────── */
.foot{position:fixed;bottom:0;left:0;right:0;background:rgba(250,250,248,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:300}
.foot-cell{padding:10px 12px 16px;text-align:center;border-right:1px solid var(--border)}
.foot-cell:last-child{border-right:none}
.foot-lbl{font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:1.6px;text-transform:uppercase;color:var(--ink5);margin-bottom:3px}
.foot-val{font-family:var(--mono);font-size:15px;font-weight:600;letter-spacing:-.3px}

/* ─── TOAST ──────────────────────────────────────────── */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(6px);background:var(--ink);color:#fff;font-family:var(--mono);font-size:12px;padding:8px 18px;border-radius:20px;opacity:0;transition:all .2s;z-index:9100;white-space:nowrap;pointer-events:none}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ─── MODAL ──────────────────────────────────────────── */
#modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:8900;align-items:flex-end;justify-content:center}
#modal-box{background:var(--surface);width:100%;max-width:500px;padding:24px 24px 32px;border-radius:var(--r2) var(--r2) 0 0;transform:translateY(100%);transition:transform .25s ease}
#modal-title{font-size:16px;font-weight:700;color:var(--ink);margin-bottom:6px}
#modal-msg{font-size:13px;color:var(--ink3);margin-bottom:20px;line-height:1.55}
.modal-btns{display:flex;gap:10px}
.modal-btns .btn{flex:1}

/* ─── MISC ───────────────────────────────────────────── */
.empty{padding:24px;text-align:center;font-size:13px;color:var(--ink4);font-style:italic}
.divider{height:1px;background:var(--border);margin:0 20px}
.spacer{height:16px}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="ld-mark">AU·26</div>
  <div class="ld-sub">CONTROL FINANCIERO</div>
  <div class="ld-bar"><div id="ld-fill"></div></div>
  <div id="ld-msg">Iniciando…</div>
</div>

<!-- AUTH -->
<div id="auth" class="auth-screen">
  <div class="auth-card">
    <div class="auth-mark">AU·26</div>
    <div class="auth-title">FINANZAS AUSTRALIA</div>
    <div class="auth-sub">Tus datos se sincronizan con Google Drive y están disponibles en cualquier dispositivo.</div>
    <button class="auth-g" onclick="startGoogle()">
      <svg width="16" height="16" viewBox="0 0 18 18" fill="none"><path fill="#fff" d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z"/><path fill="#fff" d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z"/><path fill="#fff" d="M.96 4.96A9 9 0 000 9c0 1.45.35 2.82.96 4.04l2.92-2.26A5.54 5.54 0 013.58 9c0-.62.11-1.22.29-1.78L.96 4.96z"/><path fill="#fff" d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z"/></svg>
      Conectar con Google Drive
    </button>
    <button class="auth-local" onclick="skipAuth()">CONTINUAR SIN DRIVE (SOLO LOCAL)</button>
    <div class="auth-err" id="auth-err"></div>
  </div>
</div>

<!-- RECONECT -->
<div id="reconect" class="auth-screen">
  <div class="auth-card">
    <div class="auth-mark">AU·26</div>
    <div class="auth-title">SESIÓN EXPIRADA</div>
    <div class="auth-sub">Tu token de Google expiró. Reconectá para seguir sincronizando con Drive.</div>
    <button class="auth-g" id="reconect-btn" onclick="reconectGoogle()">RECONECTAR GOOGLE DRIVE</button>
    <button class="auth-local" onclick="skipAuth()">USAR DATOS LOCALES</button>
    <div class="auth-err" id="reconect-err"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- MODAL -->
<div id="modal-ov">
  <div id="modal-box">
    <div id="modal-title"></div>
    <div id="modal-msg"></div>
    <div class="modal-btns">
      <button class="btn out" onclick="modalResolve(false)">Cancelar</button>
      <button class="btn del" id="modal-ok" onclick="modalResolve(true)">Confirmar</button>
    </div>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-brand"><span class="topbar-pill">AU</span>FINANZAS 2026</div>
  <div class="topbar-right">
    <div class="tc-display" onclick="manualTC()" title="Editar TC">
      <span id="tc-usdaud" class="tc-val">—</span>
      <span style="color:var(--border2)">|</span>
      <span id="tc-stamp" class="tc-val">—</span>
    </div>
    <div class="sync-tag" id="sync-st">—</div>
  </div>
</div>

<!-- TABS -->
<div class="tabnav">
  <div class="tab on"  onclick="go('dash',this)">RESUMEN</div>
  <div class="tab"     onclick="go('deuda',this)">DEUDA</div>
  <div class="tab"     onclick="go('inv',this)">INVERSIÓN</div>
  <div class="tab"     onclick="go('meses',this)">MESES</div>
  <div class="tab"     onclick="go('metas',this)">METAS</div>
  <div class="tab"     onclick="go('anual',this)">ANUAL</div>
</div>

<!-- ═══════════ DASHBOARD ═══════════ -->
<div class="pg on" id="pg-dash">
  <div class="sh"><h2>RESUMEN 2026</h2><span class="sh-meta" id="d-period">—</span></div>
  <div class="statgrid">
    <div class="statcell"><div class="statlbl">Ganado</div><div class="statnum g" id="d-gan">—</div><div class="statsub" id="d-ganu">—</div></div>
    <div class="statcell"><div class="statlbl">Gastado</div><div class="statnum r2" id="d-gas">—</div><div class="statsub" id="d-gasu">—</div></div>
    <div class="statcell"><div class="statlbl">Ahorro</div><div class="statnum" id="d-aho">—</div><div class="statsub" id="d-ahou">—</div></div>
    <div class="statcell"><div class="statlbl">INVERSIÓN</div><div class="statnum a" id="d-inv">—</div><div class="statsub" id="d-invu">—</div></div>
  </div>
  <div class="spacer"></div>
  <div class="dual-band">
    <div class="band g"><div class="band-lbl">Caja disponible</div><div class="band-val g" id="d-caja">—</div><div class="band-sub" id="d-cajau">—</div></div>
    <div class="band r"><div class="band-lbl">Deuda pendiente</div><div class="band-val r2" id="d-deu">—</div><div class="band-sub" id="d-deuu">—</div></div>
  </div>
  <div class="spacer"></div>
  <div class="ntable-wrap">
    <table class="ntable"><tbody>
      <tr><td class="lbl it">Meses con actividad</td><td class="num d" id="d-mact">—</td></tr>
      <tr><td class="lbl it">Último mes activo</td><td class="num d" id="d-lm">—</td></tr>
      <tr><td class="lbl it">Promedio mensual</td><td class="num" id="d-prom">—</td></tr>
      <tr><td class="lbl it">Tarifa efectiva</td><td class="num d" id="d-tarifa">—</td></tr>
    </tbody></table>
  </div>
  <div class="spacer"></div>
  <div class="sec">
    <div class="fg"><label>NOTA GENERAL</label><textarea id="nota-gral" class="inp sm" rows="3" style="resize:none;font-family:var(--sans);font-weight:400" placeholder="Notas…" oninput="ST.nota=this.value;sched()"></textarea></div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn out sm" onclick="syncNow()">↻ SYNC DRIVE</button>
      <span class="sync-tag" id="sync-st2">—</span>
    </div>
  </div>
</div>

<!-- ═══════════ DEUDA ═══════════ -->
<div class="pg" id="pg-deuda">
  <div class="sh"><h2>DEUDA CON PADRES</h2><span class="chip r" id="deu-chip">—</span></div>
  <div class="ntable-wrap">
    <table class="ntable">
      <thead><tr><th>CONCEPTO</th><th class="r">AUD</th><th class="r">USD</th></tr></thead>
      <tbody>
        <tr><td class="lbl it">INVERSIÓN INICIAL</td><td class="num d" id="deu-inva">—</td><td class="num d" id="deu-invu">—</td></tr>
        <tr><td class="lbl it">APOYO DE PADRES</td><td class="num d" id="deu-apa">—</td><td class="num d" id="deu-apu">—</td></tr>
        <tr class="sub"><td>DEUDA BRUTA</td><td class="num r2" id="deu-ba">—</td><td class="num d" id="deu-bu">—</td></tr>
        <tr><td class="lbl it">PAGOS REALIZADOS</td><td class="num g" id="deu-paga">—</td><td class="num d" id="deu-pagu">—</td></tr>
        <tr class="tot"><td>DEUDA PENDIENTE</td><td class="num r2" id="deu-penda">—</td><td class="num d" id="deu-pendu">—</td></tr>
      </tbody>
    </table>
  </div>
  <div class="spacer"></div>
  <div class="sec">
    <div class="fg"><label>APOYO DE PADRES — MONTO TOTAL EN AUD</label><input id="apoyo-inp" class="inp" type="number" step=".01" inputmode="decimal" placeholder="0.00" oninput="ST.apoyo=+this.value||0;sched();updDeuda();updDash();updFoot()"></div>
  </div>
  <div class="band">
    <div class="band-lbl">Caja disponible</div>
    <div class="band-val g" id="deu-caja">—</div>
    <div class="band-sub" id="deu-cajau">—</div>
    <div class="spacer" style="height:12px"></div>
    <div class="prog"><div id="deu-prog" class="prog-fill" style="background:var(--green);width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--ink4)">
      <span id="deu-pct">0%</span><span id="deu-rem">—</span>
    </div>
  </div>
  <div class="sh"><h2>REGISTRAR PAGO</h2></div>
  <div class="sec">
    <div class="grid3" style="margin-bottom:12px">
      <div class="fg"><label>FECHA</label><input id="pago-f" class="inp" type="date"></div>
      <div class="fg"><label>MONTO AUD</label><input id="pago-m" class="inp" type="number" step=".01" inputmode="decimal" placeholder="0.00"></div>
      <div class="fg"><label>DESCRIPCIÓN</label><input id="pago-d" class="inp sm" type="text" placeholder="Ej: Wire transfer"></div>
    </div>
    <button class="btn full" onclick="regPago()">REGISTRAR PAGO</button>
  </div>
  <div class="sh"><h2>HISTORIAL DE PAGOS</h2></div>
  <div class="ntable-wrap" id="pago-list"></div>
  <div class="sh"><h2>SIMULADOR DE CUOTAS</h2></div>
  <div class="sec">
    <div class="fg"><label>MESES PARA SALDAR</label><input id="cuota-m" class="inp" type="number" min="1" inputmode="numeric" placeholder="12" oninput="calcCuota()"></div>
    <div id="cuota-res" style="font-family:var(--mono);font-size:13px;color:var(--ink3)"></div>
  </div>
</div>

<!-- ═══════════ INVERSIÓN ═══════════ -->
<div class="pg" id="pg-inv">
  <div class="sh"><h2>INVERSIÓN INICIAL</h2><span class="sh-meta" id="inv-sub">—</span></div>
  <div class="ntable-wrap">
    <table class="ntable">
      <thead><tr><th>CONCEPTO</th><th class="r">USD</th><th class="r">AUD equiv.</th></tr></thead>
      <tbody id="inv-tbody"></tbody>
      <tfoot>
        <tr class="sub"><td>TOTAL</td><td class="num a" id="inv-tu">—</td><td class="num d" id="inv-ta">—</td></tr>
      </tfoot>
    </table>
  </div>
  <div class="spacer"></div>
  <div class="sec"><button class="btn out sm" onclick="addInv()">+ AGREGAR ÍTEM</button></div>
</div>

<!-- ═══════════ MESES ═══════════ -->
<div class="pg" id="pg-meses">
  <div class="mstrip" id="mstrip-cnt"></div>
  <div id="mes-cnt"></div>
</div>

<!-- ═══════════ METAS ═══════════ -->
<div class="pg" id="pg-metas">
  <div class="sh"><h2>METAS DE AHORRO</h2></div>
  <div class="dual-band">
    <div class="band g"><div class="band-lbl">Caja disponible</div><div class="band-val g" id="meta-caja">—</div></div>
    <div class="band b"><div class="band-lbl">Libre tras metas</div><div class="band-val b" id="meta-libre">—</div></div>
  </div>
  <div class="spacer"></div>
  <div id="metas-list"></div>
  <div class="sh"><h2>NUEVA META</h2></div>
  <div class="sec">
    <div class="fg"><label>NOMBRE</label><input id="meta-n" class="inp" type="text" placeholder="Ej: Viaje a Byron Bay"></div>
    <div class="grid2" style="margin-bottom:12px">
      <div class="fg"><label>MONTO AUD</label><input id="meta-m" class="inp" type="number" step=".01" inputmode="decimal" placeholder="0.00"></div>
      <div class="fg"><label>PRIORIDAD (1–10)</label><input id="meta-p" class="inp" type="number" min="1" max="10" inputmode="numeric" placeholder="5"></div>
    </div>
    <button class="btn full" onclick="addMeta()">+ AGREGAR META</button>
  </div>
</div>

<!-- ═══════════ ANUAL ═══════════ -->
<div class="pg" id="pg-anual">
  <div class="sh"><h2>RESUMEN ANUAL</h2><span class="sh-meta">2026</span></div>
  <div class="ntable-wrap" id="anual-meses"></div>
  <div class="sh"><h2>POR CATEGORÍA</h2></div>
  <div class="ntable-wrap" id="anual-cats"></div>
</div>

<!-- FOOTER -->
<div class="foot">
  <div class="foot-cell"><div class="foot-lbl">Ahorro</div><div class="foot-val" id="f-aho">—</div></div>
  <div class="foot-cell"><div class="foot-lbl">Caja</div><div class="foot-val g" id="f-caja">—</div></div>
  <div class="foot-cell"><div class="foot-lbl">DEUDA</div><div class="foot-val r2" id="f-deu">—</div></div>
</div>

<script>
'use strict';
/* ═══════════════════════════════════════════════
   CONSTANTS
═══════════════════════════════════════════════ */
const CLIENT_ID = '181059148005-jbpua2ag12jpvh6niff7jovlniklogu3.apps.googleusercontent.com';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.appdata';
const LS_KEY = 'cf_aus26';
const TOKEN_TTL = 3300000; // 55min

const MN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const MS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

const GK = ['arriendo','comida','transporte','servicios','telefono','salud','seguros','ropa','entretenimiento','viajes','cuidado','gym','otros'];
const GL = ['Arriendo','Comida','Transporte','Servicios','Teléfono','Salud','Seguros','Ropa','Entretenimiento','Viajes','Cuidado personal','Gym','Otros'];
const IK = ['freelance','bonificacion','familia','otros_ing'];
const IL = ['Freelance','Bonificación','Familia','Otros'];

const DEF_INV = [
  {c:'Vuelo ida',              u:158,   a:0},
  {c:'Alojamiento inicial',    u:1727,  a:0},
  {c:'Trámites / Visa',        u:230,   a:0},
  {c:'Equipaje / Ropa',        u:0,     a:0},
  {c:'Seguro de viaje',        u:0,     a:0},
  {c:'Teléfono / SIM',         u:268,   a:0},
  {c:'Transporte setup',       u:0,     a:0},
  {c:'White Card / Forklift',  u:0,     a:0},
  {c:'Fondo emergencia',       u:0,     a:0},
];

/* ═══════════════════════════════════════════════
   STATE
═══════════════════════════════════════════════ */
let ST = {}, saveT = null, gToken = null, driveFileId = null, useGoogle = false, cM = new Date().getMonth(), _booted = false;

/* ═══════════════════════════════════════════════
   TC CONVENTION
   API returns: how many AUD = 1 USD  (e.g. 1.58)
   ST.tc = AUD per USD
   a2u(n) = n AUD → USD = n / ST.tc
   u2a(n) = n USD → AUD = n * ST.tc
═══════════════════════════════════════════════ */
const a2u = n => ST.tc > 0 ? n / ST.tc : 0;   // AUD ÷ rate = USD
const u2a = n => n * (ST.tc || 1.58);           // USD × rate = AUD

/* ═══════════════════════════════════════════════
   DATA MODEL
═══════════════════════════════════════════════ */
const gVal = v => Array.isArray(v) ? v.reduce((s,e) => s+(+e.m||0), 0) : (+v||0);
const today = () => new Date().toISOString().slice(0,10);

function defM() {
  const g={}, ing={};
  GK.forEach(k=>{ g[k]=[]; });
  IK.forEach(k=>{ ing[k]=[]; });
  return {semanas:[0,0,0,0,0], horas:[0,0,0,0,0], ingresos:ing, gastos:g};
}

function initST() {
  const months = MN.map((_,i) => {
    const m = defM();
    if(i===1) {
      m.gastos.comida       = [{d:'2026-02-01',m:132.51,n:'Súper semanal'}];
      m.gastos.transporte   = [{d:'2026-02-01',m:45,    n:''}];
      m.gastos.cuidado      = [{d:'2026-02-01',m:17,    n:''}];
      m.gastos.otros        = [{d:'2026-02-01',m:123,   n:'Afeitadora / Kebap'}];
    }
    return m;
  });
  return {tc:1.5820, tcTime:'', nota:'', pagos:[], metas:[], apoyo:0,
          invItems:JSON.parse(JSON.stringify(DEF_INV)), months};
}

function ensureState(s) {
  if(!s||typeof s!=='object') return initST();
  if(!s.invItems) s.invItems = JSON.parse(JSON.stringify(DEF_INV));
  if(!s.pagos)  s.pagos  = [];
  if(!s.metas)  s.metas  = [];
  if(!s.apoyo)  s.apoyo  = 0;
  if(!s.nota)   s.nota   = '';
  // TC: if old data stored as ~0.63 (inverted), flip it
  if(!s.tc||s.tc<=0) s.tc = 1.5820;
  if(s.tc < 0.5) s.tc = 1/s.tc; // auto-fix inverted TC
  if(!s.months||s.months.length!==12) { s.months=initST().months; return s; }
  s.months.forEach((m,mi) => {
    try {
      if(!m.semanas||!Array.isArray(m.semanas)) m.semanas=[0,0,0,0,0];
      if(!m.horas||!Array.isArray(m.horas))     m.horas=[0,0,0,0,0];
      if(!m.gastos)   m.gastos={};
      if(!m.ingresos) m.ingresos={};
      const notas=(m.notas&&typeof m.notas==='object')?m.notas:{};
      const dd='2026-'+String(mi+1).padStart(2,'0')+'-01';
      GK.forEach(k=>{
        const v=m.gastos[k];
        if(Array.isArray(v)){}
        else if(typeof v==='number'&&v>0) m.gastos[k]=[{d:dd,m:v,n:notas[k]||''}];
        else m.gastos[k]=[];
      });
      IK.forEach(k=>{
        const v=m.ingresos[k];
        if(Array.isArray(v)){}
        else if(typeof v==='number'&&v>0) m.ingresos[k]=[{d:dd,m:v,n:''}];
        else m.ingresos[k]=[];
      });
      delete m.notas;
    } catch(e){ console.warn('migration err',mi,e); }
  });
  return s;
}

/* ═══════════════════════════════════════════════
   CALCS
═══════════════════════════════════════════════ */
const mSal = i => (ST.months[i].semanas||[]).reduce((a,b)=>a+b,0);
const mHrs = i => (ST.months[i].horas||[]).reduce((a,b)=>a+b,0);
const mIng = i => mSal(i) + IK.reduce((s,k)=>s+gVal(ST.months[i].ingresos[k]),0);
const mGas = i => GK.reduce((s,k)=>s+gVal(ST.months[i].gastos[k]),0);
const mAho = i => mIng(i)-mGas(i);
const tGan = () => MN.reduce((s,_,i)=>s+mIng(i),0);
const tGas = () => MN.reduce((s,_,i)=>s+mGas(i),0);
const tAho = () => tGan()-tGas();
const tIU  = () => (ST.invItems||[]).reduce((s,x)=>s+(+x.u||0),0);
// tIA: sum AUD equivalents. If item has explicit AUD price use it, else convert USD→AUD
const tIA  = () => (ST.invItems||[]).reduce((s,x)=>s+(+x.a>0 ? +x.a : u2a(+x.u||0)),0);
const tPag = () => (ST.pagos||[]).reduce((s,p)=>s+(+p.monto||0),0);

function calcD() {
  const invA  = tIA();                      // AUD
  const apoyo = +ST.apoyo||0;               // AUD
  const bruta = invA+apoyo;                 // AUD
  const pag   = tPag();                     // AUD
  const pend  = Math.max(0,bruta-pag);      // AUD
  const caja  = Math.max(0,tAho()+apoyo-pag); // AUD
  return {invA,apoyo,bruta,pag,pend,caja};
}

/* ═══════════════════════════════════════════════
   FORMAT
═══════════════════════════════════════════════ */
const fA  = n => 'AUD '+n.toFixed(0);
const fA2 = n => 'AUD '+n.toFixed(2);
const fU2 = n => 'USD '+n.toFixed(2);
const fDs = d => { if(!d) return ''; const p=d.split('-'); return p[2]+'/'+p[1]; };
const fDl = d => { if(!d) return ''; const p=d.split('-'); return p[2]+'/'+p[1]+'/'+p[0].slice(2); };
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function setEl(id,v){ const e=document.getElementById(id); if(e) e.textContent=v; }
function setC(id,cls){ const e=document.getElementById(id); if(e) e.className=e.className.replace(/\b(g|r2|a|b|d)\b/g,'').trim()+' '+cls; }

/* ═══════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════ */
let _toastT=null;
function toast(msg,ms=2400){
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  if(_toastT) clearTimeout(_toastT);
  _toastT=setTimeout(()=>el.classList.remove('show'),ms);
}

/* ═══════════════════════════════════════════════
   MODAL
═══════════════════════════════════════════════ */
let _mRes=null;
function showModal(title,msg,okLabel='Confirmar',danger=true){
  return new Promise(res=>{
    _mRes=res;
    setEl('modal-title',title); setEl('modal-msg',msg);
    const btn=document.getElementById('modal-ok');
    btn.textContent=okLabel; btn.className='btn'+(danger?' del':'');
    const ov=document.getElementById('modal-ov');
    ov.style.display='flex';
    const box=document.getElementById('modal-box');
    box.style.transform='translateY(100%)';
    requestAnimationFrame(()=>requestAnimationFrame(()=>{ box.style.transform='translateY(0)'; }));
  });
}
function modalResolve(v){
  const ov=document.getElementById('modal-ov'), box=document.getElementById('modal-box');
  box.style.transform='translateY(100%)';
  setTimeout(()=>{ ov.style.display='none'; },250);
  if(_mRes){ _mRes(v); _mRes=null; }
  if(v&&navigator.vibrate) navigator.vibrate(8);
}

/* ═══════════════════════════════════════════════
   STORAGE
═══════════════════════════════════════════════ */
const lsave = () => { try{ localStorage.setItem(LS_KEY,JSON.stringify(ST)); }catch(e){} };
const lload = () => { try{ const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):null; }catch(e){ return null; } };
function saveToken(t){ localStorage.setItem('cf_tok',t); localStorage.setItem('cf_tok_ts',Date.now()); }
function loadToken(){ const t=localStorage.getItem('cf_tok'),ts=+localStorage.getItem('cf_tok_ts')||0; return (Date.now()-ts<TOKEN_TTL)?t:null; }
function clearToken(){ localStorage.removeItem('cf_tok'); localStorage.removeItem('cf_tok_ts'); }

/* ═══════════════════════════════════════════════
   GOOGLE DRIVE
═══════════════════════════════════════════════ */
async function driveReq(url,opts={}){
  opts.headers=opts.headers||{}; opts.headers['Authorization']='Bearer '+gToken;
  const res=await fetch(url,opts);
  if(res.status===401){ clearToken(); showReconect(); throw new Error('401'); }
  return res;
}
async function findFile(){
  const r=await driveReq('https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=files(id)&q=name%3D%22cf_aus26.json%22');
  const d=await r.json(); return d.files&&d.files.length?d.files[0].id:null;
}
async function readFile(id){
  const r=await driveReq('https://www.googleapis.com/drive/v3/files/'+id+'?alt=media'); return r.json();
}
async function createDriveFile(data){
  const meta=JSON.stringify({name:'cf_aus26.json',parents:['appDataFolder']});
  const form=new FormData();
  form.append('metadata',new Blob([meta],{type:'application/json'}));
  form.append('media',new Blob([JSON.stringify(data)],{type:'application/json'}));
  const r=await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',body:form});
  return (await r.json()).id;
}
async function updateDriveFile(id,data){
  await driveReq('https://www.googleapis.com/upload/drive/v3/files/'+id+'?uploadType=media',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
}
async function saveDrive(){
  if(!useGoogle||!gToken) return;
  try{
    lsave();
    if(!driveFileId) driveFileId=await findFile();
    if(driveFileId) await updateDriveFile(driveFileId,ST);
    else driveFileId=await createDriveFile(ST);
    setEl('sync-st','✓ Drive'); setEl('sync-st2','✓ Drive');
  }catch(e){ setEl('sync-st','⚠ error'); }
}
async function syncNow(){ toast('Sincronizando…'); await saveDrive(); toast('✓ Guardado en Drive'); }

/* ═══════════════════════════════════════════════
   SAVE SCHEDULER
═══════════════════════════════════════════════ */
function sched(){
  lsave();
  if(saveT) clearTimeout(saveT);
  saveT=setTimeout(saveDrive,4000);
}

/* ═══════════════════════════════════════════════
   EXCHANGE RATE
   APIs return AUD per USD (e.g. 1.58)
═══════════════════════════════════════════════ */
async function fetchTC(){
  const apis=[
    ()=>fetch('https://api.exchangerate-api.com/v4/latest/USD').then(r=>r.json()).then(d=>d.rates.AUD),
    ()=>fetch('https://open.er-api.com/v6/latest/USD').then(r=>r.json()).then(d=>d.rates.AUD),
    ()=>fetch('https://api.fxratesapi.com/latest?base=USD&currencies=AUD').then(r=>r.json()).then(d=>d.rates.AUD),
  ];
  for(const api of apis){
    try{
      const v=await api();
      if(v>0.5){ // sanity: AUD/USD should be > 0.5
        ST.tc=+v.toFixed(4);
        ST.tcTime=new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
        sched(); return;
      }
    }catch(e){}
  }
}
function renderTC(){
  const tc=ST.tc||1.58;
  // tc = AUD per USD, so 1 USD = tc AUD, 1 AUD = 1/tc USD
  setEl('tc-usdaud','1 USD = '+tc.toFixed(4)+' AUD');
  setEl('tc-stamp', ST.tcTime?'✓ '+ST.tcTime:'manual');
}
function updateTC(){ fetchTC().then(()=>{ renderTC(); updateAll(); }).catch(()=>{}); }
function manualTC(){
  const cur=ST.tc||1.58;
  const v=prompt('TC: cuántos AUD vale 1 USD (ej: 1.5800)', cur.toFixed(4));
  if(!v) return;
  const n=parseFloat(v);
  if(n>0.5&&n<5){ ST.tc=+n.toFixed(4); ST.tcTime='manual'; sched(); renderTC(); updateAll(); }
  else toast('TC inválido — debe ser ~1.5 a 1.65');
}

/* ═══════════════════════════════════════════════
   RENDER — FOOTER
═══════════════════════════════════════════════ */
function updFoot(){
  const d=calcD(), aho=tAho();
  const fe=document.getElementById('f-aho');
  if(fe){ fe.textContent=fA2(aho); fe.className='foot-val '+(aho>=0?'g':'r2'); }
  setEl('f-caja',fA2(d.caja));
  setEl('f-deu', fA2(d.pend));
}

/* ═══════════════════════════════════════════════
   RENDER — DASHBOARD
═══════════════════════════════════════════════ */
function updDash(){
  const d=calcD(), gan=tGan(), gas=tGas(), aho=tAho();
  setEl('d-gan', fA2(gan));   setEl('d-ganu', fU2(a2u(gan)));
  setEl('d-gas', fA2(gas));   setEl('d-gasu', fU2(a2u(gas)));
  const ae=document.getElementById('d-aho');
  if(ae){ ae.textContent=fA2(aho); ae.className='statnum '+(aho>=0?'g':'r2'); }
  setEl('d-ahou', fU2(a2u(aho)));
  setEl('d-inv',  fA2(tIA())); setEl('d-invu', fU2(tIU()));
  setEl('d-caja', fA2(d.caja)); setEl('d-cajau', fU2(a2u(d.caja)));
  setEl('d-deu',  fA2(d.pend)); setEl('d-deuu',  fU2(a2u(d.pend)));
  let act=0; for(let i=0;i<12;i++) if(mGas(i)||mIng(i)) act++;
  setEl('d-mact', act?act+(act===1?' mes':' meses'):'—');
  let lm=-1; for(let i=11;i>=0;i--){ if(mGas(i)||mIng(i)){lm=i;break;} }
  if(lm>=0){
    setEl('d-lm', MN[lm]+' · '+fA2(mAho(lm)));
    setEl('d-prom', act>0?fA2(aho/act):'—');
  }
  // total hours / effective rate
  const thrs=MN.reduce((s,_,i)=>s+mHrs(i),0);
  setEl('d-tarifa', thrs>0&&gan>0 ? (gan/thrs).toFixed(2)+' AUD/h · '+thrs+'h total' : '—');
  setEl('d-period', act>0?'Activo '+act+' de 12 meses':'Sin actividad');
  const nt=document.getElementById('nota-gral');
  if(nt&&document.activeElement!==nt) nt.value=ST.nota||'';
}

/* ═══════════════════════════════════════════════
   RENDER — DEUDA
   USD column logic:
   - Inversión: original USD (tIU) — not converted
   - Apoyo: entered as AUD, show USD equiv via a2u
   - Bruta: invUSD + a2u(apoyo)
   - Pagos: entered as AUD, show a2u
   - Pendiente: a2u(pend)
═══════════════════════════════════════════════ */
function updDeuda(){
  const d=calcD();
  const invU = tIU();                      // original USD, no conversion needed
  const apoyoU = a2u(d.apoyo);            // AUD → USD
  const brutaU = invU + apoyoU;            // USD total
  const pagU   = a2u(d.pag);
  const pendU  = a2u(d.pend);

  setEl('deu-inva', fA2(d.invA));  setEl('deu-invu', fU2(invU));
  setEl('deu-apa',  fA2(d.apoyo)); setEl('deu-apu',  fU2(apoyoU));
  setEl('deu-ba',   fA2(d.bruta)); setEl('deu-bu',   fU2(brutaU));
  setEl('deu-paga', fA2(d.pag));   setEl('deu-pagu', fU2(pagU));
  setEl('deu-penda',fA2(d.pend));  setEl('deu-pendu',fU2(pendU));
  setEl('deu-chip', fA2(d.pend));
  setEl('deu-caja', fA2(d.caja));  setEl('deu-cajau',fU2(a2u(d.caja)));

  const pct=d.bruta>0?Math.min(100,d.pag/d.bruta*100):0;
  const bar=document.getElementById('deu-prog');
  if(bar) bar.style.width=pct.toFixed(1)+'%';
  setEl('deu-pct', pct.toFixed(1)+'%');
  setEl('deu-rem', d.pend>0?fA2(d.pend)+' restante':'¡Saldada!');

  const ai=document.getElementById('apoyo-inp');
  if(ai&&document.activeElement!==ai) ai.value=ST.apoyo||'';

  // payments list
  const pl=document.getElementById('pago-list');
  if(pl){
    if(!ST.pagos.length){ pl.innerHTML='<div class="empty">Sin pagos registrados</div>'; }
    else{
      pl.innerHTML='<table class="ntable"><tbody>'
        +[...ST.pagos].reverse().map((p,ri)=>{
          const i=ST.pagos.length-1-ri;
          return '<tr class="payrow" style="display:table-row">'
            +'<td class="lbl it" style="width:80px">'+fDl(p.fecha)+'</td>'
            +'<td class="lbl">'+esc(p.desc||'Pago')+'</td>'
            +'<td class="num g">+'+fA2(p.monto)+'</td>'
            +'<td class="num d">'+fU2(a2u(p.monto))+'</td>'
            +'<td style="width:40px;text-align:center"><button class="log-x" onclick="delPag('+i+')">×</button></td>'
            +'</tr>';
        }).join('')
        +'</tbody></table>';
    }
  }
}

/* ═══════════════════════════════════════════════
   RENDER — INVERSIÓN
═══════════════════════════════════════════════ */
function updInv(){
  const tbody=document.getElementById('inv-tbody');
  if(!tbody) return;
  tbody.innerHTML=(ST.invItems||[]).map((it,i)=>
    '<tr><td style="padding:6px 16px">'
    +'<input class="inp-line" value="'+esc(it.c||'')+'" placeholder="Concepto" oninput="ST.invItems['+i+'].c=this.value;sched()">'
    +'</td>'
    +'<td style="padding:6px 10px;width:110px">'
    +'<input class="inp-num" type="number" step=".01" inputmode="decimal" value="'+(it.u||'')+'" placeholder="0" oninput="ST.invItems['+i+'].u=+this.value||0;sched();updInvTotals()">'
    +'</td>'
    +'<td style="padding:6px 10px;width:110px">'
    +'<input class="inp-num" type="number" step=".01" inputmode="decimal" value="'+(it.a||'')+'" placeholder="auto" oninput="ST.invItems['+i+'].a=+this.value||0;sched();updInvTotals()">'
    +'</td></tr>'
  ).join('');
  updInvTotals();
}
function updInvTotals(){
  const tu=tIU(), ta=tIA();
  setEl('inv-tu', fU2(tu));
  setEl('inv-ta', fA2(ta));
  setEl('inv-sub', 'USD '+tu.toFixed(0)+' original · AUD '+ta.toFixed(0)+' equiv.');
}
function addInv(){ ST.invItems.push({c:'',u:0,a:0}); sched(); updInv(); }

/* ═══════════════════════════════════════════════
   RENDER — METAS
═══════════════════════════════════════════════ */
function updMetas(){
  const d=calcD(), caja=d.caja;
  setEl('meta-caja', fA2(caja));
  const total=(ST.metas||[]).reduce((s,m)=>s+(+m.monto||0),0);
  const libre=caja-total;
  const le=document.getElementById('meta-libre');
  if(le){ le.textContent=fA2(libre); le.className='band-val '+(libre>=0?'b':'r2'); }
  const list=document.getElementById('metas-list');
  if(!list) return;
  if(!ST.metas.length){ list.innerHTML='<div class="empty" style="margin:0 20px">Sin metas definidas</div>'; return; }
  list.innerHTML=[...ST.metas].sort((a,b)=>(+a.prio||5)-(+b.prio||5)).map(m=>{
    const i=ST.metas.indexOf(m);
    const pct=caja>0?Math.min(100,m.monto/caja*100):0;
    return '<div class="metarow">'
      +'<div class="meta-name"><span>'+esc(m.nombre)+'</span>'
      +'<div style="display:flex;gap:8px;align-items:center">'
      +'<span class="chip">P'+m.prio+'</span>'
      +'<span class="chip '+(caja>=m.monto?'g':'a')+'">'+fA2(m.monto)+'</span>'
      +'<button class="btn sm del" onclick="delMeta('+i+')">×</button>'
      +'</div></div>'
      +'<div class="prog"><div class="prog-fill" style="width:'+pct.toFixed(1)+'%;background:'+(caja>=m.monto?'var(--green)':'var(--amber)')+'"></div></div>'
      +'<div style="font-family:var(--mono);font-size:10px;color:var(--ink4)">'+pct.toFixed(0)+'% completado · faltan '+fA2(Math.max(0,m.monto-caja))+'</div>'
      +'</div>';
  }).join('');
}
function addMeta(){
  const n=document.getElementById('meta-n').value.trim();
  const m=+document.getElementById('meta-m').value||0;
  const p=+document.getElementById('meta-p').value||5;
  if(!n||!m){ toast('Completá nombre y monto'); return; }
  ST.metas.push({nombre:n,monto:m,prio:p});
  document.getElementById('meta-n').value='';
  document.getElementById('meta-m').value='';
  document.getElementById('meta-p').value='';
  sched(); updMetas();
  if(navigator.vibrate) navigator.vibrate(8);
}
async function delMeta(i){
  if(!await showModal('Eliminar meta','¿Eliminar "'+esc(ST.metas[i].nombre)+'"?','Eliminar')) return;
  ST.metas.splice(i,1); sched(); updMetas();
}

/* ═══════════════════════════════════════════════
   RENDER — ANUAL
═══════════════════════════════════════════════ */
function updAnual(){
  const meses=document.getElementById('anual-meses');
  const cats=document.getElementById('anual-cats');
  if(!meses||!cats) return;
  let rows='';
  for(let i=0;i<12;i++){
    const ing=mIng(i),gas=mGas(i),aho=mAho(i);
    if(!ing&&!gas) continue;
    rows+='<tr><td class="lbl">'+MN[i]+'</td>'
      +'<td class="num g">'+fA2(ing)+'</td>'
      +'<td class="num r2">'+fA2(gas)+'</td>'
      +'<td class="num '+(aho>=0?'g':'r2')+'">'+fA2(aho)+'</td></tr>';
  }
  const tg=tGan(),ts=tGas(),ta=tAho();
  rows+='<tr class="sub"><td>TOTAL</td><td class="num g">'+fA2(tg)+'</td><td class="num r2">'+fA2(ts)+'</td><td class="num '+(ta>=0?'g':'r2')+'">'+fA2(ta)+'</td></tr>';
  meses.innerHTML='<table class="ntable"><thead><tr><th>Mes</th><th class="r">Ingresos</th><th class="r">Gastos</th><th class="r">Ahorro</th></tr></thead><tbody>'+rows+'</tbody></table>';

  const ct=GK.map((k,ki)=>({k,lbl:GL[ki],val:MN.reduce((s,_,i)=>s+gVal(ST.months[i].gastos[k]),0)}))
    .filter(x=>x.val>0).sort((a,b)=>b.val-a.val);
  const maxV=ct[0]?.val||1, totG=tGas();
  cats.innerHTML=ct.length?'<table class="ntable"><thead><tr><th>Categoría</th><th class="r">AUD</th><th class="r">%</th></tr></thead><tbody>'
    +ct.map(c=>'<tr><td class="lbl">'+c.lbl+'<div class="prog" style="margin-top:4px"><div class="prog-fill" style="width:'+((c.val/maxV)*100).toFixed(0)+'%;background:var(--red)"></div></div></td>'
      +'<td class="num r2">'+fA2(c.val)+'</td><td class="num d">'+(totG>0?(c.val/totG*100).toFixed(1):0)+'%</td></tr>').join('')
    +'</tbody></table>'
    :'<div class="empty">Sin datos de gastos</div>';
}

/* ═══════════════════════════════════════════════
   PAYMENTS
═══════════════════════════════════════════════ */
async function regPago(){
  const f=document.getElementById('pago-f').value;
  const m=+document.getElementById('pago-m').value||0;
  const dc=document.getElementById('pago-d').value.trim();
  if(!f||!m){ toast('Completá fecha y monto'); return; }
  const caja=calcD().caja;
  if(m>caja){
    if(!await showModal('Pago mayor a caja','El pago ('+fA2(m)+') supera tu caja ('+fA2(caja)+'). ¿Continuar?','Continuar')) return;
  }
  ST.pagos.push({fecha:f,monto:m,desc:dc||'Pago a padres'});
  document.getElementById('pago-m').value='';
  document.getElementById('pago-d').value='';
  sched(); updDeuda(); updDash(); updFoot();
  toast('Pago registrado ✓');
  if(navigator.vibrate) navigator.vibrate([8,40,8]);
}
async function delPag(i){
  const p=ST.pagos[i];
  if(!await showModal('Eliminar pago',fDl(p.fecha)+' · '+fA2(p.monto),'Eliminar')) return;
  ST.pagos.splice(i,1); sched(); updDeuda(); updDash(); updFoot();
}
function calcCuota(){
  const meses=+document.getElementById('cuota-m').value||0;
  const d=calcD(); const el=document.getElementById('cuota-res');
  if(!el) return;
  if(d.pend<=0){ el.textContent='¡Deuda saldada!'; el.style.color='var(--green)'; return; }
  if(!meses){ el.textContent=''; return; }
  const c=d.pend/meses;
  el.textContent=fA2(c)+' / mes  ≈  '+fU2(a2u(c))+' / mes';
  el.style.color='var(--ink3)';
}

/* ═══════════════════════════════════════════════
   LOG HELPERS
═══════════════════════════════════════════════ */
function renderLog(entries,mi,field,key,max=5){
  if(!Array.isArray(entries)||!entries.length) return '';
  const sorted=[...entries].reverse();
  const vis=sorted.slice(0,max), hidden=sorted.length-max;
  const lid='log-'+field+'-'+mi+'-'+key;
  const rows=vis.map((e,ei)=>{
    const ri=entries.length-1-ei;
    return '<div class="logrow">'
      +'<span class="log-d">'+fDs(e.d)+'</span>'
      +'<span class="log-n">'+esc(e.n||'')+'</span>'
      +'<span class="log-m">'+fA2(+e.m)+'</span>'
      +'<button class="log-x" onclick="delEntry('+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;,'+ri+')">×</button>'
      +'</div>';
  }).join('');
  const more=hidden>0?'<div class="log-more" onclick="expandLog(&quot;'+lid+'&quot;,'+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;)">▸ '+hidden+' más</div>':'';
  return '<div class="logwrap" id="'+lid+'">'+rows+more+'</div>';
}
function expandLog(id,mi,field,key){
  const wrap=document.getElementById(id); if(!wrap) return;
  const entries=ST.months[mi][field][key]; if(!Array.isArray(entries)) return;
  wrap.innerHTML=[...entries].reverse().map((e,ei)=>{
    const ri=entries.length-1-ei;
    return '<div class="logrow">'
      +'<span class="log-d">'+fDs(e.d)+'</span>'
      +'<span class="log-n">'+esc(e.n||'')+'</span>'
      +'<span class="log-m">'+fA2(+e.m)+'</span>'
      +'<button class="log-x" onclick="delEntry('+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;,'+ri+')">×</button>'
      +'</div>';
  }).join('')+'<div class="log-more" onclick="expandLog(&quot;'+id+'&quot;,'+mi+',&quot;'+field+'&quot;,&quot;'+key+'&quot;)">▴ ver menos</div>';
}
function delEntry(mi,field,key,idx){
  const arr=ST.months[mi][field][key];
  if(!arr||idx<0||idx>=arr.length) return;
  arr.splice(idx,1);
  sched(); renderMes(); updMesInline(mi);
}
function openAdd(uid){
  const row=document.getElementById('add-'+uid); if(!row) return;
  const isOpen=row.classList.contains('open');
  document.querySelectorAll('.addrow.open').forEach(r=>r.classList.remove('open'));
  if(!isOpen){ row.classList.add('open'); const inp=row.querySelector('.add-amt'); if(inp) setTimeout(()=>inp.focus(),50); }
}
function submitAdd(mi,field,key,dateId,amtId,noteId){
  const amt=+(document.getElementById(amtId).value)||0;
  const note=document.getElementById(noteId).value.trim();
  const dEl=document.getElementById(dateId);
  const d=dEl&&dEl.value?dEl.value:today();
  if(amt<=0){ toast('El monto debe ser mayor a 0'); return; }
  if(!Array.isArray(ST.months[mi][field][key])) ST.months[mi][field][key]=[];
  ST.months[mi][field][key].push({d,m:amt,n:note});
  document.getElementById(amtId).value='';
  document.getElementById(noteId).value='';
  sched(); renderMes(); updMesInline(mi);
  if(navigator.vibrate) navigator.vibrate(8);
}

/* ═══════════════════════════════════════════════
   MONTHS
═══════════════════════════════════════════════ */
function renderCatSection(mi,field,labels,keys,mfield){
  const isGas=field==='gastos';
  return keys.map((k,ki)=>{
    const entries=Array.isArray(mfield[k])?mfield[k]:[];
    const total=gVal(mfield[k]);
    const uid=mi+'-'+field+'-'+k;
    const addId='add-'+uid, amtId='aa-'+uid, noteId='an-'+uid, dateId='ad-'+uid;
    const totId=(isGas?'gt':'it')+'-'+mi+'-'+ki;
    const logHtml=renderLog(entries,mi,field,k);
    return '<div class="catrow">'
      +'<span class="cat-lbl">'+labels[ki]+'</span>'
      +'<span class="cat-amt '+(total>0?(isGas?'r2':'g'):'')+'" id="'+totId+'">'+(total>0?fA2(total):'—')+'</span>'
      +'<button class="cat-btn" onclick="openAdd(&quot;'+uid+'&quot;)">+ agregar</button>'
      +'</div>'+logHtml
      +'<div class="addrow" id="'+addId+'">'
      +'<input id="'+dateId+'" class="add-date" type="date" value="'+today()+'">'
      +'<input id="'+amtId+'" class="add-amt" type="number" step=".01" inputmode="decimal" placeholder="AUD 0.00" onkeydown="if(event.key===\'Enter\')submitAdd('+mi+',&quot;'+field+'&quot;,&quot;'+k+'&quot;,&quot;'+dateId+'&quot;,&quot;'+amtId+'&quot;,&quot;'+noteId+'&quot;)">'
      +'<input id="'+noteId+'" class="add-note" type="text" placeholder="nota (opcional)" onkeydown="if(event.key===\'Enter\')submitAdd('+mi+',&quot;'+field+'&quot;,&quot;'+k+'&quot;,&quot;'+dateId+'&quot;,&quot;'+amtId+'&quot;,&quot;'+noteId+'&quot;)">'
      +'<button class="add-ok" onclick="submitAdd('+mi+',&quot;'+field+'&quot;,&quot;'+k+'&quot;,&quot;'+dateId+'&quot;,&quot;'+amtId+'&quot;,&quot;'+noteId+'&quot;)">✓</button>'
      +'<button class="add-cancel" onclick="openAdd(&quot;'+uid+'&quot;)">×</button>'
      +'</div>';
  }).join('');
}

function renderMes(){
  const i=cM, m=ST.months[i];
  const sal=mSal(i), ing=mIng(i), gas=mGas(i), aho=mAho(i), hrs=mHrs(i);
  const tarifa=hrs>0&&ing>0?(ing/hrs).toFixed(2):'—';
  const sinI=ing===0&&gas>0, bon=aho>0&&ing>0;
  const gasRows=renderCatSection(i,'gastos',GL,GK,m.gastos);
  const ingRows=renderCatSection(i,'ingresos',IL,IK,m.ingresos);
  const wg=[0,1,2,3,4].map(s=>
    '<div class="wcell"><div class="wlbl">Sem '+(s+1)+'</div>'
    +'<input class="winp" type="number" step=".01" inputmode="decimal" value="'+(m.semanas[s]||'')+'" placeholder="0"'
    +' oninput="ST.months['+i+'].semanas['+s+']=+this.value||0;sched();updMesInline('+i+');"></div>'
  ).join('');
  const hg=[0,1,2,3,4].map(s=>
    '<div class="wcell"><div class="wlbl">Sem '+(s+1)+'</div>'
    +'<input class="winp" type="number" inputmode="numeric" value="'+(m.horas[s]||'')+'" placeholder="0"'
    +' oninput="ST.months['+i+'].horas['+s+']=+this.value||0;sched();updMesInline('+i+');"></div>'
  ).join('');
  const cnt=document.getElementById('mes-cnt');
  if(!cnt) return;
  cnt.innerHTML=
    // Status band
    (sinI?'<div class="band r" style="margin:16px 20px 0"><div class="band-lbl">Sin ingresos</div><div style="font-family:var(--mono);font-size:11px;color:var(--red)">'+fA2(gas)+' gastados suman a la deuda bruta</div></div>'
     :bon?'<div class="band g" style="margin:16px 20px 0"><div class="band-lbl">Mes positivo</div><div style="font-family:var(--mono);font-size:11px;color:var(--green)">'+fA2(aho)+' ahorrados este mes</div></div>':'')
    // Summary table
    +'<div class="sh"><h2>'+MN[i]+'</h2><span class="sh-meta" id="m-shm-'+i+'">'+fA2(aho)+'</span></div>'
    +'<div class="ntable-wrap"><table class="ntable"><tbody>'
    +'<tr class="sub"><td>Balance del mes</td><td class="num '+(aho>=0?'g':'r2')+'" id="m-aho-'+i+'">'+fA2(aho)+'</td><td class="num d">'+fU2(a2u(aho))+'</td></tr>'
    +'<tr><td class="lbl it">Ingresos totales</td><td class="num g" id="m-ing-'+i+'">'+fA2(ing)+'</td><td class="num d">'+fU2(a2u(ing))+'</td></tr>'
    +'<tr><td class="lbl it">Gastos totales</td><td class="num r2" id="m-gas-'+i+'">'+fA2(gas)+'</td><td class="num d">'+fU2(a2u(gas))+'</td></tr>'
    +'<tr><td class="lbl it">Horas / Tarifa</td><td class="num d" colspan="2" id="m-tar-'+i+'">'+(hrs>0?hrs+'h · AUD '+tarifa+'/h':'Sin horas')+'</td></tr>'
    +'</tbody></table></div>'
    // Salary weeks
    +'<div class="sh"><h2>Salario semanal</h2><span class="sh-meta" id="m-sal-'+i+'">'+fA2(sal)+'</span></div>'
    +'<div class="wgrid" id="wg-'+i+'">'+wg+'</div>'
    +'<div class="wfoot"><span>Total mensual</span><span id="m-salf-'+i+'" style="color:var(--green);font-weight:600">'+fA2(sal)+'</span></div>'
    // Hours
    +'<div class="sh"><h2>Horas trabajadas</h2><span class="sh-meta" id="m-hrs-'+i+'">'+(hrs>0?hrs+'h total':'')+'</span></div>'
    +'<div class="wgrid" id="hg-'+i+'">'+hg+'</div>'
    +'<div class="wfoot"><span>Total horas</span><span id="m-hrsf-'+i+'" style="color:var(--blue);font-weight:600">'+(hrs>0?hrs+'h · AUD '+tarifa+'/h':'Sin horas cargadas')+'</span></div>'
    // Other income
    +'<div class="sh"><h2>Otros ingresos</h2></div>'
    +'<div class="cat-section">'+ingRows+'</div>'
    // Expenses
    +'<div class="sh"><h2>Gastos</h2><span class="sh-meta" id="m-gassh-'+i+'">'+fA2(gas)+'</span></div>'
    +'<div class="cat-section">'+gasRows
    +'<div class="cat-foot"><span>Total gastos</span><span class="r2" id="m-gasf-'+i+'">'+fA2(gas)+'</span></div>'
    +'</div>';
}

function updMesInline(i){
  const m=ST.months[i], sal=mSal(i), ing=mIng(i), gas=mGas(i), aho=mAho(i), hrs=mHrs(i);
  const tarifa=hrs>0&&ing>0?(ing/hrs).toFixed(2):'—';
  GK.forEach((k,ki)=>{
    const t=gVal(m.gastos[k]), el=document.getElementById('gt-'+i+'-'+ki);
    if(el){ el.textContent=t>0?fA2(t):'—'; el.className='cat-amt '+(t>0?'r2':''); }
  });
  IK.forEach((k,ki)=>{
    const t=gVal(m.ingresos[k]), el=document.getElementById('it-'+i+'-'+ki);
    if(el){ el.textContent=t>0?fA2(t):'—'; el.className='cat-amt '+(t>0?'g':''); }
  });
  setEl('m-gasf-'+i, fA2(gas)); setEl('m-gassh-'+i, fA2(gas));
  const ae=document.getElementById('m-aho-'+i);
  if(ae){ ae.textContent=fA2(aho); ae.className='num '+(aho>=0?'g':'r2'); }
  setEl('m-ing-'+i, fA2(ing)); setEl('m-gas-'+i, fA2(gas));
  setEl('m-tar-'+i, hrs>0?hrs+'h · AUD '+tarifa+'/h':'Sin horas');
  setEl('m-sal-'+i, fA2(sal)); setEl('m-salf-'+i, fA2(sal));
  setEl('m-hrs-'+i, hrs>0?hrs+'h total':'');
  setEl('m-hrsf-'+i, hrs>0?hrs+'h · AUD '+tarifa+'/h':'Sin horas cargadas');
  setEl('m-shm-'+i, fA2(aho));
  renderStrip(); updDeuda(); updFoot(); updDash();
}

function renderStrip(){
  const c=document.getElementById('mstrip-cnt'); if(!c) return;
  c.innerHTML='';
  MN.forEach((mn,i)=>{
    const hd=mIng(i)||mGas(i);
    const el=document.createElement('div');
    el.className='mtab'+(i===cM?' on':'')+(hd?' has':'');
    el.textContent=MS[i];
    el.onclick=()=>{ cM=i; renderStrip(); renderMes(); };
    c.appendChild(el);
  });
  const ac=c.querySelector('.mtab.on');
  if(ac) ac.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
}

/* ═══════════════════════════════════════════════
   UPDATE ALL
═══════════════════════════════════════════════ */
function updateAll(){ renderTC(); updFoot(); updDash(); updDeuda(); updInv(); updMetas(); updAnual(); }

/* ═══════════════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════════════ */
function go(name,el){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  const pg=document.getElementById('pg-'+name);
  if(pg){ pg.classList.remove('on'); void pg.offsetWidth; pg.classList.add('on'); }
  if(el) el.classList.add('on');
  if(name==='meses'){ renderStrip(); renderMes(); }
  updateAll();
  window.scrollTo(0,0);
  if(navigator.vibrate) navigator.vibrate(8);
}

/* ═══════════════════════════════════════════════
   AUTH
═══════════════════════════════════════════════ */
function showLoading(){ ['loading','auth','reconect'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display=id==='loading'?'flex':'none'}); }
function showAuth(){ ['loading','reconect'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none'}); const e=document.getElementById('auth'); if(e) e.style.display='flex'; }
function showReconect(){ ['loading','auth'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none'}); const e=document.getElementById('reconect'); if(e) e.style.display='flex'; }

function setLP(pct,msg){
  const b=document.getElementById('ld-fill'); if(b) b.style.width=pct+'%';
  if(msg) setEl('ld-msg',msg);
}

async function bootDrive(){
  setLP(20,'Conectando Drive…');
  try{
    setLP(50,'Buscando datos…');
    driveFileId=await findFile();
    if(driveFileId){
      setLP(75,'Cargando…');
      ST=ensureState(await readFile(driveFileId));
      setEl('sync-st','✓ Drive'); setEl('sync-st2','✓ Drive');
      toast('Datos cargados desde Drive ✓',2000);
    } else {
      ST=ensureState(lload()||initST());
      setEl('sync-st','nuevo'); setEl('sync-st2','nuevo');
    }
  }catch(e){ ST=ensureState(lload()||initST()); setEl('sync-st','⚠ local'); }
  setLP(100,'Listo');
  finishBoot();
}

function bootLocal(){
  setLP(70,'Cargando local…');
  ST=ensureState(lload()||initST());
  setEl('sync-st','local'); setEl('sync-st2','local');
  setLP(100,'Listo');
  finishBoot();
}

function finishBoot(){
  if(_booted) return; _booted=true;
  const ld=document.getElementById('loading');
  if(ld) ld.classList.add('hide');
  document.getElementById('pago-f').value=today();
  renderTC(); updateAll();
  fetchTC().then(()=>{ renderTC(); updateAll(); });
  setInterval(updateTC, 30*60*1000);
  if(useGoogle){
    setInterval(async()=>{ try{ await refreshToken(); }catch(e){} }, 50*60*1000);
    setInterval(saveDrive, 3*60*1000);
  }
}

function skipAuth(){ useGoogle=false; localStorage.removeItem('cf_ug'); bootLocal(); }

function startGoogle(){
  if(typeof google==='undefined'||!google.accounts){ document.getElementById('auth-err').textContent='Cargando Google, reintentá…'; setTimeout(startGoogle,1500); return; }
  doSignIn('auth');
}
function reconectGoogle(){
  const btn=document.getElementById('reconect-btn'); btn.textContent='Conectando…'; btn.disabled=true;
  document.getElementById('reconect-err').textContent='';
  doSignIn('reconect');
}
async function refreshToken(){
  return new Promise((res,rej)=>{
    try{ google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:DRIVE_SCOPE,prompt:'',callback:r=>{ if(r.error||!r.access_token){rej(r.error);return;} gToken=r.access_token;saveToken(gToken);res(); }}).requestAccessToken({prompt:''}); }catch(e){ rej(e); }
  });
}
function doSignIn(errTarget){
  const client=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID, scope:DRIVE_SCOPE, prompt:'select_account',
    callback:async r=>{
      if(r.error||!r.access_token){
        if(errTarget==='reconect'){ const b=document.getElementById('reconect-btn'); b.textContent='Reconectar Google Drive'; b.disabled=false; document.getElementById('reconect-err').textContent='Error: '+r.error; }
        else document.getElementById('auth-err').textContent='Error: '+r.error;
        return;
      }
      gToken=r.access_token; useGoogle=true; saveToken(gToken); localStorage.setItem('cf_ug','1');
      showLoading(); await bootDrive();
    }
  });
  client.requestAccessToken({});
}

/* ═══════════════════════════════════════════════
   BOOT
═══════════════════════════════════════════════ */
window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('modal-ov').addEventListener('click',e=>{ if(e.target.id==='modal-ov') modalResolve(false); });
  const wasGoogle=localStorage.getItem('cf_ug')==='1';
  if(!wasGoogle){ showAuth(); return; }
  const cached=loadToken();
  if(cached){ gToken=cached; useGoogle=true; bootDrive(); return; }
  let resolved=false;
  const done=fn=>{ if(resolved) return; resolved=true; fn(); };
  const hardTimeout=setTimeout(()=>done(showReconect),8000);
  const trySilent=()=>{
    if(typeof google==='undefined'||!google.accounts){ setTimeout(trySilent,500); return; }
    try{
      google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:DRIVE_SCOPE,prompt:'',callback:async r=>{
        clearTimeout(hardTimeout);
        if(r.error||!r.access_token){ done(showReconect); return; }
        gToken=r.access_token; useGoogle=true; saveToken(gToken);
        done(()=>{});
        await bootDrive();
      }}).requestAccessToken({prompt:''});
    }catch(e){ clearTimeout(hardTimeout); done(showReconect); }
  };
  trySilent();
});
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
